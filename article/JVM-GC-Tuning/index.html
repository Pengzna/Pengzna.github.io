<!DOCTYPE html>
<html lang="en">

  <head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="Pengzna,blog" />
  <meta name="author" content="Pengzna" />
  <meta name="description" content="Pengzna 的博客" />
  
  
  <title>
    
      JVM GC 调优方法论与系统总结 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto:400,400italic,600|Roboto+Mono" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


<meta name="generator" content="Hexo 7.0.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>


  <body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="app">
      <div class="header">
  <a href="/">Pengzna's blog 👋</a>
</div>


      <p class="links">
  
    <a title="archives" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="github" target="_blank" href="https://github.com/Pengzna">
      <i class="iconfont icon-github"></i>
    </a>
  
    <a title="email" target="_blank" href="mailto:junzhi.pengzna@gmail.com">
      <i class="iconfont icon-envelope"></i>
    </a>
  
    <a title="linkedin" target="_blank" href="https://www.linkedin.com/in/pengzna/">
      <i class="iconfont icon-linkedin"></i>
    </a>
  
    <a title="wechat" target="_blank" href="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20231115013033249.png">
      <i class="iconfont icon-wechat"></i>
    </a>
  
</p>


      <div class="main">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>

<div class="post">
  <h3 class="date">
    Feb 02, 2024
  </h3>
  <h1>
    JVM GC 调优方法论与系统总结
  </h1>
  <div class="content markdown-body">
    <p>此文是笔者对于 GC 系列调研的收尾。本次工作全面总结了 PS、G1 等常见 GC 的工作原理、可调参数，解析了 GC 日志读法、可观测手段，还从延迟、吞吐两个角度分别总结了调优方法论。内容覆盖从 GC 基本知识、观测手段、日志解析到调优方法，完成了 GC 诊断、定位、调优的全链路调研解析。</p>
<p>文章大量参考互联网资料，感谢！</p>
<h1 id="基本原理与介绍"><a href="#基本原理与介绍" class="headerlink" title="基本原理与介绍"></a>基本原理与介绍</h1><p><strong>基础知识1：</strong>对于 GC，无论其具体实现和策略，都有标记-清除、复制、标记-整理等<strong>基本算法，</strong>只是不同的 GC 使用不同的基本算法。此处不再赘述，详细可以参考往期博客</p>
<p><strong>基础知识2：</strong>对于大部分 GC，都会对堆内存进行分代划分，可以参考往期博客。对于更详细的 java 内存划分概念，同样可以参考往期博客</p>
<p><strong>基础知识3：</strong>对于 GC，在 footprint（内存占用）、throughout（吞吐）、latency（延迟）三者不可能同时满足。<strong>最多三者满足其二</strong>。（类似 CAP 定理）</p>
<blockquote>
<p>吞吐量跟低延时是无法兼得的，低延时意味着GC工作会更加频繁，相对的，会占用应用的资源，吞吐量降低。需要大吞吐量，那么GC工作就会减少，相对的，每次回收的垃圾就会多，暂停时间就会增加，延时就会增加。</p>
</blockquote>
<p>我们经常遇到的情况是高吞吐的 GC 单次 stw 时间较长；而 stw 优秀的 GC 往往 GC 频率高、占用线程资源多，导致吞吐低。因此我们调优需要<strong>有的放矢，</strong>一般是针对吞吐和延迟分别调优，而不是同时追求吞吐和延迟。</p>
<h2 id="G1"><a href="#G1" class="headerlink" title="G1"></a>G1</h2><p>在 jdk 7 才推出，9 中正式作为默认 GC ，注重停顿时间。</p>
<p>本文主要从 <a target="_blank" rel="noopener" href="https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/index.html">oracle 官网文档</a>和<a target="_blank" rel="noopener" href="https://dl.acm.org/doi/pdf/10.1145/1029873.1029879"> G1 的论文</a>进行宏观上的调研。</p>
<h3 id="设计理念"><a href="#设计理念" class="headerlink" title="设计理念"></a>设计理念</h3><p><strong>【摘自官网】</strong></p>
<p>G1 垃圾收集器是一个服务端的垃圾收集器，它针对的是<strong>拥有较大内存</strong>的<strong>多处理器</strong>的机器。</p>
<ul>
<li>它既满足了暂停时间比较短的高性能，又满足吞吐量比较高的目标。</li>
</ul>
<p>G1 垃圾收集器是在 Oracle 的 JDK7 update 4 及以后的版本得到了完全的支持。G1 垃圾收集器是针对这样的应用来进行设计的：</p>
<ul>
<li>能够像 CMS 收集器一样跟应用线程并发的去执行。【CMS 本身就是一个并发的收集器，也就是GC线程与应用线程可以同时间执行】</li>
<li>可以压缩可用的空间，而不会让 GC 引起暂停时间过长。</li>
<li>需要更多的可预测的 GC 暂停的间隔。【也就是说 GC 暂停的时间会尽量往我们设置的暂时时间来靠】</li>
<li>不想牺牲大量吞吐性能。</li>
<li>不想需要大量 Java 的堆空间。</li>
</ul>
<p>Oracle 官方说明：如果应用程序具有以下一个或多个特征，则当前使用 CMS 或 PS 运行的应用程序将有利于切换到 G1：</p>
<ul>
<li>Full GC 持续时间太长或太频繁。</li>
<li>对象分配率或提升率波动很大。</li>
<li>不需要的长时间垃圾收集或压缩暂停（超过 0.5 到 1 秒）</li>
</ul>
<p><strong>【笔者经验总结】</strong></p>
<p>也就是说，G1 是一款相对通用，在 footprint（内存占用）、throughout（吞吐）、latency（延迟）三者达成一个较好平衡的回收器，<strong>相对更侧重</strong> <strong>latency（延迟，或者我们常说的暂停时间）的优化。相比于</strong> <strong>PS，G1 的 FGC 将显著减少。</strong></p>
<p>因此 G1 不经过调优，实测在 IoTDB 的某些场景下，吞吐等指标不如 PS 等侧重优化吞吐的 GC </p>
<blockquote>
<p>补充：CMS 被废弃的原因有部分原因是源于 G1 更可控、更易于维护、在大多数场景下有更好的表现。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://openjdk.org/jeps/291">https://openjdk.org/jeps/291</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.oracle.com/technical-resources/articles/java/g1gc.html">Oracle 官网</a>专门提到：G1 的吞吐量目标是 90% 应用 + 10% GC，而 PS 是 99% 应用 + 1% GC。因此 G1 的吞吐肯定是不如 PS 的，但是 G1 的 stw 表现比 PS 更优秀。</p>
</blockquote>
<h3 id="G1-内存模型"><a href="#G1-内存模型" class="headerlink" title="G1 内存模型"></a>G1 内存模型</h3><p>一般的 GC （像 serial、PS、CMS）采用分代内存模型，如下图：</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401161844376.png" alt="image-20240401161844376"></p>
<p>G1 <strong>在内存空间的划分上：</strong>堆被划分了一组相等大小堆区域（region），区域之间可能是<strong>离散</strong>的，但每一个区域都是<strong>连续</strong>虚拟内存的地址空间， 这就提供了内存使用当中最大的灵活性。区域大小由<code>-XX:G1HeapRegionSize</code>决定。一般来说，JVM 大约划分 2000 个 regions，它们的大小范围为 [1, 32] MB</p>
<p>但是<strong>在概念上</strong>仍采取分代内存的思想，即这些 regions 会分别映射到 eden、survivor、old。</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401161859543.png" alt="image-20240401161859543"></p>
<p>此外，还有一种上图没标出的 region，称为巨型区域（huge region）。 这些区域用于容纳尺寸为标准区域 50% 或更大的对象，它们存储为一组连续的区域。 </p>
<h3 id="G1-的-GC-过程"><a href="#G1-的-GC-过程" class="headerlink" title="G1 的 GC 过程"></a>G1 的 GC 过程</h3><h4 id="年轻代收集"><a href="#年轻代收集" class="headerlink" title="年轻代收集"></a>年轻代收集</h4><p>在 YGC（Young GC） 中，live objects 被搬运（evacuated，即复制或移动）到一个或多个 survivor 区域。 如果满足老化阈值，则某些对象将被提升到老一代区域。YGC 将 stw 。</p>
<ul>
<li>注意 Eden 大小和 Survivor 大小是为下一次 YGC 计算的。 相关信息会被保留以帮助计算大小。 诸如暂停时间目标（<code>-XX:MaxGCPauseMillis</code>）之类的事情都会被考虑在内。这种方法可以根据需要放大或缩小 Eden 和 Survivor 的大小。</li>
</ul>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401161917881.png" alt="image-20240401161917881"></p>
<p>在 YGC 的末尾，live objects 已被搬运到幸存者区域或晋升到老年代区域。</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401161929260.png" alt="image-20240401161929260"></p>
<p>综上所述：</p>
<ul>
<li>堆是划分为多个区域的单个内存空间。</li>
<li>年轻代内存由一组不连续的区域组成。<strong>这使得在需要时可以轻松调整大小</strong>。</li>
<li>YGC 是 stw 的事件。 所有应用程序线程都会因该操作而停止。</li>
<li>YGC 使用多个线程并行完成。</li>
<li>活动对象被复制到新的幸存者或老一代区域。</li>
</ul>
<h4 id="老年代收集"><a href="#老年代收集" class="headerlink" title="老年代收集"></a>老年代收集</h4><p>G1 收集器在堆的老年代执行以下阶段。 </p>
<ul>
<li>请注意，某些阶段是 YGC 的一部分（因为 G1 的实现里面，由 YGC 触发 mixed GC &#x2F; full GC）</li>
<li>Mixed GC 是 G1 特有的回收策略，在回收年轻代之余，还会回收部分收益较高的老年代区域</li>
</ul>
<table>
<thead>
<tr>
<th><strong>阶段</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>(1) Initial Mark <em>(Stop the World Event)</em></td>
<td>这是一个 stw 事件。 对于 G1，它搭载在正常的 YGC 上。 标记可能引用老年代区域对象的 survivor 区域（根区域）。</td>
</tr>
<tr>
<td>(2) Root Region Scanning</td>
<td>扫描 survivor 区域以获取对老年代的引用。当应用程序继续运行时会发生这种情况。该阶段必须在 YGC 之前完成。</td>
</tr>
<tr>
<td>(3) Concurrent Marking</td>
<td>在整个堆上查找 live objects。 这发生在应用程序运行时。此阶段可能会被 YGC 中断。</td>
</tr>
<tr>
<td>(4) Remark <em>(Stop the World Event)</em></td>
<td>完成堆中存 live objects 的标记。使用称为开始快照 (SATB) 的算法，该算法比 CMS 收集器中使用的算法快得多。</td>
</tr>
<tr>
<td>(5) Cleanup <em>(Stop the World Event and</em> <em>Concurrent</em><em>)</em></td>
<td>（stw）对 live objects 和完全空闲的 region 执行 accounting（这个词不知道咋翻译）（stw）刷洗 remembered sets。 （concurrent）重置空 region 并将它们返回到 freelist。</td>
</tr>
<tr>
<td>(*) Copying <em>(Stop the World Event)</em></td>
<td>该阶段将 stw 以搬运或将活动对象复制到新的未使用 regions。 这可以通过日志记录为<code>[GC pause (young)]</code>的年轻代区域，或者记录为<code>[GC Pause (mixed)]</code>的年轻代和老年代区域来完成。</td>
</tr>
</tbody></table>
<p>接下来看看这些 phase 是如何和 G1 的老年代交互的</p>
<ol>
<li><strong>Initial Marking Phase</strong></li>
</ol>
<p>活动对象的初始标记是在 YGC 的基础上进行的。 在日志中，这被标记为 <code>GC pause (young)(inital-mark).</code></p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401162004224.png" alt="image-20240401162004224"></p>
<ol start="2">
<li><strong>Concurrent</strong> <strong>Marking Phase</strong></li>
</ol>
<p>如果发现空区域（如“X”所示），则在 marking 阶段立即将其删除。 此外，还计算确定 liveness 的“accounting”信息。</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401162019150.png" alt="image-20240401162019150"></p>
<ol start="3">
<li><strong>Remark Phase</strong></li>
</ol>
<p>空区域被删除并回收。 所有区域的 liveness 将被计算</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401162032792.png" alt="image-20240401162032792"></p>
<ol start="4">
<li><strong>Copying&#x2F;Cleanup Phase</strong></li>
</ol>
<p>G1 选择“liveness”最低的区域，即可以最快收集的区域。 然后这些区域会与 YGC 同时收集。 这在日志中表示为  [GC pause (mixed)]。 所以年轻代和老年代都会同时被收集。</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401162043900.png" alt="image-20240401162043900"></p>
<ol start="5">
<li><strong>After Copying&#x2F;Cleanup Phase</strong></li>
</ol>
<p>所选区域已被收集并压缩为图中所示的深蓝色区域和深绿色区域。</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401162055015.png" alt="image-20240401162055015"></p>
<p>综上所述，关于老年代的 G1 垃圾回收：</p>
<ul>
<li>Concurrent Marking Phase<ul>
<li>Liveness 信息是在应用程序运行时同时计算的。</li>
<li>此 liveness 信息可识别在疏散暂停期间最适合回收的区域。</li>
<li>没有像 CMS 那样的清理阶段。</li>
</ul>
</li>
<li>Remark Phase<ul>
<li>使用<strong>开始快照 (SATB)</strong> 算法，该算法比 CMS 所使用的算法（增量更新）快得多。<ul>
<li><strong>详细介绍：</strong>对于对象关系的扫描处理（GC root 扫描），JVM 使用「三色标记算法」。然而，对于该算法，在用户线程和 GC 线程并发的情况下，存在漏标情况。CMS 和 G1 分别对漏标问题有不同的解决方案。<ul>
<li>CMS 对增加引用环节进行处理（Increment Update），G1 则对删除引用环节进行处理 (SATB）</li>
</ul>
</li>
<li>SATB 算法的机制是：在三色扫描时，如果用户线程断开灰色对象 A 到白色对象B 的引用，会通过写屏障机制记录当前对象状态的快照。然后在 Remark phase 中将 B 改为灰色，重新扫描一遍<ul>
<li>由于 RSet 的存在，且对象 B 在对象引用链中的深度一般较大，遍历链的扫描开销较小</li>
</ul>
</li>
<li>CMS 的增量更新机制是：当黑色对象要增加指向灰色或白色对象的引用关系时，将发出引用的黑色对象改为灰色，重新扫描一遍<ul>
<li>由于黑色对象在对象引用链中的深度较小，遍历链的深度扫描开销大，所以比 G1 的 SATB 慢</li>
</ul>
</li>
</ul>
</li>
<li>完全空的区域被回收。</li>
</ul>
</li>
<li>Copying&#x2F;Cleanup Phase<ul>
<li>年轻代和老年代同时被回收。</li>
<li>老年代区域是根据其活跃度来选择的。</li>
</ul>
</li>
</ul>
<h2 id="PS"><a href="#PS" class="headerlink" title="PS"></a>PS</h2><p>JDK 8 的默认 GC，又叫 throughout GC，注重吞吐</p>
<p>中英文互联网都没搜到特别详实的、原理层次的解析。因此这里主要参考国内 system 领域著名实验室 <a target="_blank" rel="noopener" href="https://ipads.se.sjtu.edu.cn/zh/publications/">iPads</a> 的论文中关于 PS 原理的论述。感兴趣的读者也可以直接阅读论文原文：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ipads.se.sjtu.edu.cn/_media/publications/scissorgc-vee2019.pdf">https://ipads.se.sjtu.edu.cn/_media/publications/scissorgc-vee2019.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://ipads.se.sjtu.edu.cn/_media/publications/yuvee.pdf">https://ipads.se.sjtu.edu.cn/_media/publications/yuvee.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://ipads.se.sjtu.edu.cn/_media/publications/wuatc20.pdf">https://ipads.se.sjtu.edu.cn/_media/publications/wuatc20.pdf</a></li>
</ul>
<h3 id="PS-的-GC-过程"><a href="#PS-的-GC-过程" class="headerlink" title="PS 的 GC 过程"></a>PS 的 GC 过程</h3><p>对于 YGC，PS 基于标记-复制算法（copy-based），论文没有做详细的描述。</p>
<blockquote>
<p>大多数对象一开始分配在 eden 区（一些大对象是例外，会直接分配到 old 区）。当 YGC 后，一些对象被移动到 survivor 区，同时一些其他年老的对象被晋升到老年代。</p>
</blockquote>
<p>对于 FGC，PS 基于标记-整理算法（compaction-based）</p>
<p>PS 的 FGC 实现分为三个阶段，包括 marking phase, summary phase, 和 compacting phase。 这三个阶段都是 region-based: PS 将 JVM 堆<strong>划分为相等大小的连续 regions</strong>（默认大小为 512KB），并将相同 region 内的 live objects 一同整理（compact）</p>
<ul>
<li>论文给出的 region 代码是：</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Region</span> &#123; </span><br><span class="line">    <span class="comment">// Fields in vanilla PSGC</span></span><br><span class="line">    <span class="type">int</span> dcount;</span><br><span class="line">    <span class="type">int</span> live_obj_size;</span><br><span class="line">    <span class="type">char</span>* dest_addr;</span><br><span class="line">    Region*[] src_regions;</span><br><span class="line">    ...</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<blockquote>
<p>去 <a target="_blank" rel="noopener" href="https://github.com/openjdk/jdk8u">openjdk 源码</a>求证了一下，<strong>论文给出的源码应该是简化过的，并不是完整、标准的源码。</strong></p>
<ul>
<li>实际对比后，论文的 <code>class Region</code> 应该对应：<a target="_blank" rel="noopener" href="https://github.com/openjdk/jdk8u/blob/9c9d6b267c41e4c713cacc41befb66007cdb2601/hotspot/src/share/vm/gc_implementation/parallelScavenge/psParallelCompact.hpp#L236">openjdk - RegionData</a></li>
</ul>
</blockquote>
<p>PS 的 FGC 可以划分为以下三阶段：</p>
<ol>
<li><strong>Marking phase：</strong>GC 线程将从已知根（GC roots），例如堆栈引用和静态变量，搜索活动对象。 所有从 GC roots 可达的对象将被标记为活着，并且它们的大小将被添加到特定 region 的 <code>live_obj_size</code> 中。</li>
<li><strong>Summary phase：</strong>marking phase 结束后，PS 会为所有 region 分别根据它们的 <code>live_obj_size</code> 计算出一个 heap summary。<ol>
<li>Heap summary 会生成一个 source region 到 destination region 的映射，这样每个 source region 都会有 1~2 个 destination region 用于后续的对象拷贝。这些映射被保存在 <code>src_regions</code> 中。</li>
<li>Summary phase 也会生成 per-region indices，即 <code>dest_addr</code>，GC 线程可以用它来得到 region 内 live objects的目标地址。</li>
</ol>
</li>
<li><strong>Compacting phase：</strong>Live objects 直到该阶段才会被移动或修改。该阶段是 overhead 最大的，一般占了70% 以上的 FGC 开销。 <ol>
<li>Compacting phase 仍然是 region-based，每个 destination regions 即代表一个 task，GC 线程将并行地从相应的 source regions 中 fetch live objects 去填充这些 destination regions。在 copy 对象的过程中，引用关系也将被更新。</li>
<li>由于 destination regions 自身可能也是其他 region 的 source regions（即一个 region 可能既是 destination 又是 source，既要把自己的 live objects 拷贝到其他 region 那里，也要接受其他 region 拷贝过来的 live objects），因此 GC 线程必须等 destination regions 内的所有 live objects 都被搬运（evacuated）到它们的 destinations 后才能开始处理它们。<ul>
<li><p>该 process order 通过维护一个名为 <code>dcount</code> 或者下图所示 <code>destination_count</code> 的变量来保持。该变量记录了该 region 作为 source，有多少 destination regions。Summary phase 会计算该变量的值。</p>
</li>
<li><p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401162140442.png" alt="image-20240401162140442"></p>
</li>
<li><p>在 Compacting phase，一旦某个 GC 线程 fills up 了一个 destination region，它将相应 update 该 destination region 关联的所有 source region 的 <code>dcount</code>（减1）。当某个 region 的 <code>dcount</code> 减为 0 时，意味着它作为 source region 的职责结束，可以 serve as a destination region 了。该 region 会被 push 到 GC 线程的 working stack 中，并准备好接受其他 source regions 中的 live objects。</p>
</li>
</ul>
</li>
</ol>
</li>
</ol>
<h3 id="Compact-详细算法"><a href="#Compact-详细算法" class="headerlink" title="Compact 详细算法"></a>Compact 详细算法</h3><p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401162113697.png" alt="image-20240401162113697"></p>
<p>论文提供了 Figure 2 来帮助理解，下面详细解说：</p>
<ol>
<li>假设有 6 个 region，从 0 编号到 5；假设有 2 个 GC 线程，从 0 编号到 1</li>
<li>在 Summary phase。由于 region 0 和 region 2 不包含 live objects，所以它们的 <code>dcount</code> 是 0（因为它们不需要将自己的 live objects 拷贝出去）。而其他 region 都有相应的 destination regions</li>
<li>当 Compacting phase 开始时，region 0 和 region 2（<code>dcount</code> 为 0 的 regions）会被分配到 GC thread 0、1 的 working stack 中（如 Figure 2.a 所示）</li>
<li>两个 GC 线程会根据 Summary phase 生成的 per-region indices 将其他 regions 中的 live objects 拷贝到 stack 中对应的 regions（如 Figure 2.a 所示）</li>
<li>当 region 0 被 thread 0 处理后，region1 的 dcount 会减为 0，这意味着 region1 可以作为 destination region 入栈被 GC 线程处理了。</li>
<li>由于 region 1 一开始依赖 region 0，并是 region 3、4 的 destination regions。因此它会被 push 到 thread 0 的栈中（如 Figure 2.b 所示）</li>
<li>相反，当 thread 1 完成 region 2 的处理后，region 5 并不会被 push 到 GC 线程的栈中，因为没有 region 依赖它。</li>
<li>相似地，当 region 1 的 task 完成后，region 3、4 不会被 push 到 GC 线程的栈中。此时所有的 live objects 都被整理完毕，compacting phase 结束。</li>
</ol>
<h2 id="GC-对性能的影响"><a href="#GC-对性能的影响" class="headerlink" title="GC 对性能的影响"></a>GC 对性能的影响</h2><p><strong>受GC影响请求占比&#x3D;(接口响应时间+GC时间)×N&#x2F;T</strong></p>
<p>举例：假设单位时间T内发生一次持续25ms的GC，接口平均响应时间为50ms，且请求均匀到达，根据下图所示：</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401162150663.png" alt="image-20240401162150663"></p>
<p>那么有 (50ms+25ms)&#x2F;T 比例的请求会受GC影响，其中GC前的 50ms 内到达的请求都会增加 25ms，GC期间的25ms 内到达的请求，会增加 0-25ms 不等，如果时间 T 内发生 N 次GC，<strong>受GC影响请求占比&#x3D;(接口响应时间+GC时间)×N&#x2F;T</strong> 。可见无论降低单次 GC 时间还是降低 GC 次数 N 都可以有效减少 GC 对响应时间的影响。</p>
<h1 id="JVM-调优参数"><a href="#JVM-调优参数" class="headerlink" title="JVM 调优参数"></a>JVM 调优参数</h1><p>以下参数均来自 oracle JDK 8、11、17 官方文档 GC VM options 板块，本文档实现了对 oracle 官网的全覆盖。</p>
<p>很多参数背后都有 trade-off。所以 JDK 团队已经为我们选取了最合适的 default 值，大多数情况不需要修改。</p>
<ul>
<li>比如说：<code>-XX:InitiatingHeapOccupancyPercent</code>，如果该值过小，比如 Mixed GC 周期结束后老年代使用率还是超过 IHOP，那么会再次触发全局并发标记过程，这样就会导致频繁的老年代 GC，影响应用吞吐量。如果此值太高，会导致老年代回收不及时（容易导致年轻代晋升失败而触发 Full GC） + 老年代一次回收的任务量较重（造成尖刺）</li>
</ul>
<h2 id="G1-1"><a href="#G1-1" class="headerlink" title="G1"></a>G1</h2><table>
<thead>
<tr>
<th><strong>JVM</strong> <strong>选项</strong></th>
<th><strong>类别</strong> （控制哪方面）</th>
<th><strong>描述</strong></th>
<th><strong>调优建议</strong></th>
<th><strong>支持的</strong> <strong>LTS</strong> <strong>version</strong></th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+UseG1GC</td>
<td>-</td>
<td>指定使用 G1 GC</td>
<td>无</td>
<td>8、11、17</td>
</tr>
<tr>
<td>-XX:MaxGCPauseMillis（越低延迟越低）</td>
<td>自适应</td>
<td>指定最大的 GC pause time。指定的 target 是一个软目标（soft goal），JVM 会用一些机制尽最大努力来达到它。对于 G1，默认值为 200（0.2 秒）</td>
<td>这是一个软性目标，G1 会尽量达成，如果达不成，会逐渐做自我调整。<strong>该参数是停顿时间和吞吐量的取舍</strong>对于 Young GC 来说，会逐渐减少 Eden 区个数，减少 Eden 空间那么 Young GC 的处理时间就会相应减少；对于 Mixed GC，G1 会调整每次 Choose Cset 的比例，默认最大值是 10%，当然每次选择的 Cset 少了，所要经历的 Mixed GC 的次数会相应增加。同时减少 Eden 的总空间时，就会更加频繁的触发 Young GC，也就是会加快 Mixed GC 的执行频率，因为 Mixed GC 是由Young GC 触发的，或者说借机同时执行的。频繁 GC 会对应用的吞吐量造成影响，每次 Mixed GC 回收时间太短，回收的垃圾量太少，可能最后 GC 的垃圾清理速度赶不上应用产生的速度，那么可能会造成串行的 Full GC，这是要极力避免的。所以暂停时间肯定不是设置的越小越好，当然也不能设置的偏大，转而指望 G1 自己会尽快的处理，这样可能会导致一次全部并发标记后触发的 Mixed GC 次数变少，但每次的时间变长， STW 时间变长，对应用的影响更加明显。该参数与 JVM GC 的自适应调优（<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/ergonomics.html#ergonomics">GC ergonomics</a>）相关</td>
<td>8、11、17</td>
</tr>
<tr>
<td>-XX:GCTimeRatio（越高吞吐越高）</td>
<td>自适应</td>
<td>参数的值应当是一个大于 0 且小于 100 的整数，也就是垃圾收集时间占总时间的比率，相当于是吞吐量的倒数。<strong>如果把此参数设置为 19，那允许的最大 GC 时间就占总时间的 5%（即 1 &#x2F;（1+19））</strong>G1 的默认值为 12，就是允许最大大约 8%（ 1 &#x2F;（1+12））的垃圾收集时间。</td>
<td>根据需求妥善设置，如果该值设置的过高，那么可能会导致 heap 一直在 minimum 的 size。该参数与 JVM GC 的自适应调优（<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/ergonomics.html#ergonomics">GC ergonomics</a>）相关</td>
<td></td>
</tr>
<tr>
<td>-XX:NewRatio</td>
<td>内存</td>
<td>young&#x2F;old generation 大小的比例。默认值是 2</td>
<td>G1 不建议手动设置，原因参考 <a target="_blank" rel="noopener" href="https://www.oracle.com/technical-resources/articles/java/g1gc.html">oracle 官网文章</a></td>
<td>8、11、17</td>
</tr>
<tr>
<td>-XX:SurvivorRatio</td>
<td>内存</td>
<td>eden&#x2F;survivor 区大小的比例，默认值是 8</td>
<td>G1 不建议手动设置，原因参考 <a target="_blank" rel="noopener" href="https://www.oracle.com/technical-resources/articles/java/g1gc.html">oracle 官网文章</a></td>
<td>8、11、17</td>
</tr>
<tr>
<td>-XX:G1ReservePercent</td>
<td>内存</td>
<td>G1 会将堆中的某一部分空间预先保留作为虚天花板（false ceiling）来减少晋升失败的情况（晋升失败会导致 FGC），默认值是 10补注：比如默认情况下，老年代会预留 10% 的空间来给新生代的对象晋升，如果经常发生新生代晋升失败而导致 FGC，那么可以适当调高此阈值。但是调高此值同时也意味着降低了老年代的实际可用空间</td>
<td>如果经常发生新生代晋升失败而导致Full GC，那么可以适当调高此阈值。但是调高此值同时也意味着降低了老年代的实际可用空间官方文档特别提醒：如果增加或减少该参数比例，最好确保同步调整整个 Java heap 的大小</td>
<td>8、11、17</td>
</tr>
<tr>
<td>-XX:G1HeapRegionSize</td>
<td>内存</td>
<td>G1 的内存模型是把 heap 分成一个个 region，该参数指定了 region 的大小。默认值根据 heap size 决定，最小值是 1M，最大值是 32M</td>
<td>Region的大小主要是关系到Humongous Object的判定，当一个对象超过Region大小的一半时，则为巨型对象，那么其会至少独占一个Region，如果一个放不下，会占用连续的多个Region。当一个Humongous Region放入了一个巨型对象，可能还有不少剩余空间，但是不能用于存放其他对象，这些空间就浪费了。所以如果应用里有很多大小差不多的巨型对象，可以适当调整Region的大小，尽量让他们以普通对象的形式分配，合理利用Region空间。</td>
<td>8、11、17</td>
</tr>
<tr>
<td>-XX:G1NewSizePercent</td>
<td>内存</td>
<td>Young generation 内存大小的下限（以占堆大小的百分比来表示）。默认值是 5%。This is an experimental flag. See “<a target="_blank" rel="noopener" href="https://www.oracle.com/technical-resources/articles/java/g1gc.html#Unlock">How to unlock experimental VM flags</a>“ for an example. This setting replaces the <code>-XX:DefaultMinNewGenPercent</code> setting.</td>
<td>新生代比例有两个数值指定，下限：-XX:G1NewSizePercent，默认值 5%，上限：-XX:G1MaxNewSizePercent，默认值 60%。G1 会根据实际的 GC 情况（主要是暂停时间）来动态的调整新生代的大小，主要是 Eden Region 的个数。最好是 Eden 的空间大一点，毕竟 Young GC 的频率更大，大的 Eden 空间能够降低 Young GC 的发生次数。但是 Mixed GC 是伴随着 Young GC 一起的，如果暂停时间短，那么需要更加频繁的 Young GC，同时也需要平衡好 Mixed GC 中新生代和老年代的 Region，因为新生代的所有 Region 都会被回收，如果 Eden 很大，那么留给老年代回收空间就不多了，最后可能会导致 Full GC。</td>
<td>11、17</td>
</tr>
<tr>
<td>-XX:G1MaxNewSizePercent</td>
<td>内存</td>
<td>Young generation 内存大小的上限（以占堆大小的百分比来表示）。默认值是 60%。This is an experimental flag. See “<a target="_blank" rel="noopener" href="https://www.oracle.com/technical-resources/articles/java/g1gc.html#Unlock">How to unlock experimental VM flags</a>“ for an example. This setting replaces the <code>-XX:DefaultMaxNewGenPercent</code> setting. This setting is not available in Java HotSpot VM, build 23.</td>
<td>见上</td>
<td>11、17</td>
</tr>
<tr>
<td>-XX:ParallelGCThreads</td>
<td>效率</td>
<td>stop-the-world (STW) worker 线程数。该参数将被用作设置 logical processors 数。默认值取决于宿主机 CPU 的核数。</td>
<td>当 GC 时间过长时，可以尝试调大 GC 工作线程数，但是这也意味着此期间应用所占的线程数减少，会对吞吐量有一定影响。</td>
<td>8、11、17</td>
</tr>
<tr>
<td>-XX:ConcGCThreads</td>
<td>效率</td>
<td>concurrent GC 阶段（即非 STW 阶段）所用到的线程数。根据官方文档，推荐设置为<code>-XX:ParellelGCThreads</code>的四分之一</td>
<td>该值同样是吞吐和停顿时间的取舍，需要根据实际需求测试调整。</td>
<td>8、11、17</td>
</tr>
<tr>
<td>-XX:InitiatingHeapOccupancyPercent</td>
<td>行为&#x2F;时机</td>
<td>当老年代占用的<strong>整个</strong> heap 的比例达到该值时，开启一个 concurrent GC cycle。默认值是 45%如果为 0，意味着 G1 将不停进行并发 GC，直到 G1 adaptively set this value（17 特性，8、11 没有该特性）</td>
<td>如果该值过小，比如 Mixed GC 周期结束后老年代使用率还是超过 45%，那么会再次触发全局并发标记过程，这样就会导致频繁的老年代 GC，影响应用吞吐量如果老年代空间不大，Mixed GC 回收的空间偏少。可以适当调高 IHOP 的值如果此值太高，很容易导致年轻代晋升失败而触发 Full GC，所以需要多次调整测试进行取舍</td>
<td>8、11、17</td>
</tr>
<tr>
<td>-XX:MaxTenuringThreshold</td>
<td>行为&#x2F;时机</td>
<td>Tenuring 的阈值（补注：一般新生对象经过 15 次 Young GC 会晋升到老年代，巨型对象会直接分配在老年代），除了 CMS 默认值是 6，其他默认值是 15，最大值也是 15</td>
<td>一般这个值不需要额外调整，但如果观察到对象在达到某个年龄 n 后，不怎么晋升，直到15岁，那么可以适当调小 MaxTenuringThreshold 到 n，以减少 ygc 中复制对象的开销。</td>
<td>8、11、17</td>
</tr>
<tr>
<td>-XX:G1HeapWastePercent</td>
<td>行为&#x2F;时机</td>
<td>开发者可接受浪费的 heap percentage。当可回收（reclaimable）的比例小于该值时，JVM 将不会触发 Mixed GC。默认值是 5%</td>
<td>在全局标记结束后能够统计出所有 Cset 内可被回收的垃圾占整对的比例值，如果超过 5%，那么就会触发之后的多轮 Mixed GC，如果不超过，那么会在之后的某次 Young GC 中重新执行全局并发标记。可以尝试适当的调高此阈值，能够适当的降低 Mixed GC 的频率。</td>
<td>11、17</td>
</tr>
<tr>
<td>-XX:G1MixedGCLiveThresholdPercent</td>
<td>行为&#x2F;时机</td>
<td>Mixed GC 选择回收 old region 的 occupancy 阈值。在全局并发标记阶段，如果一个 Region 的 live objects 的空间占比低于此值，则会被纳入 Cset。此值直接影响到 Mixed GC 选择回收的区域。11 和 17 的默认值是 85This is an experimental flag. See “<a target="_blank" rel="noopener" href="https://www.oracle.com/technical-resources/articles/java/g1gc.html#Unlock">How to unlock experimental VM flags</a>“ for an example. This setting replaces the <code>-XX:G1OldCSetRegionLiveThresholdPercent</code> setting.</td>
<td>当发现 GC 时间较长时，可以尝试调低此阈值，尽量优先选择回收垃圾占比高的Region，但此举也可能导致垃圾回收的不够彻底，最终触发 Full GC。</td>
<td>11、17</td>
</tr>
<tr>
<td>-XX:G1OldCSetRegionThresholdPercent</td>
<td>行为&#x2F;时机</td>
<td>每轮 Mixed GC 回收的 Region 最大比例。默认值是 10%</td>
<td>一般这个值不需要额外调整。</td>
<td>11、17</td>
</tr>
<tr>
<td>-XX:G1MixedGCCountTarget</td>
<td>行为&#x2F;时机</td>
<td>回收超过<code>G1MixedGCLIveThresholdPercent</code>的老年代时，最多进行的 mixed gc 次数。默认值是 8，mixed gc 的目标是要控制在此目标次数以内</td>
<td>在一次全局并发标记后，最多接着 8 次 Mixed GC，即会把全局并发标记阶段生成的 Cset 里的 Region 拆分为最多 8 部分，然后在每轮 Mixed GC 里收集一部分。这个值要和上一个参数配合使用，8*10%&#x3D;80%，应该来说会大于每次标记阶段的 Cset 集合了。一般此参数也不需额外调整。</td>
<td>11、17</td>
</tr>
</tbody></table>
<h2 id="PS-1"><a href="#PS-1" class="headerlink" title="PS"></a>PS</h2><table>
<thead>
<tr>
<th><strong>JVM</strong> <strong>选项</strong></th>
<th><strong>类别</strong> （控制哪方面）</th>
<th><strong>描述</strong></th>
<th><strong>调优建议</strong></th>
<th><strong>支持的</strong> <strong>LTS</strong> <strong>version</strong></th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+UseParallelGC</td>
<td>-</td>
<td>使用 PS，JDK 默认使用该参数，use Parallel Scavenge + Parallel Old as a combination.</td>
<td>无</td>
<td>8，11，17</td>
</tr>
<tr>
<td>-XX:MaxGCPauseMillis</td>
<td>自适应</td>
<td>指定最大的 GC pause time。指定的 target 是一个软目标（soft goal），JVM 会用一些机制尽最大努力来达到它。默认不使用它，值为 18446744073709551615可以通过设置来使用它</td>
<td>同上</td>
<td>8，11，17</td>
</tr>
<tr>
<td>-XX:GCTimeRatio</td>
<td>自适应</td>
<td>参数的值应当是一个大于 0 且小于 100 的整数，也就是垃圾收集时间占总时间的比率，相当于是吞吐量的倒数。<strong>如果把此参数设置为 19，那允许的最大</strong> <strong>GC</strong> <strong>时间就占总时间的 5%（即 1 &#x2F;（1+19））</strong>PS 的默认值为 99，就是允许最大 1%（即 1 &#x2F;（1+99））的垃圾收集时间。</td>
<td>根据需求妥善设置，如果该值设置的过高，那么可能会导致 heap 一直在 minimum 的 size。该参数与 JVM GC 的自适应调优（<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/ergonomics.html#ergonomics">GC ergonomics</a>）相关</td>
<td>8，11，17</td>
</tr>
<tr>
<td>-XX:+UseAdaptiveSizePolicy</td>
<td>自适应</td>
<td>一个开关参数，<strong>默认打开</strong>。当这个参数打开之后，就不需要手工指定新生代的大小（-Xmn）、Eden 与 Survivor 区的比例（-XX:SurvivorRatio）、晋升老年代对象年龄（-XX:PretenureSizeThreshold）等细节参数了，虚拟机会根据当前系统的运行情况收集性能监控信息，动态调整这些参数以提供最合适的停顿时间或者最大的吞吐量，这种调节方式称为 GC 自适应的调节策略（<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/ergonomics.html#ergonomics">GC ergonomics</a>）。</td>
<td>如果对于收集器运作原来不太了解，手工优化存在困难的时候，使用 Parallel Scavenge 收集器配合自适应调节策略，把内存管理的调优任务交给虚拟机去完成将是一个不错的选择。只需要把基本的内存数据设置好（如-Xmx 设置最大堆），然后使用 MaxGCPauseMillis 参数（更关注最大停顿时间）或 GCTimeRatio（更关注吞吐量）参数给虚拟机设立一个优化目标，那具体细节参数的调节工作就由虚拟机完成了。自适应调节策略也是 Parallel Scavenge 收集器与 ParNew 收集器的一个重要区别。</td>
<td>8，11，17</td>
</tr>
<tr>
<td>-XX:SurvivorRatio</td>
<td>内存</td>
<td>Eden 区和 survivor 区大小的比值，默认为 8</td>
<td>如果大量对象都在一次 YoungGC 后就会回收清理，那么新生代 Eden：From：To 为默认的 8：1：1 就比较合适。如果说很大部分对象的年龄都超过1，即需要在Survivor 的 From, To 中来回转换几次之后才能被回收，那么此时可以适当增大一下 Survivor 区的空间，并且可以将 Survivor 的空间使用率增大，避免对象年龄增长过快，从而被移动到老年代，造成 FullGC</td>
<td>8，11，17</td>
</tr>
<tr>
<td>-XX:NewRatio</td>
<td>内存</td>
<td>young&#x2F;old generation 大小的比例。默认值是 2</td>
<td>如果 old 区有空余，可以增大 young 区的比例，减少 ygc 的次数，减缓对象晋升的速度。</td>
<td>8，11，17</td>
</tr>
<tr>
<td>-XX:PretenureSizeThreshold</td>
<td>内存</td>
<td>直接进入老年代的对象的大小阈值，大于这个值的对象将直接在老年代分配没在 8、11、17 的官方文档上找到该参数的说明，所以没找到默认值是多少。但是实测 8、11、17 均支持该参数</td>
<td>暂时没搜到相关资料</td>
<td>8，11，17</td>
</tr>
<tr>
<td>-XX:ParallelGCThreads</td>
<td>效率</td>
<td>stop-the-world (STW) worker 线程数。该参数将被用作设置 logical processors 数。默认值取决于宿主机 CPU 的核数。</td>
<td>当 GC 时间过长时，可以尝试调大 GC 工作线程数，但是这也意味着此期间应用所占的线程数减少，会对吞吐量有一定影响。</td>
<td>8，11，17</td>
</tr>
<tr>
<td>-XX:+UseNUMA</td>
<td>效率</td>
<td>通过增加应用程序对低延迟内存的使用，可以优化具有 NUMA 的计算机上的应用程序的性能。 默认情况下，该选项处于禁用状态，并且不会对 NUMA 进行优化。 该选项仅在使用 PS （-XX:+UseParallelGC）时可用。</td>
<td>支持 NUMA 可以打开</td>
<td>8，11，17</td>
</tr>
<tr>
<td>-XX:TargetSurvivorRatio</td>
<td>行为&#x2F;时机</td>
<td>该参数设置了 YGC 后，期望 survivor used space 占比多少。根据这篇 <a target="_blank" rel="noopener" href="https://www.herongyang.com/Java-GC/Serial-TargetSurvivorRatio-Second-Tenuring-Condition.html">blog</a> 的实验结果，如果 survivor space 的 usage 占比超过了该参数，那么某些 live objects 会被直接晋升到 tenured generation，即使他们的 age 可能还没到 MaxTenuringThreshold。这种现象叫做 premature tenuring (or premature promotion)默认值为 50%</td>
<td>该参数一定程度上决定了对象的晋升。</td>
<td>8，11，17</td>
</tr>
</tbody></table>
<h1 id="调优建议"><a href="#调优建议" class="headerlink" title="调优建议"></a>调优建议</h1><p>我们调优的时候，通常从以下事实出发：</p>
<ol>
<li><strong>调优目标：</strong></li>
</ol>
<ul>
<li>降低停顿时间（减少 fgc）（常用）</li>
<li>提高吞吐（减少 gc 次数）（常用）</li>
<li>降低 footprint 占用</li>
</ul>
<ol start="2">
<li><strong>根据业务需求进行调优：</strong></li>
</ol>
<ul>
<li>比如对于高并发场景，大多数对象是朝生夕死的，也就是说大部分对象在新生代创建后，还没来得及晋升到老年代就死亡了。这种情况下就需要提高新生代内存，减少 fgc。</li>
</ul>
<ol start="3">
<li><strong>调优策略</strong></li>
</ol>
<p>我们的终极目标是</p>
<ol>
<li>减少 ygc、fgc 的次数</li>
<li>降低 ygc、fgc 的耗时</li>
</ol>
<p>首先对于<strong>减少次数</strong>：我们从 GC 的成因拆解。</p>
<ul>
<li><strong>ygc</strong> 的成因是新生代的空间不足以容纳对象大小 —— 因此减少 ygc 的次数可以通过增加新生代空间大小实现。常见的做法是分析 old 和 young 的空间大小，如果 old 有盈余，可以适当减少 old，增加 young</li>
<li><strong>Fgc</strong> 的成因是<ul>
<li>当新生代的 Eden 区、Survivor 区无法容纳新的对象时，会触发 ygc。如果在 ygc 后仍然没有足够的内存空间分配对象，则会触发 fgc —— 因此这里还是新生代空间大小的问题，可以通过增大新生代空间解决</li>
<li>当老年代无法容纳新的对象时，会触发 Major GC（老年代垃圾回收）。如果在 Major GC 后仍然没有足够的内存空间分配对象，则会触发 fgc —— 1. 如果是老生代空间大小的问题，可以通过增大老生代空间解决；2. 如果是对象晋升过快的问题，可以调大 survivor 区大小，减缓对象在 from 和 to 区复制转移的速度；或者直接增大新生代空间，以减缓年龄晋升速度；3. 调整代码，尽量减少大对象和对象频繁创建行为</li>
<li>当元空间的类加载信息、常量池等元数据无法容纳新的数据时，会触发 fgc —— 因此这里是 metapsace 空间大小的问题，可以通过增大 metaspace 空间解决</li>
</ul>
</li>
</ul>
<p>其次对于<strong>减少耗时</strong>，这里要复杂很多，我们仍然从成因分析：</p>
<ul>
<li>Ygc 的一个常见耗时场景：对于 PS、G1 这种标记复制算法的 gc，大多数对象需要在 survivor 区的 from 和 to 复制多次，直到晋升 —— 所以为了减少复制成本，<code>MaxTenuringThreshold</code> 要尽量合理，不能设置太大，否则有些长寿对象在每次 GC 时都会在两个 Survivor 区之间来回复制，无疑是增加了复制阶段的耗时</li>
<li>GC log 里经常会看到 safe-point  —— 遇到锁竞争时，取消锁的过程需要等待全局安全点（safe point），会导致所有线程暂停，即会发生Stop-The-World。所以在锁竞争激烈的场景下，最好提前关闭掉偏向锁。</li>
<li>GC 的某个阶段耗时过长（可以从日志看出） —— 1. 调整并行线程、并发线程等参数，增加并行度，优化性能；2. 优化代码，减少大对象创建等；3. 根据实际情况减少该阶段的耗时</li>
</ul>
<ol start="4">
<li><strong>内存参数基本策略</strong></li>
</ol>
<p>各分区的大小对 GC 的性能影响很大。如何将各分区调整到合适的大小，分析活跃数据的大小是很好的切入点。</p>
<p><strong>活跃数据的大小</strong>是指，应用程序稳定运行时长期存活对象在堆中占用的空间大小，也就是 Full GC 后堆中老年代占用空间的大小。可以通过 GC 日志中 Full GC 之后老年代数据大小得出，比较准确的方法是在程序稳定后，多次获取 GC 数据，通过取平均值的方式计算活跃数据的大小。活跃数据和各分区之间的比例关系如下：</p>
<table>
<thead>
<tr>
<th><strong>内存区域</strong></th>
<th><strong>推荐设置大小</strong></th>
</tr>
</thead>
<tbody><tr>
<td>总大小</td>
<td>3-4 倍活跃数据的大小</td>
</tr>
<tr>
<td>新生代</td>
<td>1-1.5 活跃数据的大小</td>
</tr>
<tr>
<td>老年代</td>
<td>2-3 倍活跃数据的大小</td>
</tr>
<tr>
<td>永久代</td>
<td>1.2-1.5 倍Full GC后的永久代空间占用</td>
</tr>
</tbody></table>
<p>例如，根据GC日志获得老年代的活跃数据大小为300M，那么各分区大小可以设为：</p>
<p>总堆：1200MB &#x3D; 300MB × 4</p>
<p>新生代：450MB &#x3D; 300MB × 1.5</p>
<p>老年代： 750MB &#x3D; 1200MB - 450MB</p>
<p>这部分设置仅仅是堆大小的初始值，后面的优化中，可能会调整这些值，具体情况取决于应用程序的特性和需求。</p>
<h2 id="PS-2"><a href="#PS-2" class="headerlink" title="PS"></a>PS</h2><p>Parallel GC会尽量去满足如下目标：（优先级由高到低）</p>
<ul>
<li>最大停顿时间目标</li>
<li>吞吐量目标</li>
<li>最小移动目标</li>
</ul>
<p>对 ParallelGC 的调优，其目标应尽可能避免 Full GC, 这就需要优化对象老年化的频率，</p>
<p>使用 ParallelGC 时，垃圾收集的资源开销应小于 5%，如果已经减少到 1% 甚至更少，基本上已经达到极限了。</p>
<h3 id="吞吐优先"><a href="#吞吐优先" class="headerlink" title="吞吐优先"></a>吞吐优先</h3><ol>
<li><strong>JVM 自适应调优：</strong>宏观目标：<code>-XX:GCTimeRatio=99</code> 。其值为1-100的整数，表示吞吐量，默认值是99，表示允许1%的垃圾回收时间占比。暂停时间越长，那么垃圾回收占用的时间比越大，可能会超过前面的设定比例。</li>
<li><strong>降低线程资源占用：</strong>根据实际情况适当调小<code>-XX:ParallelGCThreads</code> ，给用户线程让出更多的 CPU 资源</li>
<li><strong>想方设法降低 GC 频率</strong>（这样可能会导致每次 GC 的 stw 时间变长）：包括调高<code>-XX:MaxGCPauseMills</code>等<ol>
<li>如果 ygc 频率过高，可以从两个角度考虑：<ol>
<li>尝试调高 young 区大小，推迟对象堆积的时机</li>
<li>根据日志：尝试调整晋升年龄，将大部分对象及时晋升，减少在 s 区来回 copy 的开销并占据 young 区</li>
</ol>
</li>
<li>如果 fgc 频率过高，建议根据日志从以下角度考虑调优<ol>
<li>是否 old 区内存增长速度过快——减缓对象晋升速度<ol>
<li>可以调整 young 区<ol>
<li>直接调大 size：<code>-Xmn</code></li>
<li>调整 young 和 old 的比例 ：<code>-XX:NewRatio</code></li>
<li>可以调大 survivor 区，减缓对象晋升速度：<code>-XX:SurvivorRatio</code></li>
</ol>
</li>
</ol>
</li>
<li>是否 young 区过小，ygc 后仍然没有足够空间——调大 young 区<ol>
<li>直接调大 size：<code>-Xmn</code></li>
<li>调整 young 和 old 的比例 ：<code>-XX:NewRatio</code></li>
</ol>
</li>
<li>Meta 区是否过小——调大 Meta 区</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="延迟优先"><a href="#延迟优先" class="headerlink" title="延迟优先"></a>延迟优先</h3><ol>
<li>宏观目标：<code>-XX:MaxGCPauseMills=&lt;N&gt;</code> ，值大于0的毫秒数。</li>
<li>新生代（Ygc）调优： 如果发现 GC 频率过高，整体新生代又太小，可以增大新生代的大小，从而降低 YGC 的频率和占用时间。ParallelGC 可以自动调整 Survivor 空间，大部分的程序使用自动调整可以满足要求，个别应用在需要的情况下可以关闭自动调整，进行手动调整。<ol>
<li><code>-Xmn</code>（设置新生代大小） 、<code>-XX:-UseAdaptiveSizePolicy</code>（关闭自适应调整）</li>
<li>一般情况下 Eden 区的大小比 Survivor 大很多，如果大量对象都在一次 YoungGC 后就会回收清理，那么新生代 Eden：From：To 为8：1：1就比较合适。如果说很大部分对象的年龄都超过 1，即需要在 Survivor 的 From，To 中来回转换几次之后才能被回收，那么此时可以调小 SurvivorRatio 的值，在整个新生代不变的情况下，会增大 Survivor 区的大小（From 和 To 同时增大）。将 Survivor 的空间使用率增大，避免对象年龄增长过快，从而被移动到老年代，造成 FullGC。<ol>
<li><code>-XX:SurvivorRatio</code> 可以调整新生代中 Survivor 与 Eden 区的比例，例如 <code>-XX:SurvivorRatio=6</code> 表示S(From) : S(To) : Eden &#x3D; 1: 1: 6 。其默认值为8</li>
</ol>
</li>
</ol>
</li>
<li>老年代调优</li>
<li>并行线程的优化：<code>-XX:ParallelGCThreads=&lt;N&gt;</code>。此参数设置年轻代并行收集器的线程数，一般与 CPU数量相等，过多的线程数量会影响垃圾回收以及整个程序的性能。</li>
</ol>
<h2 id="G1-2"><a href="#G1-2" class="headerlink" title="G1"></a>G1</h2><p>无论以延迟还是吞吐为目标，Oracle 官网<strong>不建议</strong>我们<strong>显式</strong>通过<code>-Xmn</code><strong>设置新生代区域大小</strong>（仅管前面 PS 我们提到过这种做法），因为这与 G1 的默认表现相悖：</p>
<ul>
<li>设置新生代大小会让 G1 的停顿目标失效</li>
<li>设置新生代大小会让 G1 失去动态扩缩容新生代的能力</li>
</ul>
<h3 id="吞吐优先-1"><a href="#吞吐优先-1" class="headerlink" title="吞吐优先"></a>吞吐优先</h3><p>想达到吞吐目标，建议优先考虑 PS。</p>
<p>如果想使用 G1 的同时优化吞吐，建议：</p>
<ol>
<li><strong>降低线程资源占用：</strong>根据实际情况适当调小<code> -XX:ParallelGCThreads</code> 和<code> -XX:ConcGCThreads</code>，给用户线程让出更多的 CPU 资源</li>
<li><strong>想方设法降低 GC 频率</strong>（这样可能会导致每次 GC 的 stw 时间变长）：包括调高<code>XX:MaxGCPauseMillis</code>等方法<ol>
<li>可以参考上文 PS 片段中提到的方法</li>
<li>此外还可以根据日志观察程序是否有规律大小的大对象。如有，可针对性设置 regionSize，增大内存利用率。</li>
<li>如果上述方法都效果不大，尤其是在 space-reclaimation 阶段，根据 <a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/gctuning/garbage-first-garbage-collector-tuning.html#GUID-70E3F150-B68E-4787-BBF1-F91315AC9AB9">oracle 官网</a>，建议调高 young 区的最小 size<code> -XX:G1NewSizePercent</code> 并调高 young 区的上限 size <code>-XX:G1MaxNewSizePercent</code></li>
<li>如果 fgc 频率过高，对于 G1，可以适当提高 mixed gc 频率。调整 <code>-XX:G1HeapWastePercent</code>。也可以调整 <code>-XX:InitiatingHeapOccupancyPercent</code>，来提前开启并发标记，用更多的小代价 mixed gc 换取更少的高代价 fgc</li>
</ol>
</li>
<li><strong>降低 concurrent work 的频率</strong>：根据 <a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/gctuning/garbage-first-garbage-collector-tuning.html#GUID-70E3F150-B68E-4787-BBF1-F91315AC9AB9">oracle 官网</a>，并发很消耗 cpu 资源。可以调高 <code>-XX:G1RSetUpdatingPauseTimePercent</code>，将并发工作移到 gc pause 中。</li>
<li><strong>内存调优：</strong><code>-XX:+AlwaysPreTouch</code>，将 <code>-Xmx</code> 和 <code>-Xms</code> 设置为同样的值以禁止堆自动扩缩容</li>
</ol>
<h3 id="延迟优先-1"><a href="#延迟优先-1" class="headerlink" title="延迟优先"></a>延迟优先</h3><ol>
<li><p>根据 oracle 官网的建议，对于延迟我们主要关注 <code>XX:MaxGCPauseMillis=&lt;N&gt;</code>参数，考虑将<code>XX:MaxGCPauseMillis</code> 设置为能满足 90% 场景需求的值。也就是说，90% 的 gc 停顿不超过 <code>XX:MaxGCPauseMillis</code></p>
</li>
<li><p>如果我们在日志中看到很多 <strong>Evacuation Failure</strong>，那么可以考虑下面一些方案：</p>
<ol>
<li><blockquote>
<p><strong>What is an Evacuation Failure?</strong></p>
<p>A promotion failure that happens when a JVM runs out of heap regions during the GC for either survivors and promoted objects. The heap can’t expand because it is already at max. This is indicated in the GC logs when using <code>-XX:+PrintGCDetails</code> by <strong><code>to-space overflow</code></strong>. This is expensive!</p>
<ul>
<li>GC still has to continue, so space has to be freed up.</li>
<li>Unsuccessfully copied objects have to be tenured in place.</li>
<li>Any updates to RSets of regions in the CSet have to be regenerated.</li>
<li>All of these steps are expensive.</li>
</ul>
</blockquote>
</li>
<li><p>增加 heap size</p>
<ol>
<li>此时最好同步增加**<code>-XX:G1ReservePercent=n</code>**, 默认值是 10。这样会流出更多的空间来供晋升</li>
</ol>
</li>
<li><p>更早开启 marking cycle，调低 <strong><code>-XX:InitiatingHeapOccupancyPercent</code><strong>（提前开启 mixed GC）</strong>。</strong> Evacuation Failure 的代价比多执行一些 marking cycle 周期高很多。</p>
</li>
<li><p>增加 marking 阶段的线程，设置 <strong><code>-XX:ConcGCThreads</code></strong></p>
</li>
</ol>
</li>
<li><p>优化 ygc 时间。</p>
<ol>
<li>观察大部分对象的晋升年龄和目前程序设置的 tenure threshold，将二者调为一致，保证对象在该晋升时就晋升，减少新生代 from 和 to 区来回复制的开销</li>
</ol>
</li>
<li><p>优化 mixed gc 时间（此段参考 <a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/gctuning/garbage-first-garbage-collector-tuning.html#GUID-D2B6ADCE-6766-4FF8-AA9D-B7F4F3D0F469">oracle 官网</a>）</p>
<ol>
<li>通过增加 <code>-XX:G1MixedGCCountTarget</code> 将老年代区域回收分散到更多垃圾回收中。</li>
<li>降低 <code>-XX:G1MixedGCLiveThresholdPercent</code> ，不将花费大量时间的区域放入候选收集集中，可以避免收集这些区域。 在许多情况下，高度占用的区域需要花费大量时间来收集。</li>
<li>可以增加 <code>-XX:G1HeapWastePercent</code>，尽早停止老年代的空间回收，这样 G1 就不会收集那么多高度占用的区域。</li>
</ol>
</li>
</ol>
<h1 id="观测-GC-的方式"><a href="#观测-GC-的方式" class="headerlink" title="观测 GC 的方式"></a>观测 GC 的方式</h1><h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><h3 id="开启日志参数"><a href="#开启日志参数" class="headerlink" title="开启日志参数"></a>开启日志参数</h3><p>JDK8</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-Xloggc:<span class="variable">$&#123;IOTDB_HOME&#125;</span>/logs/gc.log  </span><br><span class="line">-XX:+PrintGCDateStamps </span><br><span class="line">-XX:+PrintGCDetails </span><br><span class="line">-XX:+PrintHeapAtGC</span><br><span class="line">-XX:+PrintReferenceGC </span><br><span class="line">-XX:+PrintSafepointStatistics</span><br><span class="line">-XX:PrintSafepointStatisticsCount=1  </span><br><span class="line">-XX:+PrintTenuringDistribution </span><br><span class="line">-XX:+PrintGCApplicationStoppedTime </span><br><span class="line">-XX:+PrintPromotionFailure </span><br><span class="line">-XX:+UseGCLogFileRotation </span><br><span class="line">-XX:NumberOfGCLogFiles=10</span><br><span class="line">-XX:GCLogFileSize=100M</span><br></pre></td></tr></table></figure>

<p>JDK9 及以上 JVM 重构了日志框架。大大简化了日志参数，下面的参数基本与上面等价：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-Xlog:</span><br><span class="line">gc*=debug,</span><br><span class="line">heap*=debug,</span><br><span class="line">age*=trace,</span><br><span class="line">metaspace*=info,</span><br><span class="line">safepoint*=debug,</span><br><span class="line">promotion*=info:</span><br><span class="line">file=<span class="variable">$&#123;IOTDB_HOME&#125;</span>/logs/gc.log:time,<span class="built_in">uptime</span>,pid,tid,level,tags:filecount=10,filesize=100M</span><br></pre></td></tr></table></figure>

<h3 id="如何读日志"><a href="#如何读日志" class="headerlink" title="如何读日志"></a>如何读日志</h3><p>默认的 JVM 日志包括：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[启动经过时间][日志级别][日志标签，可能包含多个] 日志内容</span><br></pre></td></tr></table></figure>

<p>比如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">14</span>:<span class="number">32.025</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">278.288</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,alloc,region   ] GC(<span class="number">418</span>) Mutator Allocation stats, regions: <span class="number">136</span>, wasted size: <span class="number">2952</span>B ( <span class="number">0.0</span><span class="operator">%</span>)</span><br></pre></td></tr></table></figure>

<p>其中一行日志，可能包含多个标签。如上面的例子里标签就有 gc、alloc、region。之后关于 JVM 日志相关的配置，也是围绕着这些标签进行配置。</p>
<p>gc 日志有很多标签与组合，大部分以 gc 标签为开始，混合搭配其他一些标签。一般，有如下几个标签我们会经常用到：</p>
<ol>
<li><strong>标签<code>gc</code></strong></li>
</ol>
<p>gc 总体描述日志，一般设置 info 级别查看 gc 的发生时间，消耗时间还有内存大小。例如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">14</span>:<span class="number">32.112</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">278.375</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][info ][gc                ] GC(<span class="number">418</span>) Pause Young (Normal) (G1 Evacuation Pause) <span class="number">20934</span>M<span class="operator">-</span><span class="operator">&gt;</span><span class="number">20078</span>M(<span class="number">25088</span>M) <span class="number">86.631</span>ms</span><br></pre></td></tr></table></figure>

<p>包含了 gc 类型，gc 原因，收集内存大小，持续时间等信息</p>
<blockquote>
<p>目前 System 面板较好的集成了该项日志信息，也推荐直接看 System 面板。</p>
</blockquote>
<ol start="2">
<li><strong>标签<code>gc,age</code></strong></li>
</ol>
<p>gc 中 age 相关信息，age 比较高的对象会进入老年代。debug 级别只会输出最高级别的 age 以及期望大小。如果是 trace 级别，会输出:</p>
<ul>
<li>每一个 age 的所有对象占用总大小</li>
<li>不大于这个 age 的所有 age 的大小。</li>
</ul>
<p>例如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">14</span>:<span class="number">44.595</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">290.858</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][trace][gc,age            ] GC(<span class="number">441</span>) Age <span class="keyword">table</span> <span class="keyword">with</span> threshold <span class="number">15</span> (max threshold <span class="number">15</span>)</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">14</span>:<span class="number">44.595</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">290.858</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][trace][gc,age            ] GC(<span class="number">441</span>) <span class="operator">-</span> age   <span class="number">1</span>:  <span class="number">164913704</span> bytes,  <span class="number">164913704</span> total</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">14</span>:<span class="number">44.595</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">290.858</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][trace][gc,age            ] GC(<span class="number">441</span>) <span class="operator">-</span> age   <span class="number">2</span>:   <span class="number">36313680</span> bytes,  <span class="number">201227384</span> total</span><br></pre></td></tr></table></figure>

<p>这个标签可以有效分析对象的晋升年龄情况，从而调整 <code>-XX:MaxTenuringThreshold</code>等选项</p>
<ol start="3">
<li><strong>标签<code>gc,alloc</code>，<code>gc,alloc,region</code></strong></li>
</ol>
<p>这两个参数仅对 G1 gc 有效 <code>gc,alloc</code> 在 gc 完成的时候，打印 trace 级别日志记录触发 gc 的线程是哪一个以及返回的 gc 结果地址，一般是在 debug 调试 gc 的时候才需要看这个日志，平时开到 debug 级别即可。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[<span class="number">2020</span><span class="number">-02</span><span class="number">-28</span>T02:<span class="number">14</span>:<span class="number">02.694</span><span class="operator">+</span><span class="number">0000</span>][trace][gc,alloc                    ] sdk<span class="number">-27692</span><span class="number">-2</span><span class="operator">-</span>amqp<span class="operator">-</span>t<span class="number">-4</span>: Successfully scheduled collection returning <span class="number">0x00000007ffc00000</span></span><br></pre></td></tr></table></figure>

<p><code>gc,alloc,region</code> 统计每次 gc 的 Regions 信息，打印 debug 级别日志。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">14</span>:<span class="number">46.431</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">292.694</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,alloc,region   ] GC(<span class="number">445</span>) Mutator Allocation stats, regions: <span class="number">136</span>, wasted size: <span class="number">536</span>B ( <span class="number">0.0</span><span class="operator">%</span>)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>标签<code>gc,cpu</code></strong> 这个是大多数 gc 问题定位需要查看的日志，info 级别打印每次gc真正耗时：</li>
</ol>
<p>注意到日志中时间分为了三块：<code>user</code>， <code>sys</code>，和 <code>real</code>，三者的区别和含义如下：</p>
<ul>
<li><code>real</code>：指的是在此次 GC 事件中 CPU 实际所花费的时间，跟钟表上的时间是一致的（wall clock time）；</li>
<li><code>user</code>：指的是 CPU 工作在用户态所花费的时间；</li>
<li><code>sys</code>：指的是 CPU 工作在内核态所花费的时间。</li>
</ul>
<p><code>User</code> + <code>sys</code> 就是 CPU 花费的实际时间，注意这个值统计了所有CPU上的时间。如果 CPU 是多核的，<code>User</code> + <code>sys</code> 可能会比自然流逝的绝对时间大</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">39.132</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">825.395</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][info ][gc,cpu            ] GC(<span class="number">1449</span>) <span class="keyword">User</span><span class="operator">=</span><span class="number">1.41</span>s Sys<span class="operator">=</span><span class="number">0.00</span>s <span class="type">Real</span><span class="operator">=</span><span class="number">0.11</span>s</span><br></pre></td></tr></table></figure>

<p>一般来说，如果看到 <code>real</code> 所显示的时间 远 大于 <code>User</code> + <code>sys</code>，表明 GC 过程存在某些问题（等待计算资源），原因可能是下面这两种：</p>
<ul>
<li>频繁的 IO 操作（让 GC 延迟）</li>
<li>缺乏 CPU 资源（GC 分配不到 CPU cycles）</li>
</ul>
<p>如果 <code>sys</code> 特别高，说明虚拟机没有得到足够的 CPU，主机的负载可能太高了。可能是 io、内存分配等方面出了问题；</p>
<ol start="5">
<li><strong>标签<code>gc,ergo</code>，<code>gc,ergo,cset</code>，<code>gc,ergo,ihop</code>，<code>gc,ergo,refine</code></strong></li>
</ol>
<p>这是 GC 自适应调节（ergonomics）相关的日志，记录了 GC 是如何自适应调节相关参数的。一般的 debug 级别信息就够了</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">39.439</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">825.702</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,ergo           ] GC(<span class="number">1450</span>) <span class="keyword">Running</span> G1 Clear Card <span class="keyword">Table</span> Task <span class="keyword">using</span> <span class="number">9</span> workers <span class="keyword">for</span> <span class="number">9</span> units <span class="keyword">of</span> work <span class="keyword">for</span> <span class="number">538</span> regions.</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">39.343</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">825.606</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,ergo,cset      ] GC(<span class="number">1450</span>) Finish choosing CSet. <span class="keyword">old</span>: <span class="number">0</span> regions, predicted <span class="keyword">old</span> region <span class="type">time</span>: <span class="number">0.00</span>ms, <span class="type">time</span> remaining: <span class="number">68.65</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.240</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">788.503</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,ergo,ihop      ] GC(<span class="number">1378</span>) Request concurrent <span class="keyword">cycle</span> initiation (occupancy higher than threshold) occupancy: <span class="number">12398362624</span>B allocation request: <span class="number">0</span>B threshold: <span class="number">11838003609</span>B (<span class="number">45.00</span>) source: <span class="keyword">end</span> <span class="keyword">of</span> GC</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.240</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">788.503</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,ergo,refine    ] GC(<span class="number">1378</span>) Updated Refinement Zones: green: <span class="number">82</span>, yellow: <span class="number">246</span>, red: <span class="number">410</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li><strong>标签<code>gc,heap</code>，<code>gc,heap,region</code></strong></li>
</ol>
<p><code>gc,heap</code>的 debug 级别会显示 gc 的时候堆的概况，对于 g1 gc <code>gc,heap,region</code>的 trace 级别，会打印每一个 region 的详细情况，这个一般供 gc 调试使用。</p>
<p>我们一般只需要关心<code>gc,heap</code>的日志就行了：关注年轻代和年老代堆回收前后的情况，观察 GC 效率、堆空间增长速度等。</p>
<blockquote>
<p>目前 System 面板较好的集成了该项日志信息，也推荐直接看 System 面板。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.240</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">788.503</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][info ][gc,heap           ] GC(<span class="number">1378</span>) Eden regions: <span class="number">251</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">0</span>(<span class="number">229</span>)</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.240</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">788.503</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][info ][gc,heap           ] GC(<span class="number">1378</span>) Survivor regions: <span class="number">32</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">35</span>(<span class="number">35</span>)</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.240</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">788.503</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][info ][gc,heap           ] GC(<span class="number">1378</span>) <span class="keyword">Old</span> regions: <span class="number">1040</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">1148</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.240</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">788.503</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][info ][gc,heap           ] GC(<span class="number">1378</span>) Humongous regions: <span class="number">334</span><span class="operator">-</span><span class="operator">&gt;</span><span class="number">330</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.240</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">788.503</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,heap           ] GC(<span class="number">1378</span>) Heap after GC invocations<span class="operator">=</span><span class="number">1343</span> (<span class="keyword">full</span> <span class="number">36</span>): garbage<span class="operator">-</span><span class="keyword">first</span> heap   total <span class="number">25690112</span>K, used <span class="number">12333688</span>K [<span class="number">0x00000001e0000000</span>, <span class="number">0x0000000800000000</span>)</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.240</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">788.503</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,heap           ] GC(<span class="number">1378</span>)   region size <span class="number">8192</span>K, <span class="number">35</span> young (<span class="number">286720</span>K), <span class="number">35</span> survivors (<span class="number">286720</span>K)</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.240</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">788.503</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,heap           ] GC(<span class="number">1378</span>)  Metaspace       used <span class="number">66936</span>K, capacity <span class="number">68918</span>K, committed <span class="number">69760</span>K, reserved <span class="number">1110016</span>K</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.240</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">788.503</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,heap           ] GC(<span class="number">1378</span>)   class space    used <span class="number">7554</span>K, capacity <span class="number">8389</span>K, committed <span class="number">8780</span>K, reserved <span class="number">1048576</span>K</span><br></pre></td></tr></table></figure>

<ol start="7">
<li><strong>标签<code>gc,humongous</code></strong></li>
</ol>
<p>如果使用的是 G1 gc，并且经常出现 Evacuation Failure 或者 Humongous Allocation ，并且不知道是什么原因的话，可以考虑看看这个标签相关的日志：</p>
<p>记载了大对象的分配情况和大对象 size。至于后面被哪个 remset 标记，在哪个 code root，如果不是调试 gc 的话一般不用关注</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.748</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">789.011</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,humongous      ] GC(<span class="number">1379</span>) Live humongous region <span class="number">0</span> object size <span class="number">22420064</span> <span class="keyword">start</span> <span class="number">0x00000001e0000000</span>  <span class="keyword">with</span> remset <span class="number">0</span> code roots <span class="number">0</span> <span class="keyword">is</span> marked <span class="number">0</span> reclaim candidate <span class="number">0</span> type <span class="keyword">array</span> <span class="number">1</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.748</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">789.011</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,humongous      ] GC(<span class="number">1379</span>) Live humongous region <span class="number">1052</span> object size <span class="number">22420064</span> <span class="keyword">start</span> <span class="number">0x00000003ee000000</span>  <span class="keyword">with</span> remset <span class="number">1</span> code roots <span class="number">0</span> <span class="keyword">is</span> marked <span class="number">0</span> reclaim candidate <span class="number">0</span> type <span class="keyword">array</span> <span class="number">1</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.748</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">789.011</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,humongous      ] GC(<span class="number">1379</span>) Live humongous region <span class="number">1057</span> object size <span class="number">22420064</span> <span class="keyword">start</span> <span class="number">0x00000003f0800000</span>  <span class="keyword">with</span> remset <span class="number">0</span> code roots <span class="number">0</span> <span class="keyword">is</span> marked <span class="number">0</span> reclaim candidate <span class="number">0</span> type <span class="keyword">array</span> <span class="number">1</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.748</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">789.011</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,humongous      ] GC(<span class="number">1379</span>) Live humongous region <span class="number">1065</span> object size <span class="number">22420064</span> <span class="keyword">start</span> <span class="number">0x00000003f4800000</span>  <span class="keyword">with</span> remset <span class="number">0</span> code roots <span class="number">0</span> <span class="keyword">is</span> marked <span class="number">0</span> reclaim candidate <span class="number">0</span> type <span class="keyword">array</span> <span class="number">1</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">02.748</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">789.011</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,humongous      ] GC(<span class="number">1379</span>) Live humongous region <span class="number">1070</span> object size <span class="number">8968208</span> <span class="keyword">start</span> <span class="number">0x00000003f7000000</span>  <span class="keyword">with</span> remset <span class="number">0</span> code roots <span class="number">0</span> <span class="keyword">is</span> marked <span class="number">0</span> reclaim candidate <span class="number">0</span> type <span class="keyword">array</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<ol start="8">
<li><strong>标签<code>gc,metaspace</code></strong></li>
</ol>
<p>查看 metaspace 相关的 gc 日志，<code>gc,metaspace</code>的 info 级别会输出每次 gc 涉及的 metaspace 内存变化。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">03.645</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">789.908</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][info ][gc,metaspace      ] GC(<span class="number">1381</span>) Metaspace: <span class="number">66936</span>K(<span class="number">69760</span>K)<span class="operator">-</span><span class="operator">&gt;</span><span class="number">66936</span>K(<span class="number">69760</span>K) NonClass: <span class="number">59381</span>K(<span class="number">60980</span>K)<span class="operator">-</span><span class="operator">&gt;</span><span class="number">59381</span>K(<span class="number">60980</span>K) Class: <span class="number">7554</span>K(<span class="number">8780</span>K)<span class="operator">-</span><span class="operator">&gt;</span><span class="number">7554</span>K(<span class="number">8780</span>K)</span><br></pre></td></tr></table></figure>

<ol>
<li><strong>标签<code>gc,phases</code>，<code>gc,phases,ref</code>，<code>gc,phases,task</code>，<code>gc,ref</code>，<code>gc,start</code>,<code>gc,ref,start</code>，<code>gc,task</code></strong> <strong>等</strong></li>
</ol>
<p>这些标签与 gc 步骤相关，详细记录了 GC 每步的耗时、软&#x2F;弱等各类引用处理等信息。可以查看这些标签的日志，来了解 gc 的步骤以及原理。</p>
<p><strong>一般可以通过该类日志查看 GC 在哪步耗时显著大，从而针对性优化。</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][info ][gc,phases         ] GC(<span class="number">1382</span>)   Pre Evacuate Collection <span class="keyword">Set</span>: <span class="number">0.1</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     <span class="keyword">Prepare</span> TLABs: <span class="number">0.0</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Choose Collection <span class="keyword">Set</span>: <span class="number">0.0</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Humongous Register: <span class="number">0.1</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][info ][gc,phases         ] GC(<span class="number">1382</span>)   Evacuate Collection <span class="keyword">Set</span>: <span class="number">144.4</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Ext Root Scanning (ms):   Min:  <span class="number">0.3</span>, Avg:  <span class="number">0.3</span>, Max:  <span class="number">0.5</span>, Diff:  <span class="number">0.3</span>, Sum:  <span class="number">4.3</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     <span class="keyword">Update</span> RS (ms):           Min:  <span class="number">4.0</span>, Avg: <span class="number">16.6</span>, Max: <span class="number">56.5</span>, Diff: <span class="number">52.5</span>, Sum: <span class="number">215.4</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)       Processed Buffers:        Min: <span class="number">3</span>, Avg: <span class="number">12.4</span>, Max: <span class="number">24</span>, Diff: <span class="number">21</span>, Sum: <span class="number">161</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)       Scanned Cards:            Min: <span class="number">767</span>, Avg: <span class="number">2468.7</span>, Max: <span class="number">4190</span>, Diff: <span class="number">3423</span>, Sum: <span class="number">32093</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)       Skipped Cards:            Min: <span class="number">0</span>, Avg:  <span class="number">0.4</span>, Max: <span class="number">1</span>, Diff: <span class="number">1</span>, Sum: <span class="number">5</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Scan RS (ms):             Min:  <span class="number">7.2</span>, Avg: <span class="number">34.5</span>, Max: <span class="number">62.1</span>, Diff: <span class="number">54.9</span>, Sum: <span class="number">448.7</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)       Scanned Cards:            Min: <span class="number">1501</span>, Avg: <span class="number">11120.2</span>, Max: <span class="number">21225</span>, Diff: <span class="number">19724</span>, Sum: <span class="number">144563</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)       Claimed Cards:            Min: <span class="number">1792</span>, Avg: <span class="number">13903.3</span>, Max: <span class="number">30483</span>, Diff: <span class="number">28691</span>, Sum: <span class="number">180743</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)       Skipped Cards:            Min: <span class="number">43974</span>, Avg: <span class="number">105456.0</span>, Max: <span class="number">143149</span>, Diff: <span class="number">99175</span>, Sum: <span class="number">1370928</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Code Root Scanning (ms):  Min:  <span class="number">0.0</span>, Avg:  <span class="number">0.0</span>, Max:  <span class="number">0.0</span>, Diff:  <span class="number">0.0</span>, Sum:  <span class="number">0.0</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     AOT Root Scanning (ms):   skipped</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Object <span class="keyword">Copy</span> (ms):         Min: <span class="number">71.7</span>, Avg: <span class="number">92.3</span>, Max: <span class="number">129.0</span>, Diff: <span class="number">57.3</span>, Sum: <span class="number">1199.7</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Termination (ms):         Min:  <span class="number">0.0</span>, Avg:  <span class="number">0.0</span>, Max:  <span class="number">0.0</span>, Diff:  <span class="number">0.0</span>, Sum:  <span class="number">0.0</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)       Termination Attempts:     Min: <span class="number">1</span>, Avg:  <span class="number">1.0</span>, Max: <span class="number">1</span>, Diff: <span class="number">0</span>, Sum: <span class="number">13</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     GC Worker Other (ms):     Min:  <span class="number">0.1</span>, Avg:  <span class="number">0.3</span>, Max:  <span class="number">0.6</span>, Diff:  <span class="number">0.6</span>, Sum:  <span class="number">4.5</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     GC Worker Total (ms):     Min: <span class="number">143.8</span>, Avg: <span class="number">144.1</span>, Max: <span class="number">144.3</span>, Diff:  <span class="number">0.5</span>, Sum: <span class="number">1873.1</span>, Workers: <span class="number">13</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][info ][gc,phases         ] GC(<span class="number">1382</span>)   Post Evacuate Collection <span class="keyword">Set</span>: <span class="number">1.4</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Code Roots Fixup: <span class="number">0.0</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Clear Card <span class="keyword">Table</span>: <span class="number">0.3</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Reference Processing: <span class="number">0.1</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)       Reconsider SoftReferences: <span class="number">0.0</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         SoftRef (ms):             skipped</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)       Notify Soft<span class="operator">/</span>WeakReferences: <span class="number">0.0</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.366</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         SoftRef (ms):             skipped</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         WeakRef (ms):             skipped</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         FinalRef (ms):            skipped</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         Total (ms):               skipped</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)       Notify <span class="keyword">and</span> keep alive finalizable: <span class="number">0.0</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         FinalRef (ms):            skipped</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)       Notify PhantomReferences: <span class="number">0.0</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         PhantomRef (ms):          Min:  <span class="number">0.0</span>, Avg:  <span class="number">0.0</span>, Max:  <span class="number">0.0</span>, Diff:  <span class="number">0.0</span>, Sum:  <span class="number">0.0</span>, Workers: <span class="number">1</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)       SoftReference:</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         Discovered: <span class="number">0</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         Cleared: <span class="number">0</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)       WeakReference:</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         Discovered: <span class="number">0</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         Cleared: <span class="number">0</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)       FinalReference:</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         Discovered: <span class="number">0</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         Cleared: <span class="number">0</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)       PhantomReference:</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         Discovered: <span class="number">2</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases,<span class="keyword">ref</span>     ] GC(<span class="number">1382</span>)         Cleared: <span class="number">2</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Weak Processing: <span class="number">0.1</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     <span class="keyword">Merge</span> <span class="keyword">Per</span><span class="operator">-</span>Thread State: <span class="number">0.0</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Code Roots Purge: <span class="number">0.0</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Redirty Cards: <span class="number">0.1</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     DerivedPointerTable <span class="keyword">Update</span>: <span class="number">0.0</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     <span class="keyword">Free</span> Collection <span class="keyword">Set</span>: <span class="number">0.3</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Humongous Reclaim: <span class="number">0.6</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     <span class="keyword">Start</span> <span class="keyword">New</span> Collection <span class="keyword">Set</span>: <span class="number">0.0</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Resize TLABs: <span class="number">0.0</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,phases         ] GC(<span class="number">1382</span>)     Expand Heap After Collection: <span class="number">0.0</span>ms</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">04.104</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">790.367</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][info ][gc,phases         ] GC(<span class="number">1382</span>)   Other: <span class="number">0.3</span>ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">08.433</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">794.696</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][info ][gc,<span class="keyword">start</span>          ] GC(<span class="number">1389</span>) Pause Young (Normal) (G1 Evacuation Pause)</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">08.433</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">794.696</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][info ][gc,task           ] GC(<span class="number">1389</span>) <span class="keyword">Using</span> <span class="number">13</span> workers <span class="keyword">of</span> <span class="number">13</span> <span class="keyword">for</span> evacuation</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">08.433</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">794.696</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,tlab           ] GC(<span class="number">1389</span>) TLAB totals: thrds: <span class="number">47</span>  refills: <span class="number">1704</span> max: <span class="number">181</span> slow allocs: <span class="number">56</span> max <span class="number">29</span> waste:  <span class="number">1.1</span><span class="operator">%</span> gc: <span class="number">15548672</span>B max: <span class="number">1563232</span>B slow: <span class="number">1233720</span>B max: <span class="number">197560</span>B fast: <span class="number">0</span>B max: <span class="number">0</span>B</span><br><span class="line">[<span class="number">2024</span><span class="number">-01</span><span class="number">-15</span>T15:<span class="number">23</span>:<span class="number">08.433</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">794.696</span>s][<span class="number">3381829</span>][<span class="number">3381900</span>][debug][gc,alloc,region   ] GC(<span class="number">1389</span>) Mutator Allocation stats, regions: <span class="number">180</span>, wasted size: <span class="number">0</span>B ( <span class="number">0.0</span><span class="operator">%</span>)</span><br></pre></td></tr></table></figure>

<ol start="9">
<li><strong>标签<code>safepoint</code></strong></li>
</ol>
<p>我们知道只有到达 safepoint，我们才可以进行 gc，如果我们对这些 safepoint 感兴趣，可以查看这个标签的 debug 级别的日志。</p>
<p>关于 safepoint 的解析、日志观测、调优，感兴趣的同学可以参考这篇文章：</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/161710652?spm=a2c6h.12873639.article-detail.15.7a8b1da3Hy4DoP">https://zhuanlan.zhihu.com/p/161710652?spm=a2c6h.12873639.article-detail.15.7a8b1da3Hy4DoP</a></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-12</span>T17:<span class="number">57</span>:<span class="number">57.360</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1388.942</span>s][<span class="number">558968</span>][<span class="number">559235</span>][info ][safepoint,stats  ] G1CollectForAllocation       [           <span class="number">1542</span>               <span class="number">3</span> ][           <span class="number">578703</span>     <span class="number">173202</span> <span class="number">13655482720</span> <span class="number">13656234625</span> ]               <span class="number">6</span></span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-12</span>T17:<span class="number">57</span>:<span class="number">57.360</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1388.942</span>s][<span class="number">558968</span>][<span class="number">559235</span>][info ][safepoint        ] Safepoint &quot;G1CollectForAllocation&quot;, <span class="type">Time</span> since <span class="keyword">last</span>: <span class="number">153683087494</span> ns, Reaching safepoint: <span class="number">578703</span> ns, Cleanup: <span class="number">173202</span> ns, <span class="keyword">At</span> safepoint: <span class="number">13655482720</span> ns, Total: <span class="number">13656234625</span> ns</span><br><span class="line"></span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.558</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ] # SafepointSynchronize::<span class="keyword">begin</span>: Timeout detected:</span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.558</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ] # SafepointSynchronize::<span class="keyword">begin</span>: Timed <span class="keyword">out</span> while spinning <span class="keyword">to</span> reach a safepoint.</span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.558</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ] # SafepointSynchronize::<span class="keyword">begin</span>: Threads which did <span class="keyword">not</span> reach the safepoint:</span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.558</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ] # &quot;Pipe-Async-Connector-Client-Pool-selector-299&quot; #<span class="number">299</span> daemon prio<span class="operator">=</span><span class="number">5</span> os_prio<span class="operator">=</span><span class="number">0</span> cpu<span class="operator">=</span><span class="number">24998.13</span>ms elapsed<span class="operator">=</span><span class="number">1435.09</span>s tid<span class="operator">=</span><span class="number">0x00007e63dc2e1d00</span> nid<span class="operator">=</span><span class="number">0x1deb7</span> runnable  [<span class="number">0x0000000000000000</span>]</span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.559</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ]    java.lang.Thread.State: RUNNABLE</span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.559</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ] </span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.559</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ] # &quot;pool-29-IoTDB-Pipe-Connector-Executor-Pool-69&quot; #<span class="number">1476</span> prio<span class="operator">=</span><span class="number">5</span> os_prio<span class="operator">=</span><span class="number">0</span> cpu<span class="operator">=</span><span class="number">18305.09</span>ms elapsed<span class="operator">=</span><span class="number">1320.80</span>s tid<span class="operator">=</span><span class="number">0x00007e63fc376ee0</span> nid<span class="operator">=</span><span class="number">0x1e842</span> runnable  [<span class="number">0x0000000000000000</span>]</span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.559</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ]    java.lang.Thread.State: RUNNABLE</span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.559</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ] </span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.559</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ] # &quot;pool-29-IoTDB-Pipe-Connector-Executor-Pool-81&quot; #<span class="number">1488</span> prio<span class="operator">=</span><span class="number">5</span> os_prio<span class="operator">=</span><span class="number">0</span> cpu<span class="operator">=</span><span class="number">17034.13</span>ms elapsed<span class="operator">=</span><span class="number">1320.80</span>s tid<span class="operator">=</span><span class="number">0x00007e63fc385400</span> nid<span class="operator">=</span><span class="number">0x1e84e</span> runnable  [<span class="number">0x0000000000000000</span>]</span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.559</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ]    java.lang.Thread.State: RUNNABLE</span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.559</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ] </span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.559</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ] # &quot;pool-26-IoTDB-ClientRPC-Processor-913&quot; #<span class="number">1564</span> prio<span class="operator">=</span><span class="number">5</span> os_prio<span class="operator">=</span><span class="number">0</span> cpu<span class="operator">=</span><span class="number">104459.15</span>ms elapsed<span class="operator">=</span><span class="number">1300.41</span>s tid<span class="operator">=</span><span class="number">0x00007e63e44113c0</span> nid<span class="operator">=</span><span class="number">0x1e8cb</span> runnable  [<span class="number">0x00007e5254478000</span>]</span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.559</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ]    java.lang.Thread.State: RUNNABLE</span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.559</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ] </span><br><span class="line">[<span class="number">2024</span><span class="number">-03</span><span class="number">-08</span>T11:<span class="number">10</span>:<span class="number">51.559</span><span class="operator">+</span><span class="number">0800</span>][<span class="number">1624.879</span>s][<span class="number">121648</span>][<span class="number">121979</span>][warning][safepoint         ] # SafepointSynchronize::<span class="keyword">begin</span>: (<span class="keyword">End</span> <span class="keyword">of</span> list)</span><br></pre></td></tr></table></figure>

<h3 id="GCEasy"><a href="#GCEasy" class="headerlink" title="GCEasy"></a>GCEasy</h3><p>非常强大的 GC 日志可视化分析报告，强大之处在于自动整合耗时、内存、cause、年龄等各类日志分析，并给出一些调优思路（实测不是特别靠谱，但可以参考）。</p>
<p>国外原版需收费。下面是国内镜像，实测免费：</p>
<p><a target="_blank" rel="noopener" href="https://gceasy.ycrash.cn/gc-index.jsp">https://gceasy.ycrash.cn/gc-index.jsp</a></p>
<h1 id="Java-大数据系统-JVM-调优建议"><a href="#Java-大数据系统-JVM-调优建议" class="headerlink" title="Java 大数据系统 JVM 调优建议"></a>Java 大数据系统 JVM 调优建议</h1><p>笔者还调研了 Spark、Hadoop、Alluxio、Hbase、Ratis 等大数据系统的 JVM 默认参数或调优建议，这里贴出提供了相关信息的项目。</p>
<h2 id="Spark"><a href="#Spark" class="headerlink" title="Spark"></a>Spark</h2><p>Spark 的目标是确保只有长寿的 RDD 存储在老年代，这样新生代便足以存放短命对象。这将有助于避免 fgc</p>
<p>Spark 建议：</p>
<ul>
<li>查看 GC 日志，如果一次 task 完成前产生了多次 fgc，说明进程内存不够了</li>
<li>如果 ygc 很多，而 fgc 不是很多，建议调高 eden 区的大小。eden 区的大小可以设置为稍大于每个 task 需要的内存。如果 eden 的大小为 <code>E</code>，那么可以设置 <code>-Xmn=4/3*E</code></li>
<li>如果观察 GC 日志，发现老年代接近满载，可以尝试从代码层面减少内存使用（<code>spark.memory.fraction</code>，这里不赘述）。此外，还可以减小新生代大小。如果已经减小过 <code>-Xmn</code>，可以试试 <code>NewRatio</code></li>
<li>如果 GC 成为瓶颈（这里没说是吞吐瓶颈还是延迟瓶颈，根据经验一般 G1 对付延迟瓶颈比较有效），可以尝试 G1。增大 G1 的 region size 可能很有用（<a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/articles/java/g1gc-1984535.html%EF%BC%89">http://www.oracle.com/technetwork/articles/java/g1gc-1984535.html）</a></li>
</ul>
<h2 id="HBase"><a href="#HBase" class="headerlink" title="HBase"></a>HBase</h2><p><strong>为了低延迟而调优：</strong></p>
<ul>
<li>使用 CMS collector: <code>-XX:+UseConcMarkSweepGC</code></li>
<li>尽可能调小年轻代大小. Example:<code>-XX:CMSInitiatingOccupancyFraction=70</code></li>
<li>为低时延而非高吞吐而调优: <code>-Xmn512m</code></li>
<li>使用并行收集 eden 的 gc: <code>-XX:+UseParNewGC</code></li>
<li>Avoid collection under pressure: <code>-XX:+UseCMSInitiatingOccupancyOnly</code></li>
<li>代码层面的调优：Limit per request scanner result sizing so everything fits into survivor space but doesn’t tenure. In <code>hbase-site.xml</code>, set <code>hbase.client.scanner.max.result.size</code> to 1&#x2F;8th of eden space (with -<code>Xmn512m</code> this is ~51MB )</li>
<li>代码层面的调优：Set <code>max.result.size</code> x <code>handler.count</code> less than survivor space</li>
</ul>
<p><strong>OS-Level 调优：</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/267846455">Turn transparent huge pages (THP)</a> off:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br></pre></td></tr></table></figure>

<ul>
<li>Set <code>vm.swappiness = 0</code>（禁用 swap）</li>
<li>Set <code>vm.min_free_kbytes</code> to at least 1GB (8GB on larger memory systems)（调整内存水位线）</li>
<li>Disable NUMA zone reclaim with <code>vm.zone_reclaim_mode = 0</code></li>
</ul>
<h1 id="典型案例"><a href="#典型案例" class="headerlink" title="典型案例"></a>典型案例</h1><p>贴出 9 个典型场景，并概述他们的场景、解决方案和效果</p>
<ol>
<li><strong>场景：</strong>针对 PS new + CMS 的 YGC 调优（主要是吞吐目标）</li>
</ol>
<p><strong>解决方案：</strong>调整 young 区大小、比例（优化 ygc 频率）；调整晋升年龄阈值（优化 ygc 耗时）；优化偏向锁（safepoint）（优化 ygc 耗时）</p>
<p><strong>效果：</strong>Young GC 的频率减少了大概 1&#x2F;3。GC 的吞量提高了 3.8%，达到了 96.8%</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/165382850">https://zhuanlan.zhihu.com/p/165382850</a></p>
<ol start="2">
<li>类似1，是 PS 针对 young 区大小的调优，找到合适的 young 和 old 区比例</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hilaryfrank/article/details/109598582">https://blog.csdn.net/hilaryfrank/article/details/109598582</a></p>
<ol start="3">
<li><strong>场景：</strong>Major GC 和 Minor GC 频繁（针对 CMS）</li>
</ol>
<p><strong>解决方案：</strong>调整 young 区大小，防止大量临时对象进入 old 区，让 ygc 更彻底。</p>
<p><strong>效果：</strong>通过扩容新生代为为原来的三倍，单次Minor GC时间增加小于5ms，频率下降了60%，服务响应时间TP90，TP99都下降了10ms+，服务可用性得到提升。</p>
<ol start="4">
<li><strong>场景：</strong>请求高峰期发生GC，导致服务可用性下降（针对 CMS）</li>
</ol>
<p><strong>解决方案：</strong>设法让 CMS 在 Remark 前执行一次 ygc，使得新生代的对象数量减少，进而减少 remark 工作量</p>
<p><strong>效果：</strong>通过扩容新生代为为原来的三倍，单次Minor GC时间增加小于5ms，频率下降了60%，服务响应时间TP90，TP99都下降了10ms+，服务可用性得到提升。</p>
<ol start="5">
<li><strong>场景：</strong>发生 Stop-The-World 的 GC（针对 CMS）</li>
</ol>
<p><strong>解决方案：</strong>固定 Perm 区大小，防止 Perm 扩容导致的 fgc</p>
<p><strong>效果：</strong>调整参数后，服务不再有 Perm 区扩容导致的 STW GC 发生</p>
<p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2017/12/29/jvm-optimize.html">https://tech.meituan.com/2017/12/29/jvm-optimize.html</a></p>
<ol start="6">
<li><strong>场景：</strong>年轻代对象晋升过早，大部分对象在 1 岁时便晋升，导致 old 区增长速度过快</li>
</ol>
<p><strong>解决方案：</strong>通过 <code>-XX:SurvivorRatio</code> 扩容 survivor 区</p>
<p><strong>效果：</strong>调整参数后，再也没有切量后长暂停的问题了，Young GC 稳定在 30-100ms，成功解决</p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000044467479">https://segmentfault.com/a/1190000044467479</a></p>
<ol start="7">
<li><strong>场景：</strong>G1 Reference Process 环节中：软引用处理时间过长</li>
</ol>
<p><strong>解决方案：</strong>调整参数 <code>-XX:+ParallelRefProcEnabled</code>、<code>-XX:SoftRefLRUPolicyMSPerMB=0</code>，并优化代码减少 Finialize 对象。</p>
<p><strong>效果：</strong>mixed gc 稳定到 85ms，耗时大幅降低</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/463122674">https://zhuanlan.zhihu.com/p/463122674</a></p>
<ol start="8">
<li><strong>场景：</strong>G1 GC 的日志出现 to-space exhausted 问题</li>
</ol>
<p><strong>解决方案：</strong>增大 GC 的速度，使其超过垃圾增长的速度：让G1更早得启动混合式垃圾收集周期，调小 <code>-XX:InitiatingHeapOccupancyPercent</code>；增加每次混合式垃圾收集收集的Old分区数量，调整<code>-XX:G1MixedGCCountTarget</code>；</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/79643783">https://zhuanlan.zhihu.com/p/79643783</a></p>
<ol start="9">
<li><strong>场景：</strong>Young GC 耗时一直居高不下，更重要的是 Old 区的最大使用量与日递增</li>
</ol>
<p><strong>解决方案：</strong>调大 heapRegionSize</p>
<p><strong>效果：</strong>将 Region 大小调到 16M 或者 32M 时，GC 情况会有明显的好转</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0955113a12db">https://www.jianshu.com/p/0955113a12db</a></p>
<h1 id="补充附录"><a href="#补充附录" class="headerlink" title="补充附录"></a>补充附录</h1><h2 id="GC-VM-参数是否支持热修改？"><a href="#GC-VM-参数是否支持热修改？" class="headerlink" title="GC VM 参数是否支持热修改？"></a>GC VM 参数是否支持热修改？</h2><p><strong>结论：</strong>只有极少部分<strong>【managable】</strong>的参数才可以被热修改。这部分参数大多不是我们 GC 调优常用的，<strong>因此 GC 目前还是依赖冷调优。</strong></p>
<ol>
<li>根据 <a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/jinfo.html#GUID-69246B58-28C4-477D-B375-278F5F9830A5">oracle </a>官网，<code>jinfo</code> 命令可以实现<strong>部分参数</strong>热修改。且只有被标记为<strong>【managable】</strong>的参数才可以被热修改</li>
</ol>
<ul>
<li>具体语法如下：</li>
</ul>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164237934.png" alt="image-20240401164237934"></p>
<p>比如 JDK8 下，我们可以通过 jinfo 命令热修改 <code>-XX:PrintGC</code> 参数</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">jinfo <span class="operator">-</span>flag <span class="operator">+</span>PrintGC pid</span><br></pre></td></tr></table></figure>

<ol>
<li><strong>那么哪些参数是 managable 的呢？</strong></li>
</ol>
<p>所有的 JVM 中 manageable 的参数可以从 openjdk 源码（<a target="_blank" rel="noopener" href="https://github.com/openjdk/jdk/blob/master/src/hotspot/share/runtime/globals.hpp">openjdk .&#x2F;hotspot&#x2F;src&#x2F;share&#x2F;vm&#x2F;runtime&#x2F;globals.hpp</a>）中获取</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164300666.png" alt="image-20240401164300666"></p>
<p>也可以通过 console 命令<code>java -XX:+PrintFlagsFinal -version | grep &quot;manageable&quot; </code>获得：</p>
<p>JDK8：</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164311823.png" alt="image-20240401164311823"></p>
<p>JDK11：</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164328950.png" alt="image-20240401164328950"></p>
<p>JDK17：</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164337903.png" alt="image-20240401164337903"></p>
<h2 id="不同发行商-JDK-的参数效果相同吗？"><a href="#不同发行商-JDK-的参数效果相同吗？" class="headerlink" title="不同发行商 JDK 的参数效果相同吗？"></a>不同发行商 JDK 的参数效果相同吗？</h2><p>所有发行商的 JDK 都是基于开源的 <a target="_blank" rel="noopener" href="https://github.com/openjdk/jdk">openjdk</a>  进行修改，因此在 VM options 上都保证了向后兼容，<strong>可以放心使用。</strong></p>
<blockquote>
<p>👉 使用 oracle、openjdk、correto 三款最常用的 JDK 进行验证，常用的参数均能 work</p>
</blockquote>
<h2 id="设置矛盾效果的-GC-参数，JVM-如何表现？"><a href="#设置矛盾效果的-GC-参数，JVM-如何表现？" class="headerlink" title="设置矛盾效果的 GC 参数，JVM 如何表现？"></a>设置矛盾效果的 GC 参数，JVM 如何表现？</h2><p><strong>结论：</strong>如果 <code>-XX:MaxGCPauseMillis</code> 和 <code>-XX:GCTimeRatio</code> 设置产生的效果发生矛盾，会一定程度影响 GC 的表现</p>
<p>实验数据敏感，在此省略。</p>
<h2 id="XX-AlwaysPreTouch-对启动性能的影响"><a href="#XX-AlwaysPreTouch-对启动性能的影响" class="headerlink" title="-XX:+AlwaysPreTouch 对启动性能的影响"></a>-XX:+AlwaysPreTouch 对启动性能的影响</h2><p><strong>AlwaysPreTouch 对 IoTDB 启动性能影响的实验：</strong></p>
<ol>
<li>环境：M2 pro 16G JDK 8&#x2F;11</li>
</ol>
<ul>
<li>ConfigNode：1068ms（加 AlwaysPreTouch）</li>
<li>DataNode：1369ms（加 AlwaysPreTouch）</li>
<li>ConfigNode：999ms（不加 AlwaysPreTouch）</li>
<li>DataNode：1374ms（不加 AlwaysPreTouch）</li>
</ul>
<ol start="2">
<li>环境： 32G JDK 8</li>
</ol>
<ul>
<li>ConfigNode：1044ms（加 AlwaysPreTouch）</li>
<li>DataNode：1349ms（加 AlwaysPreTouch）</li>
<li>ConfigNode：1031ms（不加 AlwaysPreTouch）</li>
<li>DataNode：1430ms（不加 AlwaysPreTouch）</li>
</ul>
<ol start="3">
<li>环境：Ubuntu 754G JDK11</li>
</ol>
<ul>
<li>DataNode：大约 1-2 s（不加 AlwaysPreTouch）</li>
<li>DataNode：大约 20+ s（加 AlwaysPreTouch）</li>
</ul>
<p><strong>结论：</strong></p>
<ol>
<li>AlwaysPreTouch 在常见的小内存场景下对启动的影响不大，但在大内存场景下会显著延长启动时间</li>
<li>AlwaysPreTouch 主要能提高启动初期的性能，对启动中后期的性能影响不大。因为应用运行初期内存未完全分配，可能会有一些分配内存的开销；但随着应用的运行，当内存已经被 OS 完全分配时，该参数理论上已无优化效果。</li>
<li><strong>对用户来说，启动时间短比启动期间的性能更重要，且用户可以不感知此参数，因此建议该参数不用默认打开</strong></li>
</ol>
<h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/index.html">https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/index.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.oracle.com/technical-resources/articles/java/g1gc.html">https://www.oracle.com/technical-resources/articles/java/g1gc.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/index.html">https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/index.html</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/">https://docs.oracle.com/en/java/javase/17/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/">https://docs.oracle.com/en/java/javase/11/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/">https://docs.oracle.com/javase/8/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html#BABFAFAE">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html#BABFAFAE</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/gctuning/garbage-first-garbage-collector-tuning.html#GUID-379B3888-FE24-4C3F-9E38-26434EB04F89">https://docs.oracle.com/en/java/javase/11/gctuning/garbage-first-garbage-collector-tuning.html#GUID-379B3888-FE24-4C3F-9E38-26434EB04F89</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/java.html#GUID-3B1CE181-CD30-4178-9602-230B800D4FAE__BABFAFAE">https://docs.oracle.com/en/java/javase/11/tools/java.html#GUID-3B1CE181-CD30-4178-9602-230B800D4FAE__BABFAFAE</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html#advanced-garbage-collection-options-for-java">https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html#advanced-garbage-collection-options-for-java</a></p>
<p><a target="_blank" rel="noopener" href="https://masteranyfield.com/2021/05/13/gcs-of-jvm-tuning-pspo-vs-cms-vs-g1/">https://masteranyfield.com/2021/05/13/gcs-of-jvm-tuning-pspo-vs-cms-vs-g1/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.oracle.com/technical-resources/articles/javame/garbagecollection2.html">https://www.oracle.com/technical-resources/articles/javame/garbagecollection2.html</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/parallel.html">https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/parallel.html</a></p>
<p><a target="_blank" rel="noopener" href="https://xie.infoq.cn/article/317ccdfabd7694a093925f7fe">https://xie.infoq.cn/article/317ccdfabd7694a093925f7fe</a></p>
<p><a target="_blank" rel="noopener" href="https://sematext.com/blog/java-garbage-collection-tuning/#starting-gc-tuning">https://sematext.com/blog/java-garbage-collection-tuning/#starting-gc-tuning</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/161710652?spm=a2c6h.12873639.article-detail.15.7a8b1da3cPF1W0">https://zhuanlan.zhihu.com/p/161710652?spm=a2c6h.12873639.article-detail.15.7a8b1da3cPF1W0</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/978505">https://developer.aliyun.com/article/978505</a></p>
<p><a target="_blank" rel="noopener" href="http://www.yishuifengxiao.com/2023/10/12/%E4%BB%8E%E9%9B%B6%E7%90%86%E8%A7%A3java%E4%B9%8B%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E4%B8%8E%E5%9B%9E%E6%94%B6/">http://www.yishuifengxiao.com/2023/10/12/%E4%BB%8E%E9%9B%B6%E7%90%86%E8%A7%A3java%E4%B9%8B%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E4%B8%8E%E5%9B%9E%E6%94%B6/</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/111886882">https://zhuanlan.zhihu.com/p/111886882</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/senlinyang/p/8717611.html">https://www.cnblogs.com/senlinyang/p/8717611.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lindev/articles/15467748.html">https://www.cnblogs.com/lindev/articles/15467748.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/feiyanaffection/article/details/124019544">https://blog.csdn.net/feiyanaffection/article/details/124019544</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hongdada/p/14578950.html">https://www.cnblogs.com/hongdada/p/14578950.html</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/628682897">https://zhuanlan.zhihu.com/p/628682897</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/67232199/how-to-reduce-time-taken-on-threads-reaching-safepoint-sync-state">https://stackoverflow.com/questions/67232199/how-to-reduce-time-taken-on-threads-reaching-safepoint-sync-state</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7068858769706319879">https://juejin.cn/post/7068858769706319879</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039411521">https://segmentfault.com/a/1190000039411521</a></p>
<p><a target="_blank" rel="noopener" href="https://hesey.wang/2018/11/gc-oriented-java-programming.html#comments">https://hesey.wang/2018/11/gc-oriented-java-programming.html#comments</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7109664057002557470#heading-11">https://juejin.cn/post/7109664057002557470#heading-11</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/193037071">https://zhuanlan.zhihu.com/p/193037071</a></p>

  </div>
  
    
      <a id="older" class="blog-nav" href="/article/Java-Memory/">OLDER&nbsp;&gt;</a>
      
        
          <a id="newer" class="blog-nav" href="/article/GC-prefered-coding/">&lt;&nbsp;NEWER</a>
          
            
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/Pengzna">Copyright © Pengzna 2021-present</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          <!-- <span class="search-icon-input">
            <a href="javascript: void(0)">
              <i class="iconfont icon-search"></i>
            </a>
          </span> -->
          
            <input type="text" class="search-input" id="search-input" placeholder="搜索">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)">
              <i class="iconfont icon-close"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    // inputArea.onclick = function() {
    //   getSearchFile()
    //   this.onclick = null
    // }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        inputArea.focus()
        getSearchFile()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'><span></ul>";
      // $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'><h2>" + orig_data_title + "</h2></a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<h3 class=\"search-result-abstract\">" + match_content + "...</h3>"
                }
                str += "<hr></li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/leedom92/hexo-theme-leedom#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </body>
</html>

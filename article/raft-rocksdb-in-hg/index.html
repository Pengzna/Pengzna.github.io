<!DOCTYPE html>
<html lang="en">

  <head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="Pengzna,blog" />
  <meta name="author" content="Pengzna" />
  <meta name="description" content="Pengzna çš„åšå®¢" />
  
  
  <title>
    
      Raft + RocksDB æ¶æ„åŠå…¶åœ¨ Apache Hugegraph åˆ†å¸ƒå¼å­˜å‚¨ä¸­çš„è¿ç”¨ 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto:400,400italic,600|Roboto+Mono" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


<meta name="generator" content="Hexo 7.0.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>


  <body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="app">
      <div class="header">
  <a href="/">Pengzna's blog ğŸ‘‹</a>
</div>


      <p class="links">
  
    <a title="archives" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="github" target="_blank" href="https://github.com/Pengzna">
      <i class="iconfont icon-github"></i>
    </a>
  
    <a title="email" target="_blank" href="mailto:junzhi.pengzna@gmail.com">
      <i class="iconfont icon-envelope"></i>
    </a>
  
    <a title="linkedin" target="_blank" href="https://www.linkedin.com/in/pengzna/">
      <i class="iconfont icon-linkedin"></i>
    </a>
  
    <a title="wechat" target="_blank" href="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20231115013033249.png">
      <i class="iconfont icon-wechat"></i>
    </a>
  
</p>


      <div class="main">
        <!-- æ–‡ç« è¯¦æƒ…é¡µï¼Œå±•ç¤ºæ–‡ç« å…·ä½“å†…å®¹ï¼Œurlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
<!-- åŒæ—¶ä¸ºã€Œæ ‡ç­¾tagã€ï¼Œã€Œæœ‹å‹friendã€ï¼Œã€Œåˆ†ç±»categoriesã€ï¼Œã€Œå…³äºaboutã€é¡µé¢çš„æ‰¿è½½é¡µé¢ï¼Œå…·ä½“å±•ç¤ºå–å†³äºpage.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>

<div class="post">
  <h3 class="date">
    Apr 01, 2024
  </h3>
  <h1>
    Raft + RocksDB æ¶æ„åŠå…¶åœ¨ Apache Hugegraph åˆ†å¸ƒå¼å­˜å‚¨ä¸­çš„è¿ç”¨
  </h1>
  <div class="content markdown-body">
    <blockquote>
<p> RAFT åŠ  RocksDB å·²ç»é€æ¸æˆä¸ºåˆ†å¸ƒå¼ KV é¢†åŸŸçš„ä¸€ç§æ™®é€‚æ€§æ¶æ„ï¼Œé€šè¿‡æ•´åˆ RAFT log è¿˜æœ‰rocksdb çš„ WAL å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½æ•°æ®çš„å†™æ”¾å¤§é—®é¢˜ã€‚ç›®å‰è¯¥éƒ¨ç½²æ–¹å¼çš„åº”ç”¨åœºæ™¯ä¹Ÿæ¯”è¾ƒå¹¿æ³›ï¼Œè€³ç†Ÿèƒ½è¯¦çš„æ¯”å¦‚ TiKVã€NebulaGraph è¿˜æœ‰ç¾å›¢çš„ Cellarï¼Œåœ¨éƒ¨ç½²æ–¹å¼çš„é€‰æ‹©ä¸Šä¸»è¦æ˜¯åŸºäº share nothing æ¶æ„ï¼Œå…¶ä¸­ RocksDB å……å½“äº† RAFT çŠ¶æ€æœºçš„è§’è‰²ã€‚</p>
</blockquote>
<p>Apache Hugegraph ä»Šå¹´ä¹Ÿåœ¨æ„å»ºåˆ†å¸ƒå¼æ¶æ„ï¼Œå…¶ä¸­ store å­˜å‚¨æ¨¡å—åŸºäº Raft + RocksDB å‘ Hugegraph Server æä¾›åˆ†å¸ƒå¼å­˜å‚¨æœåŠ¡ï¼Œä»¥è¾¾åˆ°å­˜ç®—åˆ†ç¦»çš„ç›®çš„ã€‚</p>
<p>è¿‘æœŸç¬”è€…åœ¨ Apache Hugegraph ç¤¾åŒºåšäº†ä¸€æ¬¡ç›¸å…³åˆ†äº«ï¼Œä»¥ä¸‹ä¸ºè„±æ•åçš„å†…å®¹ã€‚</p>
<h1 id="çŸ¥è¯†èƒŒæ™¯"><a href="#çŸ¥è¯†èƒŒæ™¯" class="headerlink" title="çŸ¥è¯†èƒŒæ™¯"></a>çŸ¥è¯†èƒŒæ™¯</h1><h2 id="RocksDB"><a href="#RocksDB" class="headerlink" title="RocksDB"></a>RocksDB</h2><h3 id="åŸºæœ¬ä»‹ç»"><a href="#åŸºæœ¬ä»‹ç»" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h3><ol>
<li><a target="_blank" rel="noopener" href="https://github.com/facebook/rocksdb">RocksDB</a> æ˜¯ Facebook å¼€å‘çš„ä¸€æ¬¾é«˜æ€§èƒ½ C++ KV å­˜å‚¨å¼•æ“ï¼Œåº•å±‚åŸºäº LSM Tree<strong>ï¼Œå…¶é”®å€¼å‡å…è®¸ä½¿ç”¨äºŒè¿›åˆ¶æµã€‚</strong><ol>
<li>å®ƒçš„å‰èº«æ˜¯é‡å†™è‡ª <a target="_blank" rel="noopener" href="https://github.com/google/leveldb">LevelDB</a> (ä¹Ÿå°±æ˜¯å¤§åé¼é¼çš„ Google æŠ€æœ¯å…ƒè€ Jeff Dean åœ¨å‘å¸ƒ GFS&#x2F;BigTale åçš„ C++ å®ç°)</li>
<li>Rocksdb <a target="_blank" rel="noopener" href="https://github.com/facebook/rocksdb/wiki">å®˜æ–¹ WIK</a>I ç®—æ˜¯æœ€å¥½çš„å‚è€ƒèµ„æ–™ä¹‹ä¸€, å¯¹æ ¸å¿ƒç‰¹æ€§éƒ½æœ‰æ¯”è¾ƒå¥½çš„è§£è¯»</li>
</ol>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/facebook/rocksdb/wiki/RocksJava-Basics">RocksJava</a> æ˜¯ä¸ºäº†ç»™ RocksDB æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ï¼Œä½†æ˜¯æ˜“ç”¨çš„ java é©±åŠ¨çš„å·¥ç¨‹, å®ƒç”± 3 å±‚æ„æˆï¼š<ol>
<li>org.rocksdb åŒ…é‡Œé¢çš„ Java ç±»ï¼Œæ„æˆ RocksJava APIã€‚Java ç”¨æˆ·åªä¼šç›´æ¥æ¥è§¦åˆ°è¿™ä¸€å±‚ã€‚</li>
<li>C++ çš„ JNI ä»£ç ï¼Œæä¾› Java API å’Œ RocksDB ä¹‹é—´çš„é“¾æ¥ã€‚</li>
<li>C++ å±‚çš„ RocksDB æœ¬èº«ï¼Œå¹¶ä¸”ç¼–è¯‘æˆäº†ä¸€ä¸ª native åº“ï¼Œè¢« JNI å±‚ä½¿ç”¨ã€‚</li>
</ol>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.rocksdb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocksdbjni<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>x.x.x<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>RocksJava ç”Ÿæˆçš„æ–‡ä»¶</li>
</ol>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164704333.png" alt="image-20240401164704333"></p>
<ul>
<li>xxx.logï¼š(æ—¥å¿—) WAL æ–‡ä»¶</li>
<li>xxx.sstï¼šæ•°æ®æ–‡ä»¶</li>
<li>CURRENTï¼šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ï¼Œç”¨äºå£°æ˜æœ€æ–°çš„manifestæ—¥å¿—æ–‡ä»¶</li>
<li>IDENTITYï¼šid</li>
<li>LOCKï¼šæ— å†…å®¹ï¼Œopen æ—¶åˆ›å»ºï¼Œè¡¨ç¤ºä¸€ä¸ª db åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­åªèƒ½è¢« open ä¸€æ¬¡ï¼Œå¤šçº¿ç¨‹å…±ç”¨æ­¤å®ä¾‹</li>
<li>LOGï¼š(ä¸»)ç»Ÿè®¡æ—¥å¿—</li>
<li>MANIFESTï¼šæŒ‡ä¸€ä¸ªç‹¬ç«‹çš„æ—¥å¿—æ–‡ä»¶ï¼Œå®ƒåŒ…å« RocksDB çš„çŠ¶æ€å¿«ç…§&#x2F;ç‰ˆæœ¬</li>
<li>OPTIONSï¼šé…ç½®ä¿¡æ¯</li>
</ul>
<h3 id="ç»å…¸æœ¯è¯­"><a href="#ç»å…¸æœ¯è¯­" class="headerlink" title="ç»å…¸æœ¯è¯­"></a>ç»å…¸æœ¯è¯­</h3><blockquote>
<p>ç†è§£ç»å…¸å®šä¹‰ä¸åªæ˜¯å¸®æˆ‘ä»¬ç†è§£ LSM çš„è®¾è®¡, æ›´æ˜¯å¸®æˆ‘ä»¬ç†è§£ä»å†…å­˜ -&gt; ç£ç›˜, ä»é€»è¾‘-&gt;ç‰©ç†è§†å›¾ä¸Š, ä¸ºä½•è¦å¼•å…¥è¿™äº›æ¦‚å¿µ, æ›´å¥½çš„ç†è§£å’Œä¼ ç»Ÿ B-Tree çš„åŒºåˆ«</p>
</blockquote>
<ol>
<li><strong>Column Familyï¼ˆåˆ—æ—ï¼‰</strong></li>
</ol>
<p>åœ¨ RocksDB 3.0ï¼Œå¢åŠ äº† Column Families çš„æ”¯æŒã€‚å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š<strong>CF çº¦ç­‰äºæˆ‘ä»¬ç†Ÿæ‚‰çš„ Table</strong></p>
<p>RocksDB çš„æ¯ä¸ªé”®å€¼å¯¹éƒ½ä¸å”¯ä¸€ä¸€ä¸ªåˆ—æ—ï¼ˆcolumn familyï¼‰ç»“åˆã€‚å¦‚æœæ²¡æœ‰æŒ‡å®š Column Familyï¼Œ<strong>é”®å€¼å¯¹å°†ä¼šç»“åˆåˆ°â€œdefaultâ€ åˆ—æ—ã€‚</strong>RocksDB åœ¨å¼€å¯ WAL çš„æ—¶å€™ä¿è¯å³ä½¿crashï¼Œåˆ—æ—çš„æ•°æ®ä¹Ÿèƒ½ä¿æŒä¸€è‡´æ€§ã€‚é€šè¿‡ WriteBatch APIï¼Œè¿˜å¯ä»¥å®ç°è·¨åˆ—æ—çš„åŸå­æ“ä½œã€‚</p>
<p>åˆ—æ—æä¾›äº†ä¸€ç§ä»é€»è¾‘ä¸Šç»™æ•°æ®åº“åˆ†ç‰‡çš„æ–¹æ³•ã€‚å®ƒçš„ä¸€äº›æœ‰è¶£çš„ç‰¹æ€§åŒ…æ‹¬ï¼š</p>
<ul>
<li>æ”¯æŒè·¨åˆ—æ—åŸå­å†™ã€‚æ„å‘³ç€ä½ å¯ä»¥åŸå­æ‰§è¡ŒWrite({cf1, key1, value1}, {cf2, key2, value2})ã€‚</li>
<li>è·¨åˆ—æ—çš„ä¸€è‡´æ€§è§†å›¾ã€‚</li>
<li>å…è®¸å¯¹ä¸åŒçš„åˆ—æ—è¿›è¡Œä¸åŒçš„é…ç½®</li>
<li>å³æ—¶æ·»åŠ ï¼åˆ é™¤åˆ—æ—ã€‚ä¸¤ä¸ªæ“ä½œéƒ½æ˜¯éå¸¸å¿«çš„ã€‚</li>
</ul>
<p>ç®€å•çš„è¯´ï¼Œä¸åŒçš„åˆ—æ—æ˜¯å…±äº« WAL çš„ï¼ˆä»è€Œä¿è¯è·¨åˆ—æ—åŸå­å†™ï¼‰ï¼Œä½†æ˜¯ memtable å’Œ SSTable æ˜¯éš”ç¦»çš„ã€‚</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164714015.png" alt="image-20240401164714015"></p>
<ol start="2">
<li><strong>Column (åˆ—)</strong></li>
</ol>
<ul>
<li>ä¼ ç»Ÿçš„ã€Œåˆ—å­˜ã€å’Œã€Œè¡Œå­˜ã€<ul>
<li>è¡Œå­˜ï¼ˆå¸¸ç”¨äº OLTPï¼‰å¯¹åº”å·¦è¾¹ï¼Œåˆ—å­˜ï¼ˆå¸¸ç”¨äº OLAPï¼‰å¯¹åº”å³è¾¹</li>
</ul>
</li>
</ul>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164728893.png" alt="image-20240401164728893"></p>
<ul>
<li>ä»¥ Hbase ä¸ºä¾‹ï¼Œè™½ç„¶å®ƒçš„å®˜ç½‘å†™ç€ï¼š<em>HBase is a</em> column-oriented <em>database management systemã€‚</em>ä½†æ˜¯ RocksDB&#x2F;Hbase å…¶å®ä¸æ˜¯ä¸Šè¿°çš„ã€Œåˆ—å­˜ã€ï¼Œä»¥ Hbase ä¸ºä¾‹ï¼š</li>
</ul>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164739729.png" alt="image-20240401164739729"></p>
<p>å‡å¦‚æœ‰è¿™ä¹ˆä¸€å¼  HBase è¡¨ï¼Œå®ƒçš„åº•å±‚å­˜å‚¨å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164749235.png" alt="image-20240401164749235"></p>
<p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼š</p>
<ul>
<li>ä¸åŒçš„åˆ—æ—å­˜åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ï¼ˆä¸Šé¢ä¸¤ä¸ªè¡¨æ ¼ä»£è¡¨ä¸åŒçš„ HFileï¼‰ï¼›</li>
<li>æ•´ä¸ªæ•°æ®æ˜¯æŒ‰ç…§ Rowkey è¿›è¡Œå­—å…¸æ’åºçš„ï¼›</li>
<li>æ¯ä¸€åˆ—æ•°æ®åœ¨åº•å±‚ HFile ä¸­æ˜¯ä»¥ KV å½¢å¼å­˜å‚¨çš„ï¼›</li>
<li>ç›¸åŒçš„ä¸€è¡Œæ•°æ®ä¸­ï¼Œå¦‚æœåˆ—æ—ä¹Ÿä¸€æ ·ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®æ˜¯é¡ºåºæ”¾åœ¨ä¸€èµ·çš„ã€‚</li>
</ul>
<p>åˆ°è¿™é‡Œå¤§å®¶åº”è¯¥å¯ä»¥çœ‹åˆ°ï¼Œ<strong>HBase å…¶å®ä¸æ˜¯åˆ—å¼æ•°æ®åº“</strong>ï¼Œå› ä¸ºåŒä¸€è¡Œæ•°æ®ï¼Œå¦‚æœåˆ—æ—ä¹Ÿä¸€æ ·ï¼Œè¿™äº›æ•°æ®æ˜¯å­˜å‚¨åœ¨ç›¸é‚»ä½ç½®çš„ï¼›è¿™å’Œä¸Šé¢çš„åˆ—å¼å­˜å‚¨ä¸å¤ªä¸€æ ·ã€‚æ‰€ä»¥è¯´ï¼ŒHBase æ—¢ä¸åƒè¡Œå¼å­˜å‚¨ï¼Œåˆä¸åƒåˆ—å¼å­˜å‚¨ã€‚å®ƒå…¶å®æ›´åƒæ˜¯é¢å‘åˆ—æ—çš„å­˜å‚¨æ•°æ®åº“ï¼Œå› ä¸ºä¸åŒè¡Œç›¸åŒçš„åˆ—æ—æ•°æ®æ˜¯ç›¸é‚»å­˜å‚¨çš„ï¼›è€ŒåŒä¸€è¡Œä¸åŒåˆ—æ—çš„æ•°æ®æ˜¯å­˜å‚¨åœ¨ä¸åŒä½ç½®çš„ã€‚</p>
<p><strong>RocksDB åŒç†ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹ RocksDB åº•å±‚çš„ SSTable ç»“æ„ï¼š</strong>ï¼ˆSSTable çš„æ¦‚å¿µå¯ä»¥å‚è€ƒ ddia ç¬¬ä¸‰ç« ï¼š<a target="_blank" rel="noopener" href="https://vonng.gitbooks.io/ddia-cn/content/ch3.html%EF%BC%89">https://vonng.gitbooks.io/ddia-cn/content/ch3.htmlï¼‰</a></p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164802092.png" alt="image-20240401164802092"></p>
<p>é‡ç‚¹çœ‹ä¸€ä¸‹ Data Blockï¼šdata block <strong>é¡ºåºå­˜å‚¨</strong> key&#x2F;valueï¼Œå¯¹äºå•ä¸ª block ä¼šä¿å­˜5ä¸ªæ•°å€¼</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Entry</span> &#123;</span><br><span class="line">  varint sharedKeyLength;</span><br><span class="line">  varint unsharedKeyLength;</span><br><span class="line">  varint valueLength;</span><br><span class="line">  byte[] unsharedKeyContent;</span><br><span class="line">  byte[] valueContent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DataBlock</span> &#123;</span><br><span class="line">  Entry[] entries;</span><br><span class="line">  int32 [] restartPointOffsets;</span><br><span class="line">  int32 restartPointCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¬¬ä¸€éƒ¨åˆ† Entry ç”¨æ¥å­˜å‚¨ key-value æ•°æ®ã€‚ç”±äº sstable ä¸­æ‰€æœ‰çš„ key-value å¯¹éƒ½æ˜¯<strong>ä¸¥æ ¼æŒ‰åºå­˜å‚¨</strong>çš„ï¼Œç”¨äº†èŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œå¹¶ä¸ä¼šä¸ºæ¯ä¸€å¯¹ key-value å¯¹éƒ½å­˜å‚¨å®Œæ•´çš„ key å€¼ï¼Œè€Œæ˜¯å­˜å‚¨ä¸ä¸Šä¸€ä¸ª key éå…±äº«çš„éƒ¨åˆ†ï¼Œé¿å…äº† key é‡å¤å†…å®¹çš„å­˜å‚¨ã€‚æ¯”å¦‚  â€œthe carâ€ å’Œ â€œthe colorâ€ ç›¸åŒçš„éƒ¨åˆ† â€œtheâ€œï¼Œä¸ºäº†èŠ‚çœç©ºé—´ï¼Œé‚£ä¹ˆ key+1 å¼€å§‹ï¼Œåªè®°å½•key ä¸åŒçš„éƒ¨åˆ†ï¼Œä¾‹å¦‚ï¼šâ€olorâ€</li>
<li><a href="https://link.zhihu.com/?target=https://www.jianshu.com/p/d6ce3593a69e">ä¸€ä¸ªEntryåˆ†ä¸º5éƒ¨åˆ†å†…å®¹ï¼š</a><ul>
<li>ä¸å‰ä¸€æ¡è®°å½• key å…±äº«éƒ¨åˆ†çš„é•¿åº¦ï¼Œä¸º 0 åˆ™è¡¨ç¤ºè¯¥ Entry æ˜¯ä¸€ä¸ªé‡å¯ç‚¹ï¼›</li>
<li>ä¸å‰ä¸€æ¡è®°å½• key ä¸å…±äº«éƒ¨åˆ†çš„é•¿åº¦ï¼›</li>
<li>value é•¿åº¦ï¼›</li>
<li>ä¸å‰ä¸€æ¡è®°å½• key éå…±äº«çš„å†…å®¹ï¼›</li>
<li>value å†…å®¹</li>
</ul>
</li>
</ul>
<p>å¯ä»¥çœ‹å‡º RocksDB ä¹Ÿæ˜¯ä»¥ key ä¸ºåŸºå‡†è¿›è¡Œæœ‰åºå­˜å‚¨çš„ KV å¼•æ“ï¼Œè‡³äºã€Œåˆ—æ—ã€æ¦‚å¿µï¼Œåªæ˜¯é€»è¾‘ä¸Šçš„åˆ’åˆ†ï¼Œå¹¶ä¸æ„å‘³ç€å®ƒä»¬çœŸçš„æ˜¯åˆ—å­˜æ•°æ®åº“ã€‚</p>
<ol start="3">
<li><strong>Snapshotï¼ˆå¿«ç…§ï¼‰</strong></li>
</ol>
<p>ä¸€ä¸ªå¿«ç…§ä¼šæ•è·åœ¨åˆ›å»ºçš„æ—¶é—´ç‚¹çš„ DB çš„ä¸€è‡´æ€§è§†å›¾ã€‚å¿«ç…§åœ¨ DB é‡å¯ä¹‹åå°†æ¶ˆå¤±ã€‚</p>
<ol start="4">
<li><strong>Iteratorï¼ˆè¿­ä»£å™¨ï¼‰</strong></li>
</ol>
<p>RocksDB è¿­ä»£å™¨å…è®¸ç”¨æˆ·ä»¥ä¸€ä¸ªæ’åºå¥½çš„é¡ºåºå‘åæˆ–è€…å‘å‰éå† dbã€‚å®ƒè¿˜æ‹¥æœ‰æŸ¥æ‰¾ DB ä¸­çš„ä¸€ä¸ªç‰¹å®š key çš„åŠŸèƒ½ï¼Œä¸ºæ­¤ï¼Œè¿­ä»£å™¨éœ€è¦ä»¥ä¸€ä¸ªæ’åºå¥½çš„æµæ¥è®¿é—® DBã€‚</p>
<ul>
<li>è€Œ RocksDB æ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯é€»è¾‘ä¸Šæ’å¥½åºçš„ã€‚åº”ç”¨å¯ä»¥æŒ‡å®šä¸€ç§é”®å€¼å‹ç¼©ç®—æ³•æ¥å¯¹é”®å€¼æ’åºã€‚</li>
</ul>
<p>å¦‚æœ ReadOptions.snapshot è¢«ç»™å‡ºï¼Œé‚£ä¹ˆè¿­ä»£å™¨ä¼šä»ä¸€ä¸ªå¿«ç…§é‡Œé¢è¿”å›æ•°æ®ã€‚å¦‚æœè¿™æ˜¯ä¸€ä¸ªnullptrï¼Œè¿­ä»£å™¨éšå¼åˆ›å»ºä¸€ä¸ªè¿­ä»£å™¨åˆ›å»ºçš„æ—¶é—´èŠ‚ç‚¹çš„å¿«ç…§ã€‚è¯¥éšå¼å¿«ç…§ä¼šé€šè¿‡<a target="_blank" rel="noopener" href="https://wanghenshui.github.io/rocksdb-doc-cn/doc/Iterator.html">å›ºå®šèµ„æº</a>æ¥æä¾›æ•°æ®ã€‚éšå¼å¿«ç…§æ— æ³•è½¬æ¢ä¸ºæ˜¾å¼å¿«ç…§ã€‚</p>
<ol start="5">
<li><strong>Compactionï¼ˆå‹ç¼©ï¼‰&amp;&amp; flush</strong></li>
</ol>
<p>Compaction æ˜¯å°†ä¸€äº› SST æ–‡ä»¶åˆå¹¶æˆå¦å¤–ä¸€äº› SST æ–‡ä»¶çš„åå°ä»»åŠ¡ã€‚</p>
<p>Flush æ˜¯å°† memtable çš„æ•°æ®å†™å…¥ SST æ–‡ä»¶çš„åå°ä»»åŠ¡ã€‚</p>
<ul>
<li>å¯ä»¥æ‰‹åŠ¨è°ƒç”¨ï¼›compaction æ˜¯è¾ƒé‡çš„æ“ä½œï¼Œåœ¨æŸäº›è´Ÿè½½è¾ƒé‡çš„åœºæ™¯ï¼Œä¼šæå‰ compactionï¼Œå‡è½»è´Ÿè½½<ul>
<li>æ¯”å¦‚ä¸šåŠ¡ä½å³°æœŸï¼Œä¼šé›†ä¸­ compaction</li>
<li>è¿›é˜¶ï¼šRemote compactionï¼Œå­˜ç®—åˆ†ç¦»</li>
</ul>
</li>
</ul>
<h3 id="å…¸å‹-API"><a href="#å…¸å‹-API" class="headerlink" title="å…¸å‹ API"></a>å…¸å‹ API</h3><p>é”®å€¼å¯¹çš„æ•°æ®éƒ½æ˜¯æŒ‰ç…§äºŒè¿›åˆ¶å¤„ç†çš„ã€‚é”®å€¼éƒ½æ²¡æœ‰é•¿åº¦çš„é™åˆ¶ã€‚</p>
<ul>
<li><code>Put</code> å¯ä»¥å°†ä¸€ä¸ªé”®å€¼å¯¹å†™å…¥æ•°æ®åº“ã€‚å¦‚æœè¯¥é”®å€¼å·²ç»å­˜åœ¨äºæ•°æ®åº“å†…ï¼Œä¹‹å‰çš„æ•°æ®ä¼šè¢«è¦†ç›–ã€‚</li>
<li><code>WriteBatch</code> å¯ä»¥å°†å¤šä¸ªæ“ä½œåŸå­åœ°å†™å…¥æ•°æ®åº“ã€‚<ul>
<li>æ¯”å¦‚ hg ä¸­åˆ©ç”¨ writeBatch çš„åŸå­æ€§ï¼Œå°è£…ä¸º <code>SessionOperatorImpl.commit</code></li>
</ul>
</li>
</ul>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164836771.png" alt="image-20240401164836771"></p>
<ul>
<li><code>Get</code>å…è®¸åº”ç”¨ä»æ•°æ®åº“é‡Œé¢æå–ä¸€ä¸ªé”®å€¼å¯¹çš„æ•°æ®ã€‚</li>
<li><code>MultiGet</code> å…è®¸åº”ç”¨ä¸€æ¬¡ä»æ•°æ®åº“è·å–ä¸€æ‰¹æ•°æ®ã€‚ä½¿ç”¨<code>MultiGet</code>è·å–çš„æ‰€æœ‰æ•°æ®ä¿è¯ç›¸äº’ä¹‹é—´çš„ä¸€è‡´æ€§ï¼ˆç‰ˆæœ¬ç›¸åŒï¼‰ã€‚</li>
<li><code>Iterator</code> API å…è®¸å¯¹ database åš RangeScanã€‚Iterator å¯ä»¥æŒ‡å®šä¸€ä¸ª keyï¼Œç„¶ååº”ç”¨ç¨‹åºå°±å¯ä»¥ä»è¿™ä¸ª key å¼€å§‹åšæ‰«æã€‚Iterator API è¿˜å¯ä»¥ç”¨æ¥å¯¹æ•°æ®åº“å†…å·²æœ‰çš„ key ç”Ÿæˆä¸€ä¸ªé¢„ç•™çš„è¿­ä»£å™¨ã€‚ä¸€ä¸ªåœ¨æŒ‡å®šæ—¶é—´çš„ä¸€è‡´æ€§çš„æ•°æ®åº“è§†å›¾ä¼šåœ¨ Iterator åˆ›å»ºçš„æ—¶å€™è¢«ç”Ÿæˆã€‚æ‰€ä»¥ï¼Œé€šè¿‡ Iterator è¿”å›çš„æ‰€æœ‰é”®å€¼éƒ½æ˜¯æ¥è‡ªä¸€ä¸ªä¸€è‡´çš„æ•°æ®åº“è§†å›¾çš„ã€‚</li>
<li><code>Snapshot</code> API å…è®¸åº”ç”¨åˆ›å»ºä¸€ä¸ªæŒ‡å®šæ—¶é—´çš„æ•°æ®åº“è§†å›¾ã€‚<code>Get</code>ï¼Œ<code>Iterator</code>æ¥å£å¯ä»¥ç”¨äºè¯»å–ä¸€ä¸ªæŒ‡å®šsnapshot æ•°æ®ã€‚å½“ç„¶ï¼Œ<code>Snapshot</code>å’Œ<code>Iterator</code>éƒ½æä¾›ä¸€ä¸ªæŒ‡å®šæ—¶é—´çš„æ•°æ®åº“è§†å›¾ï¼Œä½†æ˜¯ä»–ä»¬çš„å†…éƒ¨å®ç°ä¸åŒã€‚<code>Snapshot</code>åœ¨æ•°æ®åº“é‡å¯è¿‡ç¨‹ä¸èƒ½ä¿æŒå­˜åœ¨ï¼šreload RocksDB ä¼šé‡Šæ”¾æ‰€æœ‰ä¹‹å‰åˆ›å»ºå¥½çš„ snapshotã€‚</li>
</ul>
<h3 id="æœ‰è¶£çš„äº‹å®"><a href="#æœ‰è¶£çš„äº‹å®" class="headerlink" title="æœ‰è¶£çš„äº‹å®"></a>æœ‰è¶£çš„äº‹å®</h3><blockquote>
<p>RocksDB ä»ä½¿ç”¨å±‚çš„è§’åº¦æ¥è¯´ï¼Œéš¾ç‚¹åœ¨äºï¼šopen æ—¶è¦ä¼ å…¥çš„ option å¯¹è±¡å¯é…ç½®çš„å¤ªå¤šäº†ï¼Œå°±è¿ rocksdb å¼€å‘è€…éƒ½æ²¡æœ‰ç»™å‡ºä¸€ä¸ªå®Œç¾çš„è°ƒä¼˜æ–¹æ¡ˆï¼Œåªæ˜¯ç»™å‡ºäº†ä¸€ç³»åˆ—è°ƒä¼˜å‚è€ƒå€¼ï¼Œå»ºè®®çš„æ˜¯åœ¨ä¸åŒçš„åº”ç”¨åœºæ™¯ä¸­é€šè¿‡å‹æµ‹æ¥è¿›è¡Œå‚æ•°è°ƒä¼˜ã€‚githubä¸Šçš„è°ƒä¼˜å‚è€ƒé“¾æ¥å¦‚ä¸‹ï¼š<a target="_blank" rel="noopener" href="https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide">https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide</a></p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164846804.png" alt="image-20240401164846804"></p>
<p>æ­¤å›¾ä¸ºä¸Šé¢é“¾æ¥çš„æ–‡æ¡£ä¸­æœ€åä¸€æ®µï¼Œå¯è§ rocksdb è°ƒä¼˜æ˜¯å¤šä¹ˆå¤æ‚çš„ä¸€ä»¶äº‹ã€‚</p>
</blockquote>
<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p>æ­¤å¤„è¿›è¡Œäº†æœ¬åœ°æ¼”ç¤ºï¼Œå¤§ä½“ä¸ºå±•ç¤º multiGetã€putã€writeBatch ç­‰ API</p>
<h2 id="Raft-JRaft"><a href="#Raft-JRaft" class="headerlink" title="Raft&#x2F;JRaft"></a>Raft&#x2F;JRaft</h2><p>è¯¦ç»†äº†è§£ Raft æœºåˆ¶å¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://raft.github.io/raft.pdf">Raft è®ºæ–‡</a></p>
<h3 id="åŸºæœ¬ä»‹ç»-1"><a href="#åŸºæœ¬ä»‹ç»-1" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h3><p>Raft æ˜¯ä¸€ä¸ªå¼ºä¸€è‡´æ€§çš„å…±è¯†ç®—æ³•ï¼Œç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¿æŒå‰¯æœ¬é—´çš„ä¸€è‡´æ€§ï¼Œæ ¸å¿ƒæ˜¯æ—¥å¿—å¤åˆ¶å’Œ leader é€‰ä¸¾ã€‚</p>
<p>Client å‘å¤åˆ¶çŠ¶æ€æœºå‘é€ä¸€ç³»åˆ—èƒ½å¤Ÿåœ¨çŠ¶æ€æœºä¸Šæ‰§è¡Œçš„å‘½ä»¤ï¼Œå…±è¯†ç®—æ³•è´Ÿè´£å°†è¿™äº›å‘½ä»¤ä»¥ Log çš„å½¢å¼å¤åˆ¶ç»™å…¶ä»–çš„çŠ¶æ€æœºï¼Œè¿™æ ·ä¸åŒçš„çŠ¶æ€æœºåªè¦æŒ‰ç…§å®Œå…¨ä¸€æ ·çš„é¡ºåºæ¥æ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œå°±èƒ½å¾—åˆ°ä¸€æ ·çš„è¾“å‡ºç»“æœã€‚</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164854770.png" alt="image-20240401164854770"></p>
<p>SOFA-JRaft æ˜¯ä¸€ä¸ªåŸºäº <a href="https://link.zhihu.com/?target=https://raft.github.io/">Raft</a> ä¸€è‡´æ€§ç®—æ³•çš„ç”Ÿäº§çº§é«˜æ€§èƒ½ Java å®ç°ï¼Œæ”¯æŒ MULTI-RAFT-GROUPï¼Œé€‚ç”¨äºé«˜è´Ÿè½½ä½å»¶è¿Ÿçš„åœºæ™¯ã€‚ (ä¹Ÿå¯ä»¥ç†è§£ä¸ºä¸€ä¸ª <a target="_blank" rel="noopener" href="https://github.com/brpc/braft">braft</a> çš„ Java å®ç° - è§å®˜æ–¹ README)</p>
<p>ä¸Šè¿°çŠ¶æ€æœºæ¨¡å‹åº”ç”¨åˆ° JRaftï¼Œå¤§è‡´æ¶æ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164905202.png" alt="image-20240401164905202"></p>
<p>å› ä¸º Raft ä¸­ï¼Œé€šå¸¸é€‰ä¸¾æˆ–å†™å…¥éœ€è¦åŠæ•°ä»¥ä¸Šå‰¯æœ¬åŒæ„ï¼Œæ‰€ä»¥ RaftGroup åªå…è®¸åŠæ•°ä»¥ä¸‹çš„å‰¯æœ¬æ•…éšœï¼Œä¹Ÿå°±æ˜¯è¯´ 5 å‰¯æœ¬å…è®¸ 2 ä¸ªæ•…éšœï¼Œ6 ä¸ªå‰¯æœ¬ä¹Ÿæ˜¯å…è®¸ 2 ä¸ªæ•…éšœï¼Œå¯è§ 5 ä¸ªå’Œ 6 ä¸ªèŠ‚ç‚¹çš„å®¹ç¾èƒ½åŠ›æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è¯´å»ºè®®ç”¨æˆ·é…ç½®çš„å‰¯æœ¬æ•°é‡ä¸ºå¥‡æ•°ã€‚</p>
<p>è€Œå¯¹äºå¤§éƒ¨åˆ†ç”Ÿäº§ç¯å¢ƒï¼Œå…±è¯†ç»„ä¸€èˆ¬å°±æ˜¯ 3 å‰¯æœ¬ã€‚å› æ­¤ä¸Šè¿°æ¶æ„å›¾å¯æ‹“å±•å¦‚ä¸‹ï¼š</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164922384.png" alt="image-20240401164922384"></p>
<p>å…·ä½“å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/59385865">https://zhuanlan.zhihu.com/p/59385865</a></p>
<h3 id="Multi-Raft"><a href="#Multi-Raft" class="headerlink" title="Multi-Raft"></a>Multi-Raft</h3><p>è¿™é‡Œå¼•ç”¨ Cockroach ( MultiRaft çš„å…ˆé©±ï¼Œå‡ºæ¥çš„æ¯” TiDB æ—© )å¯¹ MultiRaft çš„å®šä¹‰ï¼š</p>
<blockquote>
<p>In <a target="_blank" rel="noopener" href="https://github.com/cockroachdb/cockroach">CockroachDB</a>, we use the <a target="_blank" rel="noopener" href="https://raftconsensus.github.io/">Raft consensus algorithm</a> to ensure that your data remains consistent even when machines fail. In most systems that use Raft, such as <a target="_blank" rel="noopener" href="https://github.com/coreos/etcd">etcd</a> and <a target="_blank" rel="noopener" href="https://www.consul.io/">Consul</a>, the entire system is one Raft consensus group. In CockroachDB, however, the data is divided into ranges, each with its own consensus group. This means that each node may be participating in hundreds of thousands of consensus groups. This presents some unique challenges, which we have addressed by introducing a layer on top of Raft that we call <a target="_blank" rel="noopener" href="https://github.com/cockroachdb/cockroach/tree/master/multiraft">MultiRaft</a>.</p>
</blockquote>
<p>åœ¨ CockroachDB ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Raft ä¸€è‡´æ€§ç®—æ³•æ¥ç¡®ä¿åœ¨æœºå™¨å‘ç”Ÿæ•…éšœæ—¶æ•°æ®ä¹Ÿèƒ½ä¿æŒä¸€è‡´ã€‚åœ¨å¤§å¤šæ•°ä½¿ç”¨ Raft çš„ç³»ç»Ÿä¸­ï¼Œå¦‚ etcd å’Œ Consulï¼Œæ•´ä¸ªç³»ç»Ÿåªæœ‰ä¸€ä¸ª Raft å…±è¯†ç»„ã€‚ç„¶è€Œï¼Œåœ¨ CockroachDB ä¸­ï¼Œæ•°æ®è¢«åˆ†æˆä¸åŒçš„èŒƒå›´ï¼Œæ¯ä¸ªèŒƒå›´éƒ½æœ‰è‡ªå·±çš„å…±è¯†ç»„ã€‚è¿™æ„å‘³ç€æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯èƒ½å‚ä¸æˆåƒä¸Šä¸‡ä¸ªå…±è¯†ç»„ã€‚è¿™å°±æå‡ºäº†ä¸€äº›ç‹¬ç‰¹çš„æŒ‘æˆ˜ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨ Raft ä¹‹ä¸Šå¼•å…¥ä¸€å±‚ MultiRaft æ¥è§£å†³è¿™äº›é—®é¢˜ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼ŒMultiRaft æ˜¯åœ¨æ•´ä¸ªç³»ç»Ÿä¸­ï¼ŒæŠŠæ‰€ç®¡ç†çš„æ•°æ®æŒ‰ç…§ä¸€å®šçš„æ–¹å¼åˆ‡ç‰‡ï¼Œæ¯ä¸€ä¸ªåˆ‡ç‰‡çš„æ•°æ®éƒ½æœ‰è‡ªå·±çš„å‰¯æœ¬ï¼Œè¿™äº›å‰¯æœ¬ä¹‹é—´çš„æ•°æ®ä½¿ç”¨ Raft æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œåœ¨å…¨å±€æ¥çœ‹æ•´ä¸ªç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨å¤šä¸ª Raft-Groupï¼Œå°±åƒè¿™ä¸ªæ ·å­ï¼š</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164934312.png" alt="image-20240401164934312"></p>
<p>å•ä¸ª Raft group æ˜¯æ— æ³•è§£å†³å¤§æµé‡çš„è¯»å†™ç“¶é¢ˆçš„ï¼Œé€šè¿‡ Multi-Raft æ¥æ‹“å±•è¯»å†™æ€§èƒ½æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¸¸è§åšæ³•ï¼ŒJRaft æ”¯æŒ Multi-Raft æ¶æ„ï¼ŒHg ä¹Ÿé‡‡ç”¨äº† Multi-Raft æ¶æ„ã€‚</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401164943032.png" alt="image-20240401164943032"></p>
<h1 id="HG-åˆ†å¸ƒå¼å­˜å‚¨æ¨¡å‹"><a href="#HG-åˆ†å¸ƒå¼å­˜å‚¨æ¨¡å‹" class="headerlink" title="HG åˆ†å¸ƒå¼å­˜å‚¨æ¨¡å‹"></a>HG åˆ†å¸ƒå¼å­˜å‚¨æ¨¡å‹</h1><p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ° RaftGroup å’Œ patition æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œpatition æ˜¯é€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œæ˜¯å¤šä¸ª PartGraph çš„é›†åˆã€‚</p>
<p>å› ä¸º RaftGroup æ˜¯æ¨ªè·¨å¤šä¸ªæœåŠ¡å™¨èŠ‚ç‚¹çš„ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªæ•°æ®åˆ†ç‰‡ï¼Œä¹Ÿå°±æ˜¯ shardï¼Œæ‰€ä»¥ partition å’Œ shard æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œpartition æœ‰å‡ ä¸ªå‰¯æœ¬å°±å¯¹åº”å‡ ä¸ª shardã€‚å› ä¸ºä¸€å°æœåŠ¡å™¨ä¼šæœ‰å¤šä¸ª RaftGroupï¼Œä¹Ÿå°±æ˜¯æœ‰å¤šä¸ª shardï¼Œè€Œä¸€ä¸ªå›¾å®ä¾‹å¯¹åº”çš„æ˜¯ä¸€ä¸ª rocksdb å®ä¾‹ï¼Œæ‰€ä»¥ shard å’Œ store æ˜¯å¤šå¯¹ä¸€çš„å…³ç³»ã€‚</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401165034362.png" alt="image-20240401165034362"></p>
<p>åœ¨ä»£ç é‡Œé¢ï¼šå‡è®¾æŸä¸ª store å®ä¾‹æœ‰ n ä¸ª shardï¼Œåˆ†åˆ«å±äº n ä¸ª RaftGroup</p>
<ul>
<li>é‚£ä¹ˆè¯¥ store å®ä¾‹å°†æŒæœ‰ n ä¸ª PartitionEngineï¼ˆMap&lt;String, PartitionEngine&gt;ï¼‰</li>
<li>æ¯ä¸ª PartitionEngine æŒæœ‰è¯¥ store å®ä¾‹ï¼Œå¯¹åº” shard çš„ RaftNode å¼•ç”¨ï¼ŒåŒæ—¶æŒæœ‰è¯¥ Partition çš„æ‰€æœ‰ peer ä¿¡æ¯<ul>
<li>å¯¹åº” JRaft çš„ raftGroupService.start</li>
</ul>
</li>
</ul>
<p>å…·ä½“åˆ†åŒºå“ˆå¸Œç®—æ³•ï¼šè¯¦æƒ…å‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/apache/incubator-hugegraph/pull/1696">feat(hbase): support hash rowkey struct &amp; pre-init tables (#1696) 035a03e1</a></p>
<h1 id="Store-æ¨¡å—äº¤äº’æµç¨‹æ¦‚è§ˆ"><a href="#Store-æ¨¡å—äº¤äº’æµç¨‹æ¦‚è§ˆ" class="headerlink" title="Store æ¨¡å—äº¤äº’æµç¨‹æ¦‚è§ˆ"></a>Store æ¨¡å—äº¤äº’æµç¨‹æ¦‚è§ˆ</h1><ol>
<li>é›†ç¾¤æ•´ä½“æ¶æ„ï¼š</li>
</ol>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401165043323.png" alt="image-20240401165043323"></p>
<ul>
<li>Server å’Œ store ç±»ä¼¼å­˜ç®—åˆ†ç¦»</li>
</ul>
<ol start="2">
<li>Store å†…éƒ¨çš„ request flow</li>
</ol>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401145506418.png" alt="image-20240401145506418"></p>
<h1 id="HG-åœ¨-RocksDB-çš„å­˜å‚¨æ•°æ®ç»“æ„"><a href="#HG-åœ¨-RocksDB-çš„å­˜å‚¨æ•°æ®ç»“æ„" class="headerlink" title="HG åœ¨ RocksDB çš„å­˜å‚¨æ•°æ®ç»“æ„"></a>HG åœ¨ RocksDB çš„å­˜å‚¨æ•°æ®ç»“æ„</h1><p>æŸä¸ª graph åœ¨ RocksDB çš„æ•°æ®å­˜åœ¨ä¸‹åˆ— tableï¼ˆCF-åˆ—æ—ï¼‰ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Integer&gt; tables = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;() &#123;&#123;</span><br><span class="line">    put(<span class="string">&quot;unknown&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    put(<span class="string">&quot;g+v&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    put(<span class="string">&quot;g+oe&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    put(<span class="string">&quot;g+ie&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    put(<span class="string">&quot;g+index&quot;</span>, <span class="number">4</span>);</span><br><span class="line">    put(<span class="string">&quot;g+task&quot;</span>, <span class="number">5</span>);</span><br><span class="line">    put(<span class="string">&quot;g+olap&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    put(<span class="string">&quot;g+server&quot;</span>, <span class="number">7</span>);</span><br><span class="line">&#125;&#125;;</span><br></pre></td></tr></table></figure>

<p>å‚è€ƒ <code>org.apache.hugegraph.backend.serializer.BinarySerializer</code> ï¼Œå¯ä»¥çœ‹å‡º HG çš„è¾¹ç‚¹ç­‰å±æ€§æ˜¯å¦‚ä½•åºåˆ—åŒ–æˆ RocksDB çš„ kv</p>
<p>ä»¥è¾¹ä¸ºä¾‹ï¼š</p>
<ul>
<li>ä»¥ partition_Idï¼ˆåŸºäº id hash ç®—å‡ºæ¥çš„ï¼‰ + id ä½œä¸º keyï¼Œä»¥è¾¹&#x2F;ç‚¹çš„å…·ä½“ lableã€properties ä½œä¸º value</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä»¥è¾¹ä¸ºä¾‹ï¼Œå†™ kv çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> BackendEntry <span class="title function_">writeVertex</span><span class="params">(HugeVertex vertex)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (vertex.olap()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.writeOlapVertex(vertex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">BinaryBackendEntry</span> <span class="variable">entry</span> <span class="operator">=</span> newBackendEntry(vertex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vertex.removed()) &#123;</span><br><span class="line">        <span class="keyword">return</span> entry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">propsCount</span> <span class="operator">=</span> vertex.sizeOfProperties();</span><br><span class="line">    <span class="type">BytesBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> BytesBuffer.allocate(<span class="number">8</span> + <span class="number">16</span> * propsCount);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write vertex label</span></span><br><span class="line">    buffer.writeId(vertex.schemaLabel().id());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write all properties of the vertex</span></span><br><span class="line">    <span class="built_in">this</span>.formatProperties(vertex.getProperties(), buffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write vertex expired time if needed</span></span><br><span class="line">    <span class="keyword">if</span> (vertex.hasTtl()) &#123;</span><br><span class="line">        entry.ttl(vertex.ttl());</span><br><span class="line">        <span class="built_in">this</span>.formatExpiredTime(vertex.expiredTime(), buffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// key</span></span><br><span class="line">    <span class="type">byte</span>[] name = <span class="built_in">this</span>.keyWithIdPrefix ?</span><br><span class="line">                  entry.id().asBytes() : BytesBuffer.BYTES_EMPTY;</span><br><span class="line">    <span class="comment">// value</span></span><br><span class="line">    entry.column(name, buffer.bytes());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™ key çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writePartitionedId</span><span class="params">(HugeType type, Id id, BytesBuffer buffer)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.enablePartition) &#123;</span><br><span class="line">        buffer.writeShort(getPartition(type, id));</span><br><span class="line">        buffer.writeId(id);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buffer.writeId(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="å®è§‚è®¾è®¡"><a href="#å®è§‚è®¾è®¡" class="headerlink" title="å®è§‚è®¾è®¡"></a>å®è§‚è®¾è®¡</h1><h2 id="Iterator-pattern"><a href="#Iterator-pattern" class="headerlink" title="Iterator pattern"></a>Iterator pattern</h2><p>å¯¹äº pd-store æ¶æ„ï¼ŒHg é‡‡ç”¨å„ç§ Iterator æ¥è¿›è¡Œæ•°æ®è¯»å–</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401165100005.png" alt="image-20240401165100005"></p>
<p>ç†è§£æœ‰ä¸¤å±‚åŸå› ï¼š</p>
<ol>
<li>RocksDB åº•å±‚åç«¯æä¾› Iterator è¯»æ–¹å¼ï¼Œå› æ­¤é¡ºæ°´æ¨èˆŸåœ¨æ•´ä¸ªæ¶æ„ä¸­éƒ½ç”¨ Iterator</li>
<li>é‡‡ç”¨ Iterator wrap Iterator çš„æ–¹å¼ï¼Œå±‚å±‚è°ƒç”¨ï¼Œ<strong>å¯ä»¥å®ç°ç±»ä¼¼ç«å±±æ¨¡å‹çš„æ•ˆæœ</strong> <strong>(å‘é‡åŒ–&#x2F;æ‰¹å¤„ç†æ¨¡å‹å¯ç®—æ˜¯å®ƒçš„ä¼˜åŒ–ç‰ˆ, ä¹Ÿæ˜¯ HG ä¹‹åå¯åœ¨éƒ¨åˆ†æŸ¥è¯¢ä¸Šæ”¹è¿›çš„æ€è·¯ä¹‹ä¸€)</strong></li>
</ol>
<blockquote>
<p>ç«å±±æ¨¡å‹æ˜¯æ•°æ®åº“ç•Œå·²ç»å¾ˆæˆç†Ÿçš„è§£é‡Šè®¡ç®—æ¨¡å‹ï¼Œè¯¥è®¡ç®—æ¨¡å‹å°†å…³ç³»ä»£æ•°ä¸­æ¯ä¸€ç§æ“ä½œæŠ½è±¡ä¸ºä¸€ä¸ª Operatorï¼Œå°†æ•´ä¸ª SQL æ„å»ºæˆä¸€ä¸ª Operator æ ‘ï¼Œä»æ ¹èŠ‚ç‚¹åˆ°å¶å­ç»“ç‚¹è‡ªä¸Šè€Œä¸‹åœ°é€’å½’è°ƒç”¨ next() å‡½æ•°ã€‚æ¯ä¸ª next() å‡½æ•°å¤„ç†ä¸€ä¸ª tupleã€‚</p>
<p>ä¾‹å¦‚ SQLï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Id, Name, Age, (Age <span class="operator">-</span> <span class="number">30</span>) <span class="operator">*</span> <span class="number">50</span> <span class="keyword">AS</span> BonusFROM PeopleWHERE Age  <span class="number">30</span></span><br></pre></td></tr></table></figure>

<p>å¯¹åº”ç«å±±æ¨¡å‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401165115173.png" alt="image-20240401165115173"></p>
</blockquote>
<h2 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h2><p>ç”¨äºå¹¿æ’­ã€æ‰§è¡Œç±»ä¼¼ AOP çš„é€»è¾‘ï¼Œå®ç°ä¸€äº›åˆ‡é¢åŠ¨ä½œ</p>
<ol>
<li>Store çš„çŠ¶æ€ï¼šå½“ store ä¸Šçº¿æ—¶ï¼Œè¿›è¡Œå¯åŠ¨åŠ¨ä½œ</li>
</ol>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20240401165125425.png" alt="image-20240401165125425"></p>
<ol start="2">
<li>RaftGroup çš„çŠ¶æ€</li>
</ol>
<p>RaftStateListenerï¼šç›‘å¬ RaftGroup çš„ leader change ç­‰ä¿¡æ¯</p>
<ol start="3">
<li>Replicatorï¼ˆJRaft ç”¨äºå¤åˆ¶æ—¥å¿—çš„ç»„ä»¶ï¼‰çš„çŠ¶æ€</li>
</ol>
<p>ReplicatorStateListenerï¼šåœ¨çŠ¶æ€æ”¹å˜æ—¶æ£€æŸ¥æ˜¯å¦æœ‰ changeShard ä»»åŠ¡</p>
<ol start="4">
<li>RocksDB çš„çŠ¶æ€</li>
</ol>
<p>RocksDBChangeListenerï¼šcompaction ç­‰åŠ¨ä½œ</p>
<ol start="5">
<li>Partition çš„çŠ¶æ€</li>
</ol>
<p>PartitionChangedListenerï¼šç”¨äºåœ¨ change çš„æ—¶å€™ç”± leader é€šçŸ¥å…¶ä»– follower</p>
<h2 id="Closure"><a href="#Closure" class="headerlink" title="Closure"></a>Closure</h2><p>ç±»ä¼¼é—­åŒ…ï¼Œå®é™…ç”¨èµ·æ¥åƒ go defer æˆ– AOPï¼Œå®šä¹‰åœ¨ç»“æŸæŸä¸ªæ´»åŠ¨æ—¶æ‰§è¡Œçš„åŠ¨ä½œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">engine.addRaftTask(request.getGraphName(), request.getPartitionId(),</span><br><span class="line">                   RaftOperation.create(op, request), <span class="keyword">new</span> <span class="title class_">RaftClosure</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(com.alipay.sofa.jraft.Status status)</span> &#123;</span><br><span class="line">                <span class="type">Status</span> <span class="variable">responseStatus</span> <span class="operator">=</span> Status.UNKNOWN;</span><br><span class="line">                <span class="keyword">switch</span> (HgRaftError.forNumber(status.getCode())) &#123;</span><br><span class="line">                    <span class="keyword">case</span> OK:</span><br><span class="line">                        responseStatus = Status.OK;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> NOT_LEADER:</span><br><span class="line">                        responseStatus = Status.LEADER_REDIRECT;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> NOT_LOCAL:</span><br><span class="line">                        responseStatus = Status.NO_PARTITION;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> WAIT_LEADER_TIMEOUT:</span><br><span class="line">                        responseStatus = Status.WAIT_LEADER_TIMEOUT;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        responseStatus.setMsg(status.getErrorMsg());</span><br><span class="line">                &#125;</span><br><span class="line">                response.setStatus(responseStatus);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLeaderChanged</span><span class="params">(Integer partId, Long storeId)</span> &#123;</span><br><span class="line">                RaftClosure.<span class="built_in">super</span>.onLeaderChanged(partId, storeId);</span><br><span class="line">                response.addPartitionLeader(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">HgCmdBase</span>.BaseResponse.PartitionLeader(partId, storeId));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šJRaft è¿˜ä½¿ç”¨ closure æ¥æ ‡è¯†æ˜¯å¦æ˜¯ leader </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApply</span><span class="params">(Iterator inter)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (inter.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">RaftClosureAdapter</span> <span class="variable">done</span> <span class="operator">=</span> (RaftClosureAdapter) inter.done();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (RaftTaskHandler taskHandler : taskHandlers) &#123;</span><br><span class="line">                <span class="keyword">if</span> (done != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Leaderåˆ†æ”¯ï¼Œæœ¬åœ°è°ƒç”¨</span></span><br><span class="line">                    <span class="keyword">if</span> (taskHandler.invoke(groupId, done.op.getOp(), done.op.getReq(),</span><br><span class="line">                                           done.closure)) &#123;</span><br><span class="line">                        done.run(Status.OK());</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (taskHandler.invoke(groupId, inter.getData().array(), <span class="literal">null</span>)) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;&#123;&#125;&quot;</span>, Base64.getEncoder().encode(inter.getData().array()));</span><br><span class="line">            LOG.error(<span class="string">&quot;StateMachine&#123;&#125; meet critical error: .&quot;</span>, groupId, t);</span><br><span class="line">            <span class="keyword">if</span> (done != <span class="literal">null</span>) &#123;</span><br><span class="line">                LOG.error(<span class="string">&quot;StateMachine meet critical error: op = &#123;&#125; &#123;&#125;.&quot;</span>, done.op.getOp(),</span><br><span class="line">                          done.op.getReq());</span><br><span class="line">                <span class="comment">//    done.run(new Status(RaftError.EINTERNAL, t.getMessage()));</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        committedIndex = inter.getIndex();</span><br><span class="line"></span><br><span class="line">        stateListeners.forEach(listener -&gt; &#123;</span><br><span class="line">            listener.onDataCommitted(committedIndex);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// æ¸…ç†æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (done != <span class="literal">null</span>) &#123;</span><br><span class="line">            done.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// éå†ä¸‹ä¸€æ¡</span></span><br><span class="line">        inter.next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å¿ƒè·³ä¿æ´»ï¼ˆwith-TTLï¼‰"><a href="#å¿ƒè·³ä¿æ´»ï¼ˆwith-TTLï¼‰" class="headerlink" title="å¿ƒè·³ä¿æ´»ï¼ˆwith TTLï¼‰"></a>å¿ƒè·³ä¿æ´»ï¼ˆwith TTLï¼‰</h2><p>HgStoreEngine ä¸­ï¼Œstore å®ä¾‹ä¼šå®šæœŸå‘ pd å‘é€å¿ƒè·³ã€‚</p>
<p>Store çš„è®¾è®¡ä¸­ï¼Œå¤„å¤„å¯è§çŠ¶æ€æœºæ€æƒ³ï¼šstore å®ä¾‹è¢«è®¾å®šä¸ºäº†å››ç§çŠ¶æ€ï¼Œæ ¹æ®ä¸åŒçš„çŠ¶æ€ï¼Œå¿ƒè·³ä¼šæœ‰ä¸åŒçš„åŠ¨ä½œ</p>
<ul>
<li>Unknown</li>
<li>Offline<ul>
<li>é‡æ–°å‘ pd æ³¨å†Œï¼Œå…ˆæ‹¿ idï¼Œå¦‚æœé›†ç¾¤ readyï¼Œæ³¨å†Œä¹‹ï¼Œç„¶åç›‘å¬ partition çš„æ¶ˆæ¯ï¼ˆé‡å¯ï¼‰</li>
</ul>
</li>
<li>Online<ul>
<li>ä¸ pd å¿ƒè·³ï¼Œæ›´æ–° storeInfo</li>
<li>æ ¹æ®æ‹¿åˆ°çš„ cluster ä¿¡æ¯ï¼Œæ£€æŸ¥ cluster æ˜¯å¦å¼‚å¸¸ï¼ˆä¿æ´»ï¼‰</li>
</ul>
</li>
<li>Tombstoneï¼ˆæ­»äº¡ï¼‰<ul>
<li>ä»€ä¹ˆä¹Ÿä¸åš</li>
</ul>
</li>
</ul>
<h1 id="é«˜å¯ç”¨"><a href="#é«˜å¯ç”¨" class="headerlink" title="é«˜å¯ç”¨"></a>é«˜å¯ç”¨</h1><ol>
<li>åˆ†å¸ƒå¼æ¶æ„åŸç”Ÿä¿è¯ä¸€å®šçš„å®¹é”™</li>
<li>store å®šæœŸä¸ pd å¿ƒè·³ï¼ŒåŒæ­¥å…ƒä¿¡æ¯ï¼ˆä¼´æœ‰ TTL ä¿æ´»ï¼‰ï¼Œè€Œ Pd åˆ©ç”¨ RocksDB å°†å…ƒä¿¡æ¯æŒä¹…åŒ–ï¼Œä¿è¯äº†é‡å¯æ¢å¤ã€‚</li>
<li>store å®ä¾‹ä¹‹é—´çš„å‰¯æœ¬åŒæ­¥è¿‡ç¨‹ï¼Œå€ŸåŠ© JRaft ç»„ä»¶ä¿è¯äº†é‡å¯æ¢å¤ã€‚ </li>
<li>store çš„ meta infoï¼ˆæ— è®ºæ˜¯ pd è¿˜æ˜¯ storeï¼‰éƒ½å€ŸåŠ© RocksDB è¿›è¡ŒæŒä¹…åŒ–ï¼Œé˜²æ­¢èŠ‚ç‚¹å®•æœºä¿¡æ¯ä¸¢å¤±ï¼ˆå­˜å‚¨åœ¨ä¸“é—¨çš„å›¾ hgstore-metadata ä¸‹ï¼‰</li>
</ol>
<h1 id="é«˜æ€§èƒ½"><a href="#é«˜æ€§èƒ½" class="headerlink" title="é«˜æ€§èƒ½"></a>é«˜æ€§èƒ½</h1><ol>
<li>å¹¶å‘æ‰§è¡Œï¼šä¸å¤šèµ˜è¿°</li>
<li>å¼‚æ­¥ä»»åŠ¡ï¼šå¦‚ AsyncRPC</li>
<li>ä¸Šä¸‹æ–‡ç”¨ Byte å¯¹è±¡ä¼ è¾“ï¼Œå‡å°‘åºåˆ—åŒ–å¼€é”€ï¼šå¦‚ RaftOperation</li>
</ol>
<h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44607611/article/details/113742388">https://blog.csdn.net/weixin_44607611/article/details/113742388</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1785028">https://cloud.tencent.com/developer/article/1785028</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/penriver/article/details/117559188">https://blog.csdn.net/penriver/article/details/117559188</a></li>
<li><a target="_blank" rel="noopener" href="https://wanghenshui.github.io/rocksdb-doc-cn/">https://wanghenshui.github.io/rocksdb-doc-cn/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/facebook/rocksdb/blob/master/java/samples/src/main/java/RocksDBSample.java">https://github.com/facebook/rocksdb/blob/master/java/samples/src/main/java/RocksDBSample.java</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/165399524">https://zhuanlan.zhihu.com/p/165399524</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/340949657">https://zhuanlan.zhihu.com/p/340949657</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/145551967">https://zhuanlan.zhihu.com/p/145551967</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/59385865">https://zhuanlan.zhihu.com/p/59385865</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/61185934">https://zhuanlan.zhihu.com/p/61185934</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/478705155">https://zhuanlan.zhihu.com/p/478705155</a></li>
</ol>

  </div>
  
    
      <a id="older" class="blog-nav" href="/article/JVM-biased-lock/">OLDER&nbsp;&gt;</a>
      
        
          <a id="newer" class="blog-nav" href="/article/memory-management/">&lt;&nbsp;NEWER</a>
          
            
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/Pengzna">Copyright Â© Pengzna 2021-present</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          <!-- <span class="search-icon-input">
            <a href="javascript: void(0)">
              <i class="iconfont icon-search"></i>
            </a>
          </span> -->
          
            <input type="text" class="search-input" id="search-input" placeholder="æœç´¢">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)">
              <i class="iconfont icon-close"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    // inputArea.onclick = function() {
    //   getSearchFile()
    //   this.onclick = null
    // }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        inputArea.focus()
        getSearchFile()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'><span></ul>";
      // $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'><h2>" + orig_data_title + "</h2></a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<h3 class=\"search-result-abstract\">" + match_content + "...</h3>"
                }
                str += "<hr></li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer toï¼š<a href='https://github.com/leedom92/hexo-theme-leedom#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </body>
</html>

<!DOCTYPE html>
<html lang="en">

  <head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="Pengzna,blog" />
  <meta name="author" content="Pengzna" />
  <meta name="description" content="Pengzna çš„åšå®¢" />
  
  
  <title>
    
      åŸºäº Redis å‘å¸ƒè®¢é˜…å®ç°IMæ¶ˆæ¯é˜Ÿåˆ— 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto:400,400italic,600|Roboto+Mono" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


<meta name="generator" content="Hexo 7.0.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>


  <body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="app">
      <div class="header">
  <a href="/">Pengzna's blog ğŸ‘‹</a>
</div>


      <p class="links">
  
    <a title="archives" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="github" target="_blank" href="https://github.com/Pengzna">
      <i class="iconfont icon-github"></i>
    </a>
  
    <a title="email" target="" href="">
      <i class="iconfont icon-envelope"></i>
    </a>
  
    <a title="linkedin" target="_blank" href="https://www.linkedin.com/in/pengzna/">
      <i class="iconfont icon-linkedin"></i>
    </a>
  
    <a title="wechat" target="_blank" href="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20231115013033249.png">
      <i class="iconfont icon-wechat"></i>
    </a>
  
</p>


      <div class="main">
        <!-- æ–‡ç« è¯¦æƒ…é¡µï¼Œå±•ç¤ºæ–‡ç« å…·ä½“å†…å®¹ï¼Œurlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
<!-- åŒæ—¶ä¸ºã€Œæ ‡ç­¾tagã€ï¼Œã€Œæœ‹å‹friendã€ï¼Œã€Œåˆ†ç±»categoriesã€ï¼Œã€Œå…³äºaboutã€é¡µé¢çš„æ‰¿è½½é¡µé¢ï¼Œå…·ä½“å±•ç¤ºå–å†³äºpage.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>

<div class="post">
  <h3 class="date">
    Jul 26, 2022
  </h3>
  <h1>
    åŸºäº Redis å‘å¸ƒè®¢é˜…å®ç°IMæ¶ˆæ¯é˜Ÿåˆ—
  </h1>
  <div class="content markdown-body">
    <h2 id="1-å‘å¸ƒè®¢é˜…æ¨¡å¼"><a href="#1-å‘å¸ƒè®¢é˜…æ¨¡å¼" class="headerlink" title="1. å‘å¸ƒè®¢é˜…æ¨¡å¼"></a>1. å‘å¸ƒè®¢é˜…æ¨¡å¼</h2><p>Redisçš„å‘å¸ƒè®¢é˜…æœºåˆ¶æ˜¯ä¸€ç§æ¶ˆæ¯é€šä¿¡æ¨¡å¼ï¼ŒåŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå‘å¸ƒè€…ï¼ˆpubï¼‰å‘é€æ¶ˆæ¯ï¼Œè®¢é˜…è€…ï¼ˆsubï¼‰æ¥æ”¶ä¿¡æ¯å’Œ<code>Channel</code>ï¼Œè¿™é‡Œçš„<code>Channel</code>ç±»ä¼¼äº<code>Kafka</code>ä¸­çš„<code>topic</code>çš„æ¦‚å¿µã€‚</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/20210702104227710.png" alt="img"></p>
<p>å‘å¸ƒè€…å’Œè®¢é˜…è€…éƒ½æ˜¯<code>Redis</code>å®¢æˆ·ç«¯ï¼Œ<code>Channel</code>åˆ™ä¸º<code>Redis</code>æœåŠ¡å™¨ç«¯ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ç§ç‰¹æ®Šçš„æ•°æ®<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84&spm=1001.2101.3001.7020">å­˜å‚¨ç»“æ„</a>ã€‚å‘å¸ƒè€…å°†æ¶ˆæ¯å‘é€åˆ°æŸä¸ªçš„é¢‘é“ï¼Œè®¢é˜…äº†è¿™ä¸ªé¢‘é“çš„è®¢é˜…è€…å°±èƒ½æ¥æ”¶åˆ°è¿™æ¡æ¶ˆæ¯ã€‚</p>
<p>Rediså®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ã€‚</p>
<p><code>Redis</code>çš„è¿™ç§å‘å¸ƒè®¢é˜…æœºåˆ¶ä¸åŸºäºä¸»é¢˜çš„å‘å¸ƒè®¢é˜…ç±»ä¼¼ï¼Œ<code>Channel</code>ç›¸å½“äºä¸»é¢˜ã€‚</p>
<p>ä¸‹å›¾å±•ç¤ºé¢‘é“channel1ï¼Œä»¥åŠè®¢é˜…è¿™ä¸ªé¢‘é“çš„ä¸‰ä¸ªå®¢æˆ·ç«¯â€“client2ï¼Œclient5å’Œclient1ä¹‹é—´çš„å…³ç³»</p>
<p><img src="https://img-blog.csdnimg.cn/ae3ee06fde0b4b81ad1278a920dbfcc2.png#pic_center" alt="img"></p>
<p>å½“æœ‰æ–°æ¶ˆæ¯é€šè¿‡PUBLISHå‘½ä»¤å‘é€ç»™é¢‘é“channel1æ—¶ï¼Œè¿™ä¸ªæ¶ˆæ¯å°±ä¼šè¢«å‘é€ç»™è®¢é˜…å®ƒçš„ä¸‰ä¸ªå®¢æˆ·ç«¯</p>
<p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/ce1bfeef41514ea59745f713fc49d439.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3 id="1-1-ç›¸å…³å‘½ä»¤"><a href="#1-1-ç›¸å…³å‘½ä»¤" class="headerlink" title="1.1. ç›¸å…³å‘½ä»¤"></a>1.1. ç›¸å…³å‘½ä»¤</h3><h4 id="1-1-1-è®¢é˜…è€…-ç­‰å¾…æ¥æ”¶æ¶ˆæ¯"><a href="#1-1-1-è®¢é˜…è€…-ç­‰å¾…æ¥æ”¶æ¶ˆæ¯" class="headerlink" title="1.1.1. è®¢é˜…è€…&#x2F;ç­‰å¾…æ¥æ”¶æ¶ˆæ¯"></a>1.1.1. è®¢é˜…è€…&#x2F;ç­‰å¾…æ¥æ”¶æ¶ˆæ¯</h4><p>é¦–å…ˆæ‰“å¼€ Redis å®¢æˆ·ç«¯ï¼Œç„¶åè®¢é˜…äº†ä¸€ä¸ªåä¸ºâ€œbbxâ€çš„ channelï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SUBSCRIBE bbx</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) <span class="string">&quot;subscribe&quot;</span></span><br><span class="line">2) <span class="string">&quot;bbx&quot;</span></span><br><span class="line">3) (<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨SUBSCRIBEå‘½ä»¤è®¢é˜…äº†åä¸º bbx çš„ channelã€‚å‘½ä»¤æ‰§è¡Œåè¯¥å®¢æˆ·ç«¯ä¼šå‡ºå¤„äºç­‰å¾…æ¥æ”¶æ¶ˆæ¯çš„é˜»å¡çŠ¶æ€ã€‚</p>
<h4 id="1-1-2-å‘å¸ƒè€…-å‘é€æ¶ˆæ¯"><a href="#1-1-2-å‘å¸ƒè€…-å‘é€æ¶ˆæ¯" class="headerlink" title="1.1.2. å‘å¸ƒè€…&#x2F;å‘é€æ¶ˆæ¯"></a>1.1.2. å‘å¸ƒè€…&#x2F;å‘é€æ¶ˆæ¯</h4><p>ä¸‹é¢å†å¯åŠ¨ä¸€ä¸ª Redis å®¢æˆ·ç«¯ï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PUBLISH bbx hello</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PUBLISH bbx world</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>

<h4 id="1-1-3-è®¢é˜…è€…-æˆåŠŸæ¥æ”¶æ¶ˆæ¯"><a href="#1-1-3-è®¢é˜…è€…-æˆåŠŸæ¥æ”¶æ¶ˆæ¯" class="headerlink" title="1.1.3. è®¢é˜…è€…&#x2F;æˆåŠŸæ¥æ”¶æ¶ˆæ¯"></a>1.1.3. è®¢é˜…è€…&#x2F;æˆåŠŸæ¥æ”¶æ¶ˆæ¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SUBSCRIBE bbx</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) <span class="string">&quot;subscribe&quot;</span></span><br><span class="line">2) <span class="string">&quot;bbx&quot;</span></span><br><span class="line">3) (<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment">#ç­‰å¾…è¯»å–æ¨é€æ¶ˆæ¯</span></span><br><span class="line">1) <span class="string">&quot;message&quot;</span>	<span class="comment">#æ¶ˆæ¯</span></span><br><span class="line">2) <span class="string">&quot;bbx&quot;</span>		<span class="comment">#é¢‘é“</span></span><br><span class="line">3) <span class="string">&quot;hello&quot;</span>		<span class="comment">#æ¶ˆæ¯å…·ä½“å†…å®¹</span></span><br><span class="line">1) <span class="string">&quot;message&quot;</span></span><br><span class="line">2) <span class="string">&quot;bbx&quot;</span></span><br><span class="line">3) <span class="string">&quot;world&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-åŸç†"><a href="#1-2-åŸç†" class="headerlink" title="1.2. åŸç†"></a>1.2. åŸç†</h3><blockquote>
<p>æºç ï¼špubsub.c</p>
</blockquote>
<p>Redisé€šè¿‡<code>PUBLISH</code>ï¼Œ<code>SUBSCRIBE</code>å’Œ<code>PSUBSCRIBE</code>ç­‰å‘½ä»¤å®ç°å‘å¸ƒå’Œè®¢é˜…åŠŸèƒ½</p>
<p>é€šè¿‡<code>SUBSCRIBE</code>å‘½ä»¤è®¢é˜…æŸé¢‘é“åï¼Œredis-serveré‡Œç»´æŠ¤äº†ä¸€ä¸ªå­—å…¸ï¼Œå­—å…¸çš„é”®å°±æ˜¯ä¸€ä¸ªé¢‘é“ï¼Œå­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­ä¿å­˜äº†æ‰€æœ‰è®¢é˜…è¿™ä¸ªé¢‘é“çš„å®¢æˆ·ç«¯ã€‚<code>SUBSCRIBE</code>å‘½ä»¤çš„å…³é”®ï¼Œå°±æ˜¯å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°ç»™å®šé¢‘é“çš„è®¢é˜…é“¾è¡¨ä¸­ã€‚</p>
<p>é€šè¿‡<code>PUBLISH</code>å‘½ä»¤å‘è®¢é˜…è€…å‘é€æ¶ˆæ¯ï¼Œredis-serverä¼šä½¿ç”¨ç»™å®šé¢‘é“ä½œä¸ºé”®ï¼Œåœ¨å®ƒç»´æŠ¤çš„é¢‘é“å­—å…¸ä¸­æŸ¥æ‰¾è®°å½•äº†è®¢é˜…è¿™ä¸ªé¢‘é“çš„æ‰€æœ‰å®¢æˆ·ç«¯çš„é“¾è¡¨ï¼Œå°†æ¶ˆæ¯å‘å¸ƒç»™æ‰€æœ‰è®¢é˜…è€…</p>
<p>Pubå’ŒSubä»å­—é¢ä¸Šç†è§£å°±æ˜¯å‘å¸ƒï¼ˆPublishï¼‰å’Œè®¢é˜…ï¼ˆSubscribeï¼‰ï¼Œåœ¨redisä¸­ï¼Œå¯ä»¥è®¾å®šå¯¹æŸä¸€ä¸ªkeyå€¼è¿›è¡Œæ¶ˆæ¯å‘å¸ƒåŠæ¶ˆæ¯è®¢é˜…ï¼Œå½“ä¸€ä¸ªkeyå€¼ä¸Šè¿›è¡Œäº†æ¶ˆæ¯å‘å¸ƒåï¼Œæ‰€æœ‰è®¢é˜…å®ƒçš„å®¢æˆ·ç«¯éƒ½ä¼šæ”¶åˆ°ç›¸åº”çš„ä¿¡æ¯ï¼Œè¿™ä¸€åŠŸèƒ½æœ€æ˜æ˜¾çš„ç”¨æ³•å°±æ˜¯å®æ—¶æ¶ˆæ¯ç³»ç»Ÿï¼Œæ¯”å¦‚æ™®é€šçš„å³æ—¶èŠå¤©ï¼Œç¾¤èŠç­‰åŠŸèƒ½ã€‚</p>
<h3 id="1-3-ç¼ºç‚¹"><a href="#1-3-ç¼ºç‚¹" class="headerlink" title="1.3. ç¼ºç‚¹"></a>1.3. ç¼ºç‚¹</h3><ul>
<li>æ¶ˆæ¯æ— æ³•æŒä¹…åŒ–ï¼Œå­˜åœ¨ä¸¢å¤±é£é™©ï¼Œå³æ¶ˆæ¯ä¸€ç»å‘å¸ƒï¼Œå³ä½¿æ²¡æœ‰ä»»ä½•è®¢é˜…æ–¹å¤„ç†,è¯¥æ¡æ¶ˆæ¯å°±ä¼šä¸¢å¤±</li>
<li>æ²¡æœ‰ç±»ä¼¼ACKçš„æœºåˆ¶ï¼Œå³å‘å¸ƒæ–¹ä¸ä¼šç¡®ä¿è®¢é˜…æ–¹æˆåŠŸæ¥æ”¶</li>
<li>å¹¿æ’­æœºåˆ¶ï¼Œä¸‹æ¸¸æ¶ˆè´¹èƒ½åŠ›å–å†³äºæ¶ˆè´¹æ–¹æœ¬èº«ã€‚å¹¿æ’­æœºåˆ¶æ— æ³•é€šè¿‡æ·»åŠ å¤šä¸ªæ¶ˆè´¹æ–¹å¢å¼ºæ¶ˆè´¹èƒ½åŠ›, å› ä¸ºè¿™å’Œå‘å¸ƒ&#x2F;è®¢é˜…æ¨¡å‹æœ¬èº«çš„ç›®çš„æ˜¯ä¸ç¬¦çš„ã€‚å¹¿æ’­æœºåˆ¶çš„ç›®çš„æ˜¯ä¸€ä¸ªä¸€ä¸ªå‘å¸ƒè€…è¢«å¤šä¸ªè®¢é˜…è¿›è¡Œä¸åŒçš„å¤„ç†</li>
</ul>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<blockquote>
<ol>
<li>æ·»åŠ æŒä¹…åŒ–å±‚ï¼ŒåŠ å…¥redisç¼“å­˜å’ŒMySQL</li>
<li>ç»“åˆWebSocketï¼Œå®ç°æ¶ˆæ¯æ¨é€ã€æ¡æ‰‹ã€å¿ƒè·³æ£€æµ‹å’Œå¹¿æ’­ç­‰æœºåˆ¶</li>
</ol>
</blockquote>
<h2 id="2-å’ŒSpringBootã€WebSocketçš„æ•´åˆ"><a href="#2-å’ŒSpringBootã€WebSocketçš„æ•´åˆ" class="headerlink" title="2. å’ŒSpringBootã€WebSocketçš„æ•´åˆ"></a>2. å’ŒSpringBootã€WebSocketçš„æ•´åˆ</h2><h3 id="2-1-ä¾èµ–"><a href="#2-1-ä¾èµ–" class="headerlink" title="2.1. ä¾èµ–"></a>2.1. ä¾èµ–</h3><ul>
<li><em><strong>spring-boot-starter-web</strong></em>ï¼šå¸®åŠ©æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªWebæœåŠ¡å™¨ï¼›</li>
<li><em><strong>spring-boot-starter-data-redis</strong></em>ï¼šå¸®åŠ©æˆ‘ä»¬é›†æˆRedisï¼›</li>
<li><em><strong>lombok</strong></em>ï¼šæ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨ <em><strong>@Slf4j</strong></em>&#x2F;<em><strong>@Data</strong></em> ç­‰ï¼Œç®€åŒ–ä»£ç ï¼›</li>
<li><em><strong>spring-boot-starter-websocket</strong></em>ï¼šå¸®åŠ©æˆ‘ä»¬åœ¨SpringBootå®¢æˆ·ç«¯èµ·WebSocketè¿›ç¨‹</li>
</ul>
<h3 id="2-2-æ¶æ„"><a href="#2-2-æ¶æ„" class="headerlink" title="2.2. æ¶æ„"></a>2.2. æ¶æ„</h3><h4 id="2-2-1-æ•´ä½“æ¶æ„"><a href="#2-2-1-æ•´ä½“æ¶æ„" class="headerlink" title="2.2.1. æ•´ä½“æ¶æ„"></a>2.2.1. æ•´ä½“æ¶æ„</h4><blockquote>
<p>Redis(æ¶ˆæ¯é˜Ÿåˆ—)â€”â€”&gt; MySQL(æŒä¹…åŒ–) â€”â€”&gt; WebSockets(æ¶ˆæ¯è½¬å‘)â€”â€”&gt; FrontEnd(å®¢æˆ·ç«¯)</p>
</blockquote>
<h4 id="2-2-2-åç«¯æ¶æ„"><a href="#2-2-2-åç«¯æ¶æ„" class="headerlink" title="2.2.2. åç«¯æ¶æ„"></a>2.2.2. åç«¯æ¶æ„</h4><blockquote>
<p>Controllerâ€”â€”(n,1)â€”â€”&gt;Redisâ€”â€”(1,n)â€”â€”â€”&gt;Listenerâ€”â€”(1,n)â€”â€”&gt;WebSockets</p>
</blockquote>
<h3 id="2-3-Redisé…ç½®"><a href="#2-3-Redisé…ç½®" class="headerlink" title="2.3. Redisé…ç½®"></a>2.3. Redisé…ç½®</h3><h4 id="2-3-1-è‡ªå®šä¹‰RedisTemplate"><a href="#2-3-1-è‡ªå®šä¹‰RedisTemplate" class="headerlink" title="2.3.1. è‡ªå®šä¹‰RedisTemplate"></a>2.3.1. è‡ªå®šä¹‰RedisTemplate</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisTemp</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;String, Object&gt;();</span><br><span class="line">        template.setConnectionFactory(factory);</span><br><span class="line">        <span class="comment">// Jsonåºåˆ—åŒ–é…ç½®</span></span><br><span class="line">        <span class="type">Jackson2JsonRedisSerializer</span> <span class="variable">jackson2JsonRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>(Object.class);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">om</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line">        <span class="comment">// String çš„åºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">StringRedisSerializer</span> <span class="variable">stringRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        <span class="comment">// keyé‡‡ç”¨Stringçš„åºåˆ—åŒ–æ–¹å¼</span></span><br><span class="line">        template.setKeySerializer(stringRedisSerializer);</span><br><span class="line">        <span class="comment">// hashçš„keyä¹Ÿé‡‡ç”¨Stringçš„åºåˆ—åŒ–æ–¹å¼</span></span><br><span class="line">        template.setHashKeySerializer(stringRedisSerializer);</span><br><span class="line">        <span class="comment">// valueåºåˆ—åŒ–æ–¹å¼é‡‡ç”¨jackson</span></span><br><span class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        <span class="comment">// hashçš„valueåºåˆ—åŒ–æ–¹å¼é‡‡ç”¨jackson</span></span><br><span class="line">        template.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-å‘å¸ƒè®¢é˜…é…ç½®"><a href="#2-3-2-å‘å¸ƒè®¢é˜…é…ç½®" class="headerlink" title="2.3.2. å‘å¸ƒè®¢é˜…é…ç½®"></a>2.3.2. å‘å¸ƒè®¢é˜…é…ç½®</h4><p>ç”±äºæˆ‘ä»¬åœ¨å‘å¸ƒè€…ã€è®¢é˜…è€…çš„ä»£ç ä¸­å‡æ²¡æœ‰æŒ‡å®šè¦è®¢é˜…çš„channelï¼Œå› æ­¤éœ€è¦åœ¨å…¶ä»–åœ°æ–¹ï¼ˆå‘å¸ƒè®¢é˜…é…ç½®ç±»ï¼‰æŒ‡å®šchannelã€‚</p>
<p>æ­¤é…ç½®ç±»ä¸»è¦å®ç°äº†Redisæ¶ˆæ¯ç›‘å¬å™¨å®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨åŠ è½½äº†RedisConnectionFactoryå’Œæ¶ˆæ¯ç›‘å¬å™¨ï¼›å¯ä»¥æ·»åŠ å¤šä¸ªç›‘å¬ä¸åŒè¯é¢˜çš„redisç›‘å¬å™¨ï¼Œåªéœ€è¦æŠŠæ¶ˆæ¯ç›‘å¬å™¨å’Œç›¸åº”çš„æ¶ˆæ¯è®¢é˜…å¤„ç†å™¨ç»‘å®šï¼Œè¯¥æ¶ˆæ¯ç›‘å¬å™¨é€šè¿‡åå°„æŠ€æœ¯è°ƒç”¨æ¶ˆæ¯è®¢é˜…å¤„ç†å™¨çš„ç›¸å…³æ–¹æ³•è¿›è¡Œä¸€äº›ä¸šåŠ¡å¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisConnectionFactory redisConnectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SubConfig</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisConnectionFactory = redisConnectionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;h2&gt;é…ç½®æ¶ˆæ¯ç›‘å¬å™¨&lt;/h2&gt;</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageListener <span class="title function_">listener</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ConnectionListener.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;h2&gt;é…ç½® å‘å¸ƒ/è®¢é˜… çš„ Topic&lt;/h2&gt;</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChannelTopic <span class="title function_">channelTopic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ChannelTopic</span>(<span class="string">&quot;nxb message test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;h2&gt;å°†æ¶ˆæ¯ç›‘å¬å™¨ç»‘å®šåˆ°æ¶ˆæ¯å®¹å™¨&lt;/h2&gt;</span></span><br><span class="line"><span class="comment">     * å¹¶è¿›è¡Œå®¹å™¨çš„è®¾ç½®</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisMessageListenerContainer <span class="title function_">messageListenerContainer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RedisMessageListenerContainer</span> <span class="variable">container</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisMessageListenerContainer</span>();</span><br><span class="line">        container.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="comment">// æ­¤å¤„å¯ä»¥æ›´æ¢è®¢é˜…ä¸»é¢˜</span></span><br><span class="line">        container.addMessageListener(listener(), channelTopic());</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-æ¶ˆè´¹è€…ï¼ˆsubï¼‰"><a href="#2-4-æ¶ˆè´¹è€…ï¼ˆsubï¼‰" class="headerlink" title="2.4. æ¶ˆè´¹è€…ï¼ˆsubï¼‰"></a>2.4. æ¶ˆè´¹è€…ï¼ˆsubï¼‰</h3><p>è¿™é‡Œéœ€è¦å®ç°<code>MessageListener</code>æ¥å£ã€‚ç›®çš„æ˜¯åˆ©ç”¨<code>onMessage</code>æ–¹æ³•ï¼Œç›‘å¬<code>channel</code>ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°æ¥å—æ¶ˆæ¯ã€‚</p>
<p>æ¶ˆè´¹è€…çš„æ ¸å¿ƒæ–¹æ³•æ˜¯<code>onMessage</code>ï¼Œæ–¹æ³•ä¼ å…¥è®¢é˜…åˆ°çš„æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œå¤„ç†å³å¯ã€‚</p>
<p>è¿™é‡ŒæŠŠredisçš„æ¶ˆè´¹è€…æ–¹æ³•å’Œwebsocketè¿›è¡Œäº†æ•´åˆï¼Œredisæ¶ˆè´¹è€…æ”¶åˆ°ä¸Šæ¸¸æ¶ˆæ¯åï¼Œç”±websocketè½¬å‘ç»™å¯¹åº”ç”¨æˆ·ï¼Œå†è½¬å‘ç»™å‰ç«¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è´Ÿè´£è®¢é˜…rediså‘å¸ƒçš„æ¥å—å™¨ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionListener</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConcurrentHashMap&lt;String, WebSocket&gt; webSockets = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ConnectionListener</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionListener</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">ConnectionListener</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ConnectionListener <span class="title function_">getInstance</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¥æ”¶åˆ°æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pattern</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, <span class="type">byte</span>[] pattern)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        <span class="type">MessageVO</span> <span class="variable">messageVO</span> <span class="operator">=</span> JSON.parseObject((String)JSON.parse(message.toString()), MessageVO.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;received message: &quot;</span>+ messageVO);</span><br><span class="line">        sendMessage(messageVO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addConnection</span><span class="params">(String userId,WebSocket webSocket)</span>&#123;</span><br><span class="line">        webSockets.put(userId,webSocket);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">containConnection</span><span class="params">(String userId)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> webSockets.containsKey(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeConnection</span><span class="params">(String userId)</span>&#123;</span><br><span class="line">        webSockets.remove(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">connectionCount</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> webSockets.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(MessageVO message)</span>&#123;</span><br><span class="line">        <span class="comment">// ä¼˜åŒ–é€»è¾‘</span></span><br><span class="line">        <span class="keyword">if</span> (containConnection(message.getUser()))&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> message.getUser();</span><br><span class="line">            webSockets.get(key).sendMessage(message);</span><br><span class="line">            System.out.println(message + <span class="string">&quot; has been sent to &quot;</span> + key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-ç”Ÿäº§è€…ï¼ˆpubï¼‰"><a href="#2-5-ç”Ÿäº§è€…ï¼ˆpubï¼‰" class="headerlink" title="2.5. ç”Ÿäº§è€…ï¼ˆpubï¼‰"></a>2.5. ç”Ÿäº§è€…ï¼ˆpubï¼‰</h3><p>æŒ‡å®šè¦å‘å¸ƒåˆ°çš„channelå’Œè¦å‘å¸ƒçš„æ¶ˆæ¯ã€‚æ³¨æ„è¿™é‡Œçš„channelç”±é…ç½®ç±»è¿›è¡Œç®¡ç†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¶ˆæ¯å‘å¸ƒè€…æœåŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PublishService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ³¨å…¥è‡ªå®šä¹‰redisTemplate</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChannelTopic channelTopic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Publish.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message   the message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(Object message)</span> &#123;</span><br><span class="line">        redisUtil.convertAndSend(channelTopic.getTopic(), message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>redisUtil</code>å°è£…äº†è½¬å‘æ¶ˆæ¯æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‘é€šé“å‘å¸ƒæ¶ˆæ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">convertAndSend</span><span class="params">(String channel, Object message)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(channel)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        redisTemplate.convertAndSend(channel, message);</span><br><span class="line">        log.info(<span class="string">&quot;å‘é€æ¶ˆæ¯æˆåŠŸï¼Œchannelï¼š&#123;&#125;ï¼Œmessageï¼š&#123;&#125;&quot;</span>, channel, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œchannelï¼š&#123;&#125;ï¼Œmessageï¼š&#123;&#125;&quot;</span>, channel, message);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-æµ‹è¯•"><a href="#3-æµ‹è¯•" class="headerlink" title="3. æµ‹è¯•"></a>3. æµ‹è¯•</h2><h3 id="3-1-æµ‹è¯•ç±»"><a href="#3-1-æµ‹è¯•ç±»" class="headerlink" title="3.1. æµ‹è¯•ç±»"></a>3.1. æµ‹è¯•ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisSubPubTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChannelTopic topic;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC</span> <span class="operator">=</span> <span class="string">&quot;TEST_TOPIC1&quot;</span>; <span class="comment">// è®¢é˜…ä¸»é¢˜</span></span><br><span class="line">        <span class="comment">// å‘å¸ƒæ¶ˆæ¯</span></span><br><span class="line">        <span class="type">MessageVO</span> <span class="variable">messageVO</span> <span class="operator">=</span> MessageVO.builder()</span><br><span class="line">                .user(<span class="string">&quot;pengzna&quot;</span>)</span><br><span class="line">                .msg(<span class="string">&quot;hello worldï¼&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        redisUtil.convertAndSend(topic.getTopic(), messageVO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-æµ‹è¯•ç»“æœ"><a href="#3-2-æµ‹è¯•ç»“æœ" class="headerlink" title="3.2. æµ‹è¯•ç»“æœ"></a>3.2. æµ‹è¯•ç»“æœ</h3><p><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20220726182800342.png" alt="image-20220726182800342"></p>
<hr>
<p><em>å‚è€ƒèµ„æ–™</em></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.runoob.com/redis/redis-pub-sub.html">Redis å‘å¸ƒè®¢é˜… | èœé¸Ÿæ•™ç¨‹ (runoob.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kendoziyu/p/15802698.html">SpringBootæ•´åˆRediså®ç°å‘å¸ƒè®¢é˜…åŠŸèƒ½å®è·µ - æå®¢å­ç¾½ - åšå®¢å›­ (cnblogs.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/BBQ__ZXB/article/details/124980860">(26æ¡æ¶ˆæ¯) Spring bootæ•´åˆRediså®ç°å‘å¸ƒè®¢é˜…ï¼ˆè¶…è¯¦ç»†ï¼‰_BBQ__XBçš„åšå®¢-CSDNåšå®¢_springboot å‘å¸ƒè®¢é˜…</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Vector97/article/details/118407461?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1-118407461-blog-124980860.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1-118407461-blog-124980860.pc_relevant_default&utm_relevant_index=2">(26æ¡æ¶ˆæ¯) Springbooté›†æˆRediså®ç°å‘å¸ƒè®¢é˜…åŠŸèƒ½ï¼ˆJava Lettuceå®¢æˆ·ç«¯ï¼‰_iFenceçš„åšå®¢-CSDNåšå®¢_lettuce å‘å¸ƒè®¢é˜…</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44874132/article/details/124192307">(26æ¡æ¶ˆæ¯) SpringBootæ•´åˆrediså®ç°å‘å¸ƒè®¢é˜…æ¨¡å¼_å¶æ«^_^çš„åšå®¢-CSDNåšå®¢_rediså‘å¸ƒè®¢é˜… springboot</a></li>
<li>jfyåŒå­¦ä»£ç </li>
</ul>
  </div>
  
    
      <a id="older" class="blog-nav" href="/article/TypeScript%E5%85%A5%E9%97%A8/">OLDER&nbsp;&gt;</a>
      
        
          <a id="newer" class="blog-nav" href="/article/%E4%BA%91%E8%AE%A1%E7%AE%97%E7%AC%AC%E4%B8%80%E6%AC%A1%E4%BD%9C%E4%B8%9A-OBS%E5%B1%95%E7%A4%BA/">&lt;&nbsp;NEWER</a>
          
            
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/Pengzna">Copyright Â© Pengzna 2021-present</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          <!-- <span class="search-icon-input">
            <a href="javascript: void(0)">
              <i class="iconfont icon-search"></i>
            </a>
          </span> -->
          
            <input type="text" class="search-input" id="search-input" placeholder="æœç´¢">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)">
              <i class="iconfont icon-close"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    // inputArea.onclick = function() {
    //   getSearchFile()
    //   this.onclick = null
    // }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        inputArea.focus()
        getSearchFile()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'><span></ul>";
      // $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'><h2>" + orig_data_title + "</h2></a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<h3 class=\"search-result-abstract\">" + match_content + "...</h3>"
                }
                str += "<hr></li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer toï¼š<a href='https://github.com/leedom92/hexo-theme-leedom#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </body>
</html>

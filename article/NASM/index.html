<!DOCTYPE html>
<html lang="en">

  <head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="Pengzna,blog" />
  <meta name="author" content="Pengzna" />
  <meta name="description" content="Pengzna çš„åšå®¢" />
  
  
  <title>
    
      NASM æ¦‚å¿µä¸å®æˆ˜/è¸©å‘è®°å½• 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto:400,400italic,600|Roboto+Mono" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


<meta name="generator" content="Hexo 7.0.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>


  <body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="app">
      <div class="header">
  <a href="/">Pengzna's blog ğŸ‘‹</a>
</div>


      <p class="links">
  
    <a title="archives" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="github" target="_blank" href="https://github.com/Pengzna">
      <i class="iconfont icon-github"></i>
    </a>
  
    <a title="email" target="_blank" href="mailto:junzhi.pengzna@gmail.com">
      <i class="iconfont icon-envelope"></i>
    </a>
  
    <a title="linkedin" target="_blank" href="https://www.linkedin.com/in/pengzna/">
      <i class="iconfont icon-linkedin"></i>
    </a>
  
    <a title="wechat" target="_blank" href="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20231115013033249.png">
      <i class="iconfont icon-wechat"></i>
    </a>
  
</p>


      <div class="main">
        <!-- æ–‡ç« è¯¦æƒ…é¡µï¼Œå±•ç¤ºæ–‡ç« å…·ä½“å†…å®¹ï¼Œurlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
<!-- åŒæ—¶ä¸ºã€Œæ ‡ç­¾tagã€ï¼Œã€Œæœ‹å‹friendã€ï¼Œã€Œåˆ†ç±»categoriesã€ï¼Œã€Œå…³äºaboutã€é¡µé¢çš„æ‰¿è½½é¡µé¢ï¼Œå…·ä½“å±•ç¤ºå–å†³äºpage.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>

<div class="post">
  <h3 class="date">
    Nov 25, 2022
  </h3>
  <h1>
    NASM æ¦‚å¿µä¸å®æˆ˜/è¸©å‘è®°å½•
  </h1>
  <div class="content markdown-body">
    <ul>
<li>NJU OS lab-1</li>
</ul>
<img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20221006001450200.png" alt="image-20221006001450200" style="zoom:50%;" />

<h1 id="1-NASM-ä¸-GDB-è°ƒè¯•"><a href="#1-NASM-ä¸-GDB-è°ƒè¯•" class="headerlink" title="1. NASM ä¸ GDB è°ƒè¯•"></a>1. NASM ä¸ GDB è°ƒè¯•</h1><h2 id="1-1-å®‰è£…ä¸è¿è¡Œ"><a href="#1-1-å®‰è£…ä¸è¿è¡Œ" class="headerlink" title="1.1. å®‰è£…ä¸è¿è¡Œ"></a>1.1. å®‰è£…ä¸è¿è¡Œ</h2><p>åœ¨ Ubuntu ä¸‹å¯ä»¥é€šè¿‡ apt å®‰è£…</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">sudo apt install nasm</span><br></pre></td></tr></table></figure>

<p>å®‰è£…åå°±å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œæ±‡ç¼–äº†ï¼Œä»¥<code>big_decimal.asm</code>ä¸ºä¾‹</p>
<p>åœ¨ Ubuntu ä¸‹</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">nasm -f elf big_decimal.asm -o big_decimal.o</span><br><span class="line">ld -m elf_i386 big_decimal.o -o big_decimal</span><br></pre></td></tr></table></figure>

<p><code>ld</code>æ˜¯ GUN è‡ªå¸¦çš„é“¾æ¥å·¥å…·ï¼Œå¯ä»¥å°†ç›®æ ‡æ–‡ä»¶é“¾æ¥èµ·æ¥ï¼Œæˆ‘ä»¬è¿™é‡Œå› ä¸ºåªæœ‰ä¸€ä¸ªæ–‡ä»¶å› æ­¤ä¸éœ€è¦é¢å¤–çš„æŒ‡ä»¤ã€‚</p>
<p>å¤ä¹ ä¸€ä¸‹ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªå†™å¥½çš„ C ç¨‹åºè½¬åŒ–ä¸ºä¸€ä¸ªå¯ä»¥åœ¨ Unix å†…æ ¸æœºå™¨ä¸Šæ‰§è¡Œçš„æ–‡ä»¶ï¼Œéœ€è¦ç»å†ä¸‹é¢å››ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>é¢„å¤„ç†ï¼šå¤„ç† C ä¸­çš„é¢„å¤„ç†å‘½ä»¤ï¼Œä¹Ÿå°±æ˜¯#å¼€å¤´çš„é‚£äº›ï¼Œé»˜è®¤çš„ç”Ÿæˆæ–‡ä»¶æ ¼å¼ä¸º<code>.i</code></li>
<li>ç¼–è¯‘ï¼šå°† C ç¨‹åºç¼–è¯‘ä¸ºæ±‡ç¼–è¯­è¨€ï¼Œ é»˜è®¤çš„ç”Ÿæˆæ–‡ä»¶æ ¼å¼ä¸º<code>.s</code>ï¼Œè¿™é‡Œçš„<code>.s</code>å’Œæˆ‘ä»¬çš„<code>.asm</code>æ²¡ä»€ä¹ˆåŒºåˆ«</li>
<li>æ±‡ç¼–ï¼šå°†æ±‡ç¼–è¯­è¨€è½¬åŒ–ä¸ºæœºå™¨ç ï¼Œé»˜è®¤çš„ç”Ÿæˆæ–‡ä»¶æ ¼å¼ä¸º<code>.o</code></li>
<li>é“¾æ¥ï¼šé“¾æ¥åŠ¨æ€åº“å’Œé™æ€åº“</li>
</ul>
<p>å› ä¸ºæˆ‘ä»¬ç›´æ¥åœ¨å†™æ±‡ç¼–ç¨‹åºï¼Œå½“ç„¶å°±ä¸éœ€è¦ç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥äº†ã€‚</p>
<h2 id="1-2-GDB-è°ƒè¯•"><a href="#1-2-GDB-è°ƒè¯•" class="headerlink" title="1.2. GDB è°ƒè¯•"></a>1.2. GDB è°ƒè¯•</h2><p>è¯´åˆ° GUNï¼Œä¸å¾—ä¸æä»Šå¤©çš„å¦ä¸€ä¸ªä¸»è§’ï¼Œé‚£å°±æ˜¯ GDBï¼ŒGNU symbolic debuggerï¼Œå®ƒæ˜¯ä¸€ä¸ªåœ¨ Unix å†…æ ¸ä¸­å¹¿å—å¥½è¯„çš„è°ƒè¯•å·¥å…·ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ GDB æ¥è°ƒè¯•æˆ‘ä»¬çš„æ±‡ç¼–ä»£ç </p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">nasm -f elf big_decimal.asm -o big_decimal.o</span><br><span class="line">ld -m elf_i386 big_decimal.o -o big_decimal</span><br><span class="line">sudo gdb big_decimal</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥è¿›å…¥ gdb ç•Œé¢ï¼Œå¼€å§‹ä½ çš„è°ƒè¯•å·¥ä½œã€‚</p>
<p>å’Œå‰é¢è¯´åˆ°çš„ä¸€æ ·ï¼Œä½¿ç”¨<code>gdb</code> æ‰“å¼€ä½ çš„æ–‡ä»¶å°±å¥½äº†ï¼Œå› ä¸º<code>gdb</code>è¦æ§åˆ¶å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥åˆ«å¿˜äº†ç»™å®ƒå¼€æƒé™ã€‚</p>
<p>å¯ä»¥åœ¨æ±‡ç¼–æ–‡ä»¶ä¸­è®¾ç½®æ–­ç‚¹ï¼Œå¹¶åœ¨ä½ æƒ³åœæ­¢çš„åœ°æ–¹<code>call</code>å®ƒï¼Œæ¯”å¦‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">break_demo:</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure>

<p>ç„¶ååªè¦åœ¨<code>gdb</code>ä¸­</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">b break_demo</span><br></pre></td></tr></table></figure>

<p>å°±å¯ä»¥è®©å®ƒåœ¨æ‰§è¡Œåˆ°<code>b</code>çš„æ—¶å€™ä¸­æ­¢ç¨‹åºã€‚</p>
<p>å¯ä»¥ä½¿ç”¨æŒ‡ä»¤</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">i registers</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹ä»£ç è¿è¡Œçš„ä½ç½®å’Œå¯„å­˜å™¨çŠ¶æ€ã€‚</p>
<p>å¦‚æœä½ çš„ä»£ç æœ‰<code>stdout</code>çš„è¾“å‡ºï¼Œå¯èƒ½ä¼šç ´åè¿™ä¸ª layout çš„æ ¼å±€ï¼Œè¿™æ—¶å€™ä½¿ç”¨<code>refresh</code>æŒ‡ä»¤åˆ·æ–°å®ƒã€‚</p>
<p>æœ€åï¼Œå¯ä»¥ä½¿ç”¨<code>x</code>æŒ‡ä»¤æŸ¥çœ‹ä½ çš„å†…å­˜çŠ¶å†µï¼Œæ¯”å¦‚æŸ¥çœ‹<code>0x40201c</code>å¼€å§‹çš„ 20 ä¸ª bits çš„å†…å­˜</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">x/20b 0x40201c</span><br></pre></td></tr></table></figure>

<h1 id="2-NASM-è¯¦è§£"><a href="#2-NASM-è¯¦è§£" class="headerlink" title="2. NASM è¯¦è§£"></a>2. NASM è¯¦è§£</h1><h2 id="2-1-NASM-ç¨‹åºçš„ç»“æ„"><a href="#2-1-NASM-ç¨‹åºçš„ç»“æ„" class="headerlink" title="2.1. NASM ç¨‹åºçš„ç»“æ„"></a>2.1. NASM ç¨‹åºçš„ç»“æ„</h2><p>NASM æ˜¯åŸºäºè¡Œçš„ã€‚å¤§å¤šæ•°ç¨‹åºç”±æŒ‡ä»¤åè·Ÿä¸€ä¸ªæˆ–å¤šä¸ªéƒ¨åˆ†ç»„æˆã€‚è¡Œå¯ä»¥å…·æœ‰å¯é€‰æ ‡ç­¾ã€‚å¤§å¤šæ•°è¡Œéƒ½æœ‰ä¸€æ¡æŒ‡ä»¤,åè·Ÿé›¶ä¸ªæˆ–å¤šä¸ªæ“ä½œæ•°ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/zhangjunlei26/NASM-Tutorial-CN/master/assets/nasmstructure.png"><img src="https://peng-img.oss-cn-shanghai.aliyuncs.com/markdown-img/image-20221004164300281.png" alt="image-20221004164300281"></a></p>
<p>é€šå¸¸,æ‚¨å°†ä»£ç æ”¾åœ¨çš„éƒ¨åˆ†ä¸­,<code>.text</code>å¹¶å°†å¸¸é‡æ•°æ®æ”¾åœ¨çš„éƒ¨åˆ†ä¸­<code>.data</code>ã€‚</p>
<h2 id="2-2-NASM-è¯­æ³•"><a href="#2-2-NASM-è¯­æ³•" class="headerlink" title="2.2. NASM è¯­æ³•"></a>2.2. NASM è¯­æ³•</h2><h3 id="2-2-1-åŸºç¡€æŒ‡ä»¤"><a href="#2-2-1-åŸºç¡€æŒ‡ä»¤" class="headerlink" title="2.2.1. åŸºç¡€æŒ‡ä»¤"></a>2.2.1. åŸºç¡€æŒ‡ä»¤</h3><p>æœ‰æ•°ç™¾æ¡æŒ‡ä»¤ã€‚æ‚¨æ— æ³•ä¸€æ¬¡å…¨éƒ¨å­¦ä¹ å®ƒä»¬ã€‚ä»è¿™äº› start:</p>
<table>
<thead>
<tr>
<th><code>mov</code> <em>x</em>,<em>y</em></th>
<th><em>x</em> â† <em>y</em></th>
</tr>
</thead>
<tbody><tr>
<td><code>and</code> <em>x</em>,<em>y</em></td>
<td><em>x</em> â† <em>x</em> and <em>y</em></td>
</tr>
<tr>
<td><code>or</code> <em>x</em>,<em>y</em></td>
<td><em>x</em> â† <em>x</em> or <em>y</em></td>
</tr>
<tr>
<td><code>xor</code> <em>x</em>,<em>y</em></td>
<td><em>x</em> â† <em>x</em> xor <em>y</em></td>
</tr>
<tr>
<td><code>add</code> <em>x</em>,<em>y</em></td>
<td><em>x</em> â† <em>x</em> + <em>y</em></td>
</tr>
<tr>
<td><code>sub</code> <em>x</em>,<em>y</em></td>
<td><em>x</em> â† <em>x</em> â€“ <em>y</em></td>
</tr>
<tr>
<td><code>inc</code> <em>x</em></td>
<td><em>x</em> â† <em>x</em> + 1</td>
</tr>
<tr>
<td><code>dec</code> <em>x</em></td>
<td><em>x</em> â† <em>x</em> â€“ 1</td>
</tr>
<tr>
<td><code>syscall</code></td>
<td>è°ƒç”¨æ“ä½œç³»ç»Ÿä¾‹ç¨‹</td>
</tr>
<tr>
<td><code>db</code></td>
<td>ä¸€ä¸ª<a target="_blank" rel="noopener" href="http://www.nasm.us/xdoc/2.11.02/html/nasmdoc3.html#section-3.2">ä¼ªæŒ‡ä»¤</a> å£°æ˜å­—èŠ‚, è¿™å°†æ˜¯åœ¨å†…å­˜ä¸­çš„ç¨‹åºè¿è¡Œæ—¶</td>
</tr>
</tbody></table>
<ul>
<li><code>cmp</code> åšæ¯”è¾ƒ</li>
<li><code>je</code>å¦‚æœå…ˆå‰çš„æ¯”è¾ƒç›¸ç­‰åˆ™è·³è½¬ã€‚</li>
<li><code>jne</code>(å¦‚æœä¸ç­‰äºåˆ™è·³è½¬)</li>
<li><code>jl</code>(å¦‚æœä¸ç­‰äºåˆ™è·³è½¬)</li>
<li><code>jnl</code>(å¦‚æœä¸å°äºåˆ™è·³è½¬)</li>
<li><code>jg</code>(å¦‚æœå¤§äºåˆ™è·³è½¬)</li>
<li><code>jng</code>(å¦‚æœä¸å¤§äºåˆ™è·³è½¬)</li>
<li><code>jle</code>(å¦‚æœå°äºæˆ–ç­‰äºåˆ™è·³è½¬)</li>
<li><code>jnle</code>(å¦‚æœä¸å°äºæˆ–ç­‰äºåˆ™è·³è½¬)</li>
<li><code>jge</code>(å¦‚æœå¤§äºæˆ–ç­‰äºåˆ™è·³è½¬)</li>
<li><code>jnge</code>(å¦‚æœä¸å¤§äºæˆ–ç­‰äºåˆ™è·³è½¬)</li>
<li><code>equ</code>å®é™…ä¸Šä¸æ˜¯çœŸæ­£çš„æŒ‡ä»¤ã€‚å®ƒåªæ˜¯å®šä¹‰äº†ä¾›æ±‡ç¼–ç¨‹åºæœ¬èº«ä½¿ç”¨çš„ç¼©å†™ã€‚(è¿™æ˜¯ä¸€ä¸ªæ„ä¹‰æ·±è¿œçš„æƒ³æ³•)</li>
<li>æœ¬<code>.bss</code>èŠ‚é€‚ç”¨äº<em>å¯å†™</em>æ•°æ®ã€‚</li>
</ul>
<h3 id="2-2-2-ä¼ªæŒ‡ä»¤"><a href="#2-2-2-ä¼ªæŒ‡ä»¤" class="headerlink" title="2.2.2. ä¼ªæŒ‡ä»¤"></a>2.2.2. ä¼ªæŒ‡ä»¤</h3><p>ä¼ªæŒ‡ä»¤ä¸æ˜¯ x86&#x2F;x64 æœºå™¨çš„çœŸå®æŒ‡ä»¤ï¼Œä¼ªæŒ‡ä»¤æ˜¯ç”¨äºç»™ç¼–è¯‘å™¨æŒ‡ç¤ºå¦‚ä½•è¿›è¡Œç¼–è¯‘ã€‚</p>
<h4 id="2-2-2-1-nasm-å®šä¹‰çš„-7-ç§æ•°æ®-size"><a href="#2-2-2-1-nasm-å®šä¹‰çš„-7-ç§æ•°æ®-size" class="headerlink" title="2.2.2.1. nasm å®šä¹‰çš„ 7 ç§æ•°æ® size"></a>2.2.2.1. nasm å®šä¹‰çš„ 7 ç§æ•°æ® size</h4><ul>
<li>byte ï¼š 8 ä½</li>
<li>word ï¼š 16 ä½</li>
<li>dword ï¼š 32 ä½</li>
<li>qword ï¼š 64 ä½</li>
<li>tword ï¼š 80 ä½</li>
<li>oword ï¼š 128 ä½</li>
<li>yword ï¼š 256 ä½</li>
</ul>
<p>oword å¯ä»¥å¯¹åº” Microsoft MASM çš„ xmmword ç±»å‹ï¼Œyword å¯¹åº” Microsoft MASM çš„ ymmword ç±»å‹ã€‚</p>
<p>tword, oword ä»¥åŠ yword ä½¿ç”¨åœ¨ éæ•´å‹ æ•°æ®ï¼Œä½¿ç”¨åœ¨ float å’Œ SSE å‹æ•°æ®ã€‚</p>
<h4 id="2-2-2-2-å®šä¹‰åˆå§‹åŒ–æ•°æ®ï¼šdb-å®¶æ—"><a href="#2-2-2-2-å®šä¹‰åˆå§‹åŒ–æ•°æ®ï¼šdb-å®¶æ—" class="headerlink" title="2.2.2.2. å®šä¹‰åˆå§‹åŒ–æ•°æ®ï¼šdb å®¶æ—"></a>2.2.2.2. å®šä¹‰åˆå§‹åŒ–æ•°æ®ï¼šdb å®¶æ—</h4><p>nasm å®šä¹‰äº†ç”¨äºåˆå§‹åŒ–ä¸Šé¢ 7 ç§ size çš„ db å®¶æ—ï¼Œå®ƒä»¬ç”¨äºå®šä¹‰åˆåŒ–å¸¸é‡å€¼ã€‚</p>
<ul>
<li>db : define byte</li>
<li>dw ï¼šdefine word</li>
<li>dd ï¼šdefine doubleword</li>
<li>dq ï¼šdefine quadword</li>
<li>dt ï¼šdefine tword</li>
<li>do ï¼šdefine oword</li>
<li>dy ï¼šdefine yword</li>
</ul>
<p>æ­£å¦‚å‰é¢æ‰€è¯´çš„ï¼šdt , do , dy ä¸æ¥å—æ•´å‹æ•°å€¼å¸¸é‡ï¼Œå®ƒä»¬è¢«ä½¿ç”¨åœ¨å®šä¹‰ float æˆ– SSE æ•°æ®å¸¸é‡ã€‚dt å¯ä»¥å®šä¹‰ extended-precision float æ•°æ®ï¼Œdo å¯ä»¥å®šä¹‰ quad-precision floatï¼Œdy å¯å®šä¹‰ ymm æ•°æ®ã€‚è€Œ dq å¯ä»¥å®šä¹‰ double-precision float æ•°æ®ï¼Œdd å¯ä»¥å®šä¹‰ single-precision float æ•°æ®ã€‚</p>
<h4 id="2-2-2-3-å®šä¹‰éåˆå§‹åŒ–æ•°æ®ï¼šresb-å®¶æ—"><a href="#2-2-2-3-å®šä¹‰éåˆå§‹åŒ–æ•°æ®ï¼šresb-å®¶æ—" class="headerlink" title="2.2.2.3. å®šä¹‰éåˆå§‹åŒ–æ•°æ®ï¼šresb å®¶æ—"></a>2.2.2.3. å®šä¹‰éåˆå§‹åŒ–æ•°æ®ï¼šresb å®¶æ—</h4><p>ç¨‹åºä¸­ä½¿ç”¨åˆ°çš„éåˆå§‹åŒ–æ•°æ®é€šå¸¸æ”¾åœ¨ <code>bss section</code> é‡Œï¼Œ<code>bss</code> ä»£è¡¨ <strong>uninitialized storage space</strong>(å¦‚æœæ‚¨è¯•å›¾åœ¨ä¸€ä¸ª<code>.text</code>å°èŠ‚ä¸­ä½¿ç”¨å®ƒä»¬,å°†ä¼šå‡ºç°é”™è¯¯)ï¼š</p>
<p>nasm ä½¿ç”¨äº† resb ï¼ˆreserve byteï¼‰ å®¶æ—æ¥å®šä¹‰éåˆå§‹åŒ–æ•°æ®ã€‚</p>
<ul>
<li>resb ï¼šreserve byte</li>
<li>resw ï¼šreserve word</li>
<li>resd ï¼šreserve doubword</li>
<li>resq ï¼šreserve quadword</li>
<li>rest ï¼šreserve tword</li>
<li>reso ï¼šreserve oword</li>
<li>resy ï¼šreserve yword</li>
</ul>
<p>resb ç›¸å½“äº Microsoft MASM è¯­æ³•ä¸­çš„ db ?</p>
<p>ä¸‹é¢æ˜¯ NASM Manual çš„ä¾‹å­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">buffer:         resb    64              ; reserve 64 bytes</span><br><span class="line">wordvar:        resw    1               ; reserve a word</span><br><span class="line">realarray       resq    10              ; array of ten reals</span><br><span class="line">ymmval:         resy    1               ; one YMM register</span><br></pre></td></tr></table></figure>

<h3 id="2-3-5-ä½¿ç”¨-equ-å®šä¹‰å¸¸é‡"><a href="#2-3-5-ä½¿ç”¨-equ-å®šä¹‰å¸¸é‡" class="headerlink" title="2.3.5 ä½¿ç”¨ equ å®šä¹‰å¸¸é‡"></a>2.3.5 ä½¿ç”¨ equ å®šä¹‰å¸¸é‡</h3><p>equ ç”¨æ¥ä¸ºæ ‡è¯†ç¬¦å®šä¹‰ä¸€ä¸ª æ•´å‹ å¸¸é‡ï¼Œå®ƒçš„ä½œç”¨ç±»ä¼¼ C è¯­è¨€ä¸­çš„ #define</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a  equ 0                          ; OK</span><br><span class="line">b  equ &#x27;abcd&#x27;                     ; OK! b = 0x64636261</span><br><span class="line">c  equ &#x27;abcdefghi&#x27;                ; warning! c = 0x6867666564636261</span><br><span class="line">d  equ 1.2                        ; error!</span><br><span class="line"></span><br><span class="line">    section .data</span><br><span class="line">string db &#x27;hello,word&#x27;,0</span><br><span class="line">len    equ $-string               ; OK! len = 0x0b</span><br><span class="line"></span><br><span class="line">    section .text</span><br><span class="line">textlen equ  _end - entry         ; OK! textlen = 0x05</span><br><span class="line"></span><br><span class="line">_entry:</span><br><span class="line">    mov ecx, textlen</span><br><span class="line"></span><br><span class="line">_end:</span><br></pre></td></tr></table></figure>

<p>ä¾‹å­ä¸­ï¼š b å®šä¹‰ä¸ºå¸¸é‡ â€˜abcdâ€™ å®ƒå°†æ˜¯å­—ç¬¦ä¸²çš„ ASCII ç åºåˆ—ï¼Œâ€˜abcdefghiâ€™ å¸¸é‡å°†ä¼šè¢«æˆªæ–­ï¼Œæ•´å‹å¸¸é‡æœ€é•¿ä¸º quadwordï¼ˆ8 bytes)ï¼Œè€Œ d ä¼å›¾è¢«å®šä¹‰ä¸ºä¸€ä¸ª float å¸¸é‡ï¼Œè¿™äº§ç”Ÿä¼šé”™è¯¯ã€‚len å’Œ textlen è¢«å®šä¹‰ä¸ºç¼–è¯‘æœŸç¡®å®šçš„æ•°å€¼ã€‚</p>
<h2 id="2-3-å¯„å­˜å™¨"><a href="#2-3-å¯„å­˜å™¨" class="headerlink" title="2.3. å¯„å­˜å™¨"></a>2.3. å¯„å­˜å™¨</h2><p>æ‚¨å¯ä»¥å°†æ¯ä¸ªå¯„å­˜å™¨çš„æœ€ä½ 32 ä½è§†ä¸ºå¯„å­˜å™¨æœ¬èº«,ä½†å¯ä»¥ä½¿ç”¨ä»¥ä¸‹åç§°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">R0D R1D R2D R3D R4D R5D R6D R7D R8D R9D R10D R11D R12D R13D R14D R15D</span><br><span class="line">EAX ECX EDX EBX ESP EBP ESI EDI</span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹åç§°å°†æ¯ä¸ªå¯„å­˜å™¨çš„æœ€ä½ 16 ä½çœ‹ä½œä¸€ä¸ªå¯„å­˜å™¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">R0W R1W R2W R3W R4W R5W R6W R7W R8W R9W R10W R11W R12W R13W R14W R15W</span><br><span class="line">AX CX DX BX SP BP SI DI</span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹åç§°å°†æ¯ä¸ªå¯„å­˜å™¨çš„æœ€ä½ 8 ä½çœ‹ä½œä¸€ä¸ªå¯„å­˜å™¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">R0B R1B R2B R3B R4B R5B R6B R7B R8B R9B R10B R11B R12B R13B R14B R15B</span><br><span class="line">AL CL DL BL SPL BPL SIL DIL</span><br></pre></td></tr></table></figure>

<p>ç”±äºå†å²åŸå› ï¼Œ<code>R0...R3</code>çš„ç¬¬ 15 è‡³ 8 ä½è¢«å‘½åä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AH CH DH BH</span><br></pre></td></tr></table></figure>

<h2 id="2-4-æ“ä½œæ•°"><a href="#2-4-æ“ä½œæ•°" class="headerlink" title="2.4. æ“ä½œæ•°"></a>2.4. æ“ä½œæ•°</h2><h3 id="2-4-1-å†…å­˜æ“ä½œæ•°"><a href="#2-4-1-å†…å­˜æ“ä½œæ•°" class="headerlink" title="2.4.1. å†…å­˜æ“ä½œæ•°"></a>2.4.1. å†…å­˜æ“ä½œæ•°</h3><ul>
<li>å…¶å®å°±æ˜¯å‡ ç§å¯»å€çš„æ–¹å¼<ul>
<li>ç›´æ¥å¯»å€</li>
<li>å¯„å­˜å™¨é—´æ¥å¯»å€</li>
<li>å¯„å­˜å™¨ç›¸å¯¹å¯»å€</li>
<li>åŸºå€åŠ å˜å€</li>
<li>ç›¸å¯¹åŸºå€åŠ å˜å€</li>
</ul>
</li>
<li>æ³¨æ„ï¼šæ²¡æœ‰ç«‹å³å¯»å€å’Œå¯„å­˜å™¨å¯»å€</li>
</ul>
<p>è¿™äº›æ˜¯å¯»å€çš„åŸºæœ¬å½¢å¼ï¼š</p>
<ul>
<li><code>[ number ]</code></li>
<li><code>[ reg ]</code></li>
<li><code>[ reg + reg*scale ]</code> <em>å°æ•°ä½æ•°åªèƒ½æ˜¯ 1ã€2ã€4 æˆ– 8</em></li>
<li><code>[ reg + number ]</code></li>
<li><code>[ reg + reg*scale + number ]</code></li>
</ul>
<p>è¿™ä¸ªæ•°å­—å«åš<strong>ä½ç§»</strong> ; æ™®é€šå¯„å­˜å™¨ç§°ä¸º<strong>åŸº</strong> ; å¸¦æœ‰åˆ»åº¦çš„å¯„å­˜å™¨ç§°ä¸º<strong>ç´¢å¼•</strong>ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[750]               ; ä»…ä½ç§»</span><br><span class="line">[rbp]               ; ä»…åŸºå€å¯„å­˜å™¨</span><br><span class="line">[rcx + rsi*4]       ; åŸºæ•°+æŒ‡æ•°*æ¯”ä¾‹</span><br><span class="line">[rbp + rdx]         ; scale is 1</span><br><span class="line">[rbx-8]             ; ä½ç§»-8</span><br><span class="line">[rax + rdi*8 + 500] ; æ‰€æœ‰å››ä¸ªç»„æˆéƒ¨åˆ†</span><br><span class="line">[rbx + counter]     ; ä½¿ç”¨å˜é‡&quot;counter&quot;åœ°å€ä½œä¸ºåç§»</span><br></pre></td></tr></table></figure>

<h3 id="2-4-2-ç›´æ¥æ“ä½œæ•°"><a href="#2-4-2-ç›´æ¥æ“ä½œæ•°" class="headerlink" title="2.4.2. ç›´æ¥æ“ä½œæ•°"></a>2.4.2. ç›´æ¥æ“ä½œæ•°</h3><p>è¿™äº›å¯ä»¥ç”¨å¤šç§æ–¹å¼ç¼–å†™ã€‚ä»¥ä¸‹æ˜¯å®˜æ–¹æ–‡æ¡£ä¸­çš„ä¸€äº›ç¤ºä¾‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">200         ; åè¿›åˆ¶æ•°</span><br><span class="line">0200        ; ä»ç„¶æ˜¯åè¿›åˆ¶-å‰å¯¼0ä¸ä¼šä½¿å…¶å˜ä¸ºå…«è¿›åˆ¶</span><br><span class="line">0200d       ; æ˜¾å¼åè¿›åˆ¶-dåç¼€</span><br><span class="line">0d200       ; ä¹Ÿåè¿›åˆ¶-0d prefex</span><br><span class="line">0c8h        ; åå…­è¿›åˆ¶-håç¼€,ä½†æ˜¯å‰å¯¼0æ˜¯å¿…éœ€çš„,å› ä¸ºc8hçœ‹èµ·æ¥åƒvar</span><br><span class="line">0xc8        ; hex-ç»å…¸çš„0xå‰ç¼€</span><br><span class="line">0hc8        ; åå…­è¿›åˆ¶-ç”±äºæŸäº›åŸå› ,NASMåçˆ±0hå†™æ³•</span><br><span class="line">310q        ; å…«è¿›åˆ¶-qåç¼€</span><br><span class="line">0q310       ; å…«è¿›åˆ¶-0qå‰ç¼€</span><br><span class="line">11001000b   ; äºŒè¿›åˆ¶-båç¼€</span><br><span class="line">0b1100_1000 ; äºŒè¿›åˆ¶-0bå‰ç¼€,é¡ºä¾¿è¯´ä¸€ä¸‹,å…è®¸ä½¿ç”¨ä¸‹åˆ’çº¿</span><br></pre></td></tr></table></figure>

<h2 id="2-5-ä½¿ç”¨-C-åº“"><a href="#2-5-ä½¿ç”¨-C-åº“" class="headerlink" title="2.5. ä½¿ç”¨ C åº“"></a>2.5. ä½¿ç”¨ C åº“</h2><p>ä»…ä½¿ç”¨ syscall ç¼–å†™ç‹¬ç«‹ç¨‹åºå°±å·²ç»å¾ˆé…·äº†ï¼Œä½†å¾ˆå°‘è§ã€‚æˆ‘ä»¬æƒ³ä½¿ç”¨ C åº“ä¸­çš„å¥½ä¸œè¥¿ã€‚</p>
<p>ä¸ºä½•åœ¨ C è¯­è¨€ç¨‹åºä¸­ï¼Œçœ‹ä¸Šå»éƒ½æ˜¯ä» <code>main</code>å‡½æ•°å¼€å§‹æ‰§è¡Œï¼Ÿè¿™æ˜¯å› ä¸º C library çš„å†…éƒ¨æœ‰<code>_start</code>æ ‡ç­¾ï¼<code>_start</code>å¼€å§‹å¤„çš„ä»£ç ä¼šåšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œï¼Œç„¶åè°ƒç”¨<code>main</code>å‡½æ•°ä¸­çš„ä»£ç ï¼Œæœ€åæ‰§è¡Œæ¸…ç†å·¥ä½œï¼Œæœ€ç»ˆæ‰§è¡Œ 60 å·ç³»ç»Ÿè°ƒç”¨ä»¥é€€å‡ºã€‚å› æ­¤ï¼Œæ‚¨åªéœ€è¦å®ç°<code>main</code>å‡½æ•°å³å¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ±‡ç¼–è¯­è¨€ä¸­å®ç°è¿™ä¹ˆåšï¼š</p>
<p>å¦‚æœæ‚¨æœ‰ Linux,è¯·å°è¯•ä»¥ä¸‹æ“ä½œï¼š</p>
<p>hola.asm</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; ----------------------------------------------------------------------------------------</span><br><span class="line">; ä½¿ç”¨Cåº“å°†&quot; Hola,mundo&quot;å†™å…¥æ§åˆ¶å°ã€‚ç¨‹åºè¿è¡Œåœ¨ Linux æˆ–è€…å…¶ä»–åœ¨ C è¯­è¨€åº“ä¸­ä¸ä½¿ç”¨ä¸‹åˆ’çº¿çš„æ“ä½œç³»ç»Ÿä¸Šã€‚</span><br><span class="line">; å¦‚ä½•ç¼–è¯‘æ‰§è¡Œ:</span><br><span class="line">; nasm -felf64 hola.asm &amp;&amp; gcc hola.o &amp;&amp; ./a.out</span><br><span class="line">; ----------------------------------------------------------------------------------------</span><br><span class="line">global    main</span><br><span class="line">          extern    puts</span><br><span class="line"></span><br><span class="line">          section   .text</span><br><span class="line">main:                                       ; è¿™é‡Œè¢« C libraryåˆå§‹åŒ–ä»£ç æ‰€è°ƒç”¨</span><br><span class="line">          mov       rdi, message            ; rdiä¸­çš„ç¬¬ä¸€ä¸ªæ•´æ•°(æˆ–æŒ‡é’ˆ)å‚æ•°</span><br><span class="line">          call      puts                    ; puts(message)</span><br><span class="line">          ret                               ; ç”± main å‡½æ•°è¿”å› C è¯­è¨€åº“ä¾‹ç¨‹</span><br><span class="line">message:</span><br><span class="line">          db        &quot;Hola, mundo&quot;, 0        ; æ³¨æ„å­—ç¬¦ä¸²å¿…é¡»åœ¨Cä¸­ä»¥0ç»“å°¾</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ nasm -felf64 hola.asm &amp;&amp; gcc hola.o &amp;&amp; ./a.out</span><br><span class="line">Hola, mundo</span><br></pre></td></tr></table></figure>

<h2 id="2-6-å­—ç¬¦å¸¸é‡"><a href="#2-6-å­—ç¬¦å¸¸é‡" class="headerlink" title="2.6. å­—ç¬¦å¸¸é‡"></a>2.6. å­—ç¬¦å¸¸é‡</h2><p>åœ¨ nasm ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ 3 ç§å¼•å·æ¥æä¾›å­—ç¬¦</p>
<ul>
<li>â€™ â€¦â€™ ï¼ˆå•å¼•å·ï¼‰</li>
<li>â€ â€¦â€ ï¼ˆåŒå¼•å·ï¼‰</li>
<li><code> â€¦</code> ï¼ˆåå¼•å·ï¼‰</li>
</ul>
<p>å¦‚ä¸‹ç¤ºä¾‹ï¼Œå®ƒä»¬çš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db  &#x27;abcd&#x27;</span><br><span class="line">db  &quot;abcd&quot;</span><br><span class="line">db  `abcd`</span><br></pre></td></tr></table></figure>

<h1 id="3-å®è·µ-OS-lab1"><a href="#3-å®è·µ-OS-lab1" class="headerlink" title="3. å®è·µ - OS lab1"></a>3. å®è·µ - OS lab1</h1><ul>
<li>ä½¿ç”¨ nasm å®ç°å¤§æ•°åŠ æ³•å’Œä¹˜æ³•</li>
</ul>
<h2 id="3-1-æ€è·¯"><a href="#3-1-æ€è·¯" class="headerlink" title="3.1. æ€è·¯"></a>3.1. æ€è·¯</h2><ul>
<li><p>è¾“å…¥è¾“å‡º</p>
<ul>
<li>éœ€è¦ç†Ÿæ‚‰ Linux ç³»ç»Ÿè°ƒç”¨ï¼ˆics æ•™è¿‡ï¼‰</li>
<li>éœ€è¦ç†Ÿæ‚‰å¯„å­˜å™¨çš„ä½¿ç”¨</li>
<li>æ‰“å° int æ•°ç»„éœ€è¦ itoa</li>
</ul>
</li>
<li><p>åŠ æ³•</p>
<ul>
<li>æŒ‰ä½åŠ ï¼Œç»†èŠ‚ç•¥</li>
</ul>
</li>
<li><p>å‡æ³•</p>
<ul>
<li>æ‰¾å‡ºç»å¯¹å€¼è¾ƒå¤§è€…ï¼Œè®¡ç®—<code>dest - src // (abs(dest) &gt; abs(src))</code></li>
<li>æŒ‰ä½å‡ï¼Œæ¯æ¬¡å‡è¦è€ƒè™‘å€Ÿä½ï¼Œå…¶ä»–ç»†èŠ‚ç•¥</li>
</ul>
</li>
<li><p>ä¹˜æ³•</p>
<ul>
<li><p>$$<br>åŸºæœ¬åŸç†ï¼š<br>\Sigma_{i+j&#x3D;k}(a_i \times b_j) &#x3D; c_k<br>$$</p>
</li>
<li><p>å…ˆæŒ‰ä½ä¹˜ï¼Œæœ€åå†ç»Ÿä¸€ normalize</p>
</li>
</ul>
</li>
<li><p>æŠ€å·§</p>
<ul>
<li>string è½¬ int æ•°ç»„åå€’åºå­˜å‚¨ï¼Œæ–¹ä¾¿ int æ•°ç»„æ­£åºéå†</li>
<li>æ¯”å¦‚<code>&quot;123&quot;</code>ï¼Œå­˜å‚¨ä¸º<code>[3, 2, 1]</code></li>
</ul>
</li>
</ul>
<h2 id="3-2-è¸©å‘"><a href="#3-2-è¸©å‘" class="headerlink" title="3.2. è¸©å‘"></a>3.2. è¸©å‘</h2><ul>
<li>jmp çš„å‡½æ•°æ— é¡» retï¼ï¼ï¼<ul>
<li>å¦åˆ™å³ä½¿ push çš„å·²å…¨éƒ¨ popï¼Œret ä»ä¼š segmentation fault</li>
</ul>
</li>
<li>è°ƒç”¨æ ˆçš„ä½¿ç”¨</li>
<li>ebp ç”¨ leave å¼¹å‡º</li>
<li>intel è¯­æ³•ï¼ˆnasmï¼‰çš„ mov ä¸æ¥å—ä¸¤ä¸ª opcode</li>
<li>.bss å’Œ.data å®šä¹‰å‡ºçš„æ˜¯æŒ‡é’ˆ</li>
<li>åŒºåˆ†å­—ç¬¦ï¼ˆâ€™1â€™ï¼‰å’Œæ•°å­—ï¼ˆ0x1ï¼‰</li>
<li>loop å¾ªç¯ä¸å¯è½»æ˜“ jmp åˆ°å‹æ ˆä»£ç æ®µï¼ˆé™¤éæ˜¯è®¾è®¡å¥½çš„ï¼‰</li>
<li>gdb å’Œ objdump ç»“åˆçš„ä½¿ç”¨</li>
<li>æ¯æ¬¡å¾ªç¯åè¦æ¸…ç©ºbsså’Œå¯„å­˜å™¨</li>
</ul>
<h1 id="4-å‚è€ƒèµ„æ–™"><a href="#4-å‚è€ƒèµ„æ–™" class="headerlink" title="4. å‚è€ƒèµ„æ–™"></a>4. å‚è€ƒèµ„æ–™</h1><p><a target="_blank" rel="noopener" href="https://github.com/zhangjunlei26/NASM-Tutorial-CN">zhangjunlei26&#x2F;NASM-Tutorial-CN: Nasm æŒ‡å—ä¸­æ–‡ (NASM Tutorial) (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/263102219">NASM ä¸ GDB çš„ä½¿ç”¨æŒ‡å—ï¼šå¦‚ä½•ç¼–å¥½ä½ çš„æ±‡ç¼– - çŸ¥ä¹ (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/jadeshu/article/details/89159196">(29 æ¡æ¶ˆæ¯) nasm æ±‡ç¼–è®²è§£_jadeshu çš„åšå®¢-CSDN åšå®¢_nasm</a></p>
<p>[å­¦ä¹  nasm è¯­è¨€-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº (aliyun.com)](<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/25221#:~:text=%E4%BB%A3%E7%A0%81%E4%B8%AD%E4%BD%BF%E7%94%A8">https://developer.aliyun.com/article/25221#:~:text=ä»£ç ä¸­ä½¿ç”¨</a> byte å…³é”®å­—å¯¹ memory æ“ä½œæ•°è¿›è¡Œäº†ä¿®é¥°ï¼ŒæŒ‡æ˜ memory æ“ä½œæ•°çš„å¤§å°ä¸º byte,è¯­æ³•ï¼‰æœ‰äº›ä¸åŒï¼Œ masm çš„è¯­æ³•æ˜¯ï¼š åœ¨ masm è¯­æ³•ä¸­éœ€é…åˆ ptr æŒ‡ç¤ºå­—ã€‚)</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/297925056">GDB ä½¿ç”¨è¯¦è§£ - çŸ¥ä¹ (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014470361/article/details/102230583">(29 æ¡æ¶ˆæ¯) GDB è°ƒè¯•æŸ¥çœ‹å†…å­˜æ•°æ®_å¤œé£~çš„åšå®¢-CSDN åšå®¢_gdb æŸ¥çœ‹å†…å­˜æ•°æ®</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44395686/article/details/104727314">(29 æ¡æ¶ˆæ¯) ä½¿ç”¨ GDB æŸ¥çœ‹å’Œä¿®æ”¹å¯„å­˜å™¨çš„å€¼_@HDS çš„åšå®¢-CSDN åšå®¢_gdb æŸ¥çœ‹å¯„å­˜å™¨çš„å€¼</a></p>
<p><a target="_blank" rel="noopener" href="http://www.bytekits.com/nasm/system-callback.html">Nasm ç³»ç»Ÿè°ƒç”¨ - å­—èŠ‚æµ (bytekits.com)</a></p>

  </div>
  
    
      <a id="older" class="blog-nav" href="/article/Win10-RD-client/">OLDER&nbsp;&gt;</a>
      
        
          <a id="newer" class="blog-nav" href="/article/JVM-GC/">&lt;&nbsp;NEWER</a>
          
            
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/Pengzna">Copyright Â© Pengzna 2021-present</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          <!-- <span class="search-icon-input">
            <a href="javascript: void(0)">
              <i class="iconfont icon-search"></i>
            </a>
          </span> -->
          
            <input type="text" class="search-input" id="search-input" placeholder="æœç´¢">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)">
              <i class="iconfont icon-close"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    // inputArea.onclick = function() {
    //   getSearchFile()
    //   this.onclick = null
    // }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        inputArea.focus()
        getSearchFile()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'><span></ul>";
      // $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'><h2>" + orig_data_title + "</h2></a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<h3 class=\"search-result-abstract\">" + match_content + "...</h3>"
                }
                str += "<hr></li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer toï¼š<a href='https://github.com/leedom92/hexo-theme-leedom#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </body>
</html>
